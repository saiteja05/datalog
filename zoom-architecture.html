<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB | Zoom Architecture</title>
    <link rel="icon" href="https://www.mongodb.com/assets/images/global/favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --mongo-green: #00ED64;
            --mongo-dark-green: #00a854;
            --mongo-forest: #001E2B;
            --mongo-slate: #1C2D38;
            --zoom-blue: #2D8CFF;
            --primary-color: #FFD166;
            --secondary-color: #00b4d8;
            --priority-zero: #9d4edd;
            --danger-color: #ef476f;
            --warning-color: #ff9f1c;
            --region-virginia: #00b4d8;
            --region-ohio: #9d4edd;
            --region-california: #ff6b6b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, var(--mongo-forest) 0%, #002a3a 50%, var(--mongo-forest) 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .header {
            background: rgba(0, 30, 43, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 237, 100, 0.2);
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #2D8CFF, #0B5CFF);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1rem;
        }

        .logo-text {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .logo-text span { color: var(--mongo-green); }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cluster-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 16px;
            border: 1px solid;
        }

        .cluster-status.healthy { background: rgba(0, 237, 100, 0.1); border-color: rgba(0, 237, 100, 0.3); color: var(--mongo-green); }
        .cluster-status.degraded { background: rgba(255, 209, 102, 0.1); border-color: rgba(255, 209, 102, 0.3); color: var(--warning-color); }
        .cluster-status.critical { background: rgba(239, 71, 111, 0.1); border-color: rgba(239, 71, 111, 0.3); color: var(--danger-color); }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        .main-content {
            padding: 20px 25px;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Info Panel */
        .info-panel {
            background: rgba(0, 237, 100, 0.05);
            border: 1px solid rgba(0, 237, 100, 0.2);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .info-icon { font-size: 1.5rem; }
        .info-content { flex: 1; }
        .info-title { font-weight: 600; font-size: 1rem; margin-bottom: 4px; }
        .info-desc { font-size: 0.85rem; color: rgba(255, 255, 255, 0.7); }

        /* Controls */
        .controls-section {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-card {
            background: rgba(0, 30, 43, 0.7);
            border-radius: 10px;
            border: 1px solid rgba(0, 237, 100, 0.15);
            padding: 12px 14px;
        }

        .control-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--mongo-green);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-buttons { display: flex; gap: 6px; flex-wrap: wrap; }

        .action-btn {
            padding: 7px 12px;
            border: none;
            border-radius: 6px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn.primary { background: var(--mongo-green); color: var(--mongo-forest); }
        .action-btn.primary:hover { background: var(--mongo-dark-green); }
        .action-btn.secondary { background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); }
        .action-btn.secondary:hover { background: rgba(255, 255, 255, 0.15); }
        .action-btn.danger { background: rgba(239, 71, 111, 0.2); color: var(--danger-color); border: 1px solid rgba(239, 71, 111, 0.3); }
        .action-btn.danger:hover { background: rgba(239, 71, 111, 0.3); }

        .region-btn {
            padding: 7px 12px;
            border: none;
            border-radius: 6px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .region-btn.virginia { background: rgba(0, 180, 216, 0.2); color: var(--region-virginia); border: 1px solid var(--region-virginia); }
        .region-btn.ohio { background: rgba(157, 78, 221, 0.2); color: var(--region-ohio); border: 1px solid var(--region-ohio); }
        .region-btn.california { background: rgba(255, 107, 107, 0.2); color: var(--region-california); border: 1px solid var(--region-california); }
        .region-btn:hover { filter: brightness(1.2); }

        .wc-pills { display: flex; gap: 5px; }

        .wc-pill {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wc-pill:hover { background: rgba(255, 255, 255, 0.1); }
        .wc-pill.selected { background: rgba(0, 237, 100, 0.15); border-color: var(--mongo-green); color: var(--mongo-green); }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px;
            border-radius: 12px;
            width: fit-content;
        }

        .tab-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
        }

        .tab-btn:hover { color: white; background: rgba(255, 255, 255, 0.05); }
        .tab-btn.active.current { background: var(--danger-color); color: white; }
        .tab-btn.active.future { background: var(--mongo-green); color: var(--mongo-forest); }
        .tab-btn.active.comparison { background: var(--zoom-blue); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Current State Specific */
        .problem-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: rgba(239, 71, 111, 0.15);
            border: 1px solid var(--danger-color);
            border-radius: 12px;
            font-size: 0.75rem;
            color: var(--danger-color);
            font-weight: 500;
        }

        .dsp-layer {
            background: rgba(239, 71, 111, 0.1);
            border: 2px dashed var(--danger-color);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .dsp-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--danger-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .dsp-issues {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .replica-set-panel {
            flex: 1;
            min-width: 340px;
            background: rgba(0, 30, 43, 0.6);
            border-radius: 14px;
            border: 2px solid;
            overflow: hidden;
        }

        .replica-set-panel.virginia-rs { border-color: var(--region-virginia); }
        .replica-set-panel.ohio-rs { border-color: var(--region-ohio); }

        .rs-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .replica-set-panel.virginia-rs .rs-header { background: rgba(0, 180, 216, 0.15); }
        .replica-set-panel.ohio-rs .rs-header { background: rgba(157, 78, 221, 0.15); }

        .rs-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .replica-set-panel.virginia-rs .rs-icon { background: rgba(0, 180, 216, 0.2); }
        .replica-set-panel.ohio-rs .rs-icon { background: rgba(157, 78, 221, 0.2); }

        .rs-title { font-weight: 600; font-size: 1rem; }
        .rs-subtitle { font-size: 0.75rem; color: rgba(255, 255, 255, 0.5); }

        .rs-body { padding: 14px; }

        .node-card.hidden-node {
            border-color: #6c757d;
            border-style: dotted;
            opacity: 0.7;
        }

        .node-card.hidden-node .node-role {
            background: #6c757d;
            color: white;
        }

        .data-flow-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            color: var(--danger-color);
            font-size: 1.5rem;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            padding: 8px 12px;
            background: rgba(255, 159, 28, 0.1);
            border-radius: 8px;
            margin-top: 10px;
        }

        .sync-status.syncing { color: var(--warning-color); }
        .sync-status.lag { color: var(--danger-color); }

        /* Application Layer */
        .app-layer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 14px;
            background: rgba(45, 140, 255, 0.05);
            border: 1px solid rgba(45, 140, 255, 0.2);
            border-radius: 12px;
        }

        .app-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .app-node {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(45, 140, 255, 0.15);
            border: 2px solid var(--zoom-blue);
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .app-node.failover {
            border-style: dashed;
            opacity: 0.6;
            background: rgba(255, 255, 255, 0.05);
        }

        .app-node.down {
            border-color: var(--danger-color);
            background: rgba(239, 71, 111, 0.15);
            opacity: 0.5;
        }

        .app-node.active {
            border-color: var(--mongo-green);
            background: rgba(0, 237, 100, 0.15);
            animation: appPulse 2s infinite;
        }

        @keyframes appPulse {
            0%, 100% { box-shadow: 0 0 0 rgba(0, 237, 100, 0); }
            50% { box-shadow: 0 0 10px rgba(0, 237, 100, 0.3); }
        }

        .app-node .status-indicator {
            font-size: 0.7rem;
            margin-left: 6px;
        }

        .app-node-icon { font-size: 1.1rem; }
        .app-node-label { font-size: 0.7rem; color: rgba(255,255,255,0.5); }

        .app-connection {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .app-arrow {
            font-size: 1.5rem;
            color: var(--zoom-blue);
        }

        .app-arrow.to-va { color: var(--region-virginia); }
        .app-arrow.to-oh { color: var(--region-ohio); }

        .write-concern-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            background: rgba(255, 209, 102, 0.2);
            border-radius: 8px;
            color: var(--warning-color);
            font-family: 'Source Code Pro', monospace;
        }

        .app-layer-title {
            font-size: 0.8rem;
            color: var(--zoom-blue);
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
        }

        .issues-panel {
            background: rgba(239, 71, 111, 0.05);
            border: 1px solid rgba(239, 71, 111, 0.2);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 20px;
        }

        .issues-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--danger-color);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .issues-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
        }

        .issue-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .issue-icon { font-size: 1rem; }
        .issue-text { color: rgba(255, 255, 255, 0.8); }

        /* Comparison Tab Styles */
        .comparison-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .comparison-header {
            text-align: center;
            margin-bottom: 10px;
        }

        .comparison-header h2 {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .comparison-header p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.95rem;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 80px 1fr;
            gap: 16px;
            align-items: start;
        }

        .comparison-column {
            background: rgba(0, 30, 43, 0.6);
            border-radius: 14px;
            border: 2px solid;
            overflow: hidden;
        }

        .comparison-column.current { border-color: var(--danger-color); }
        .comparison-column.future { border-color: var(--mongo-green); }

        .comparison-column-header {
            padding: 16px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .comparison-column.current .comparison-column-header {
            background: rgba(239, 71, 111, 0.15);
            color: var(--danger-color);
        }

        .comparison-column.future .comparison-column-header {
            background: rgba(0, 237, 100, 0.15);
            color: var(--mongo-green);
        }

        .comparison-column-body {
            padding: 16px;
        }

        .comparison-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--zoom-blue);
            padding-top: 60px;
        }

        .comparison-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .comparison-item:last-child { margin-bottom: 0; }

        .comparison-item-icon { font-size: 1.2rem; flex-shrink: 0; }
        .comparison-item-content { flex: 1; }
        .comparison-item-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; }
        .comparison-item-desc { font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); }

        .comparison-column.current .comparison-item { border-left: 3px solid var(--danger-color); }
        .comparison-column.future .comparison-item { border-left: 3px solid var(--mongo-green); }

        /* Comparison Table */
        .comparison-table-container {
            background: rgba(0, 30, 43, 0.6);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .comparison-table th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .comparison-table th:first-child { background: rgba(0, 0, 0, 0.2); }
        .comparison-table th.current { background: rgba(239, 71, 111, 0.15); color: var(--danger-color); }
        .comparison-table th.future { background: rgba(0, 237, 100, 0.15); color: var(--mongo-green); }

        .comparison-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: top;
        }

        .comparison-table tr:last-child td { border-bottom: none; }

        .comparison-table td:first-child {
            font-weight: 500;
            background: rgba(0, 0, 0, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        .comparison-table td.bad { color: var(--danger-color); }
        .comparison-table td.good { color: var(--mongo-green); }

        .verdict-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .verdict-badge.bad { background: rgba(239, 71, 111, 0.2); color: var(--danger-color); }
        .verdict-badge.good { background: rgba(0, 237, 100, 0.2); color: var(--mongo-green); }

        /* Migration Path */
        .migration-section {
            background: rgba(45, 140, 255, 0.05);
            border: 1px solid rgba(45, 140, 255, 0.2);
            border-radius: 14px;
            padding: 20px;
        }

        .migration-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--zoom-blue);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .migration-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .migration-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .migration-step-number {
            width: 28px;
            height: 28px;
            background: var(--zoom-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .migration-step-content { flex: 1; }
        .migration-step-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; }
        .migration-step-desc { font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); }

        @media (max-width: 900px) {
            .comparison-grid { grid-template-columns: 1fr; }
            .comparison-arrow { transform: rotate(90deg); padding: 10px 0; }
        }

        /* Architecture Layout */
        .architecture-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Mongos Layer */
        .mongos-layer {
            background: rgba(0, 237, 100, 0.05);
            border: 1px solid rgba(0, 237, 100, 0.2);
            border-radius: 12px;
            padding: 15px;
        }

        .layer-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--mongo-green);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mongos-grid {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mongos-node {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(0, 237, 100, 0.1);
            border: 1px solid rgba(0, 237, 100, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mongos-node:hover { background: rgba(0, 237, 100, 0.2); }
        .mongos-node.down { opacity: 0.4; border-style: dashed; }

        .mongos-icon { font-size: 1.2rem; }
        .mongos-info { font-size: 0.85rem; }
        .mongos-region { font-size: 0.7rem; color: rgba(255,255,255,0.5); }

        /* Config Servers Layer */
        .config-layer {
            background: rgba(255, 193, 7, 0.05);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 12px;
            padding: 15px;
        }

        .config-layer .layer-title {
            color: #ffc107;
        }

        .config-grid {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .config-node {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .config-node.primary {
            border-color: rgba(255, 193, 7, 0.6);
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.2);
        }

        .config-node.down { opacity: 0.4; border-style: dashed; }

        .config-icon { font-size: 1.2rem; }
        .config-info { font-size: 0.85rem; }
        .config-region { font-size: 0.7rem; color: rgba(255,255,255,0.5); }
        .config-role { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: rgba(255,193,7,0.2); color: #ffc107; }

        /* Data Flow Layout - Apps on sides, Shards in center */
        .cluster-infra {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .cluster-infra .mongos-layer,
        .cluster-infra .config-layer {
            flex: 1;
        }

        .data-flow-layout {
            display: flex;
            gap: 15px;
            align-items: stretch;
        }

        /* Side App Panels */
        .side-app-panel {
            width: 150px;
            min-width: 150px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }

        .side-app-panel.virginia {
            border: 1px solid var(--region-virginia);
        }

        .side-app-panel.ohio {
            border: 1px solid var(--region-ohio);
        }

        .side-app-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .side-app-node {
            padding: 8px;
            background: rgba(0, 237, 100, 0.1);
            border: 1px solid rgba(0, 237, 100, 0.3);
            border-radius: 8px;
            text-align: center;
        }

        .side-app-node.active {
            border-color: var(--mongo-green);
            background: rgba(0, 237, 100, 0.15);
        }

        .side-app-node.standby {
            background: rgba(255, 255, 255, 0.03);
            border-color: rgba(255, 255, 255, 0.15);
            border-style: dashed;
            opacity: 0.6;
        }

        .side-app-node.degraded {
            background: rgba(255, 193, 7, 0.1);
            border-color: var(--warning-color);
        }

        .side-app-node.down {
            background: rgba(239, 71, 111, 0.1);
            border-color: var(--danger-color);
            opacity: 0.5;
        }

        .side-app-label {
            font-weight: 600;
            font-size: 0.75rem;
            margin-bottom: 3px;
        }

        .side-app-target {
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 5px;
        }

        .side-app-status {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }

        .side-app-node.active .side-app-status {
            background: rgba(0, 237, 100, 0.2);
            color: var(--mongo-green);
        }

        .side-app-node.standby .side-app-status {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
        }

        .side-app-node.degraded .side-app-status {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning-color);
        }

        .side-app-node.down .side-app-status {
            background: rgba(239, 71, 111, 0.2);
            color: var(--danger-color);
        }

        .side-app-arrow {
            text-align: center;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.25);
            line-height: 1;
        }

        .data-flow-layout .shards-container {
            flex: 1;
        }

        /* Control Select Dropdown */
        .control-select {
            width: 100%;
            padding: 8px 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }

        .control-select:hover {
            border-color: var(--mongo-green);
        }

        .control-select:focus {
            border-color: var(--mongo-green);
            box-shadow: 0 0 8px rgba(0, 237, 100, 0.3);
        }

        .control-select option {
            background: var(--mongo-slate);
            color: white;
            padding: 8px;
        }

        /* Shards Container */
        .shards-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .shard-panel {
            flex: 1;
            min-width: 380px;
            background: rgba(0, 30, 43, 0.6);
            border-radius: 14px;
            border: 2px solid rgba(0, 237, 100, 0.3);
            overflow: hidden;
        }

        .shard-header {
            padding: 12px 16px;
            background: rgba(0, 237, 100, 0.1);
            border-bottom: 1px solid rgba(0, 237, 100, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shard-icon {
            width: 32px;
            height: 32px;
            background: rgba(0, 237, 100, 0.15);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .shard-title { font-weight: 600; font-size: 1rem; }
        
        .shard-status {
            margin-left: auto;
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 10px;
        }

        .shard-status.healthy { background: rgba(0, 237, 100, 0.2); color: var(--mongo-green); }
        .shard-status.degraded { background: rgba(255, 209, 102, 0.2); color: var(--warning-color); }
        .shard-status.critical { background: rgba(239, 71, 111, 0.2); color: var(--danger-color); }

        .shard-config {
            font-size: 0.75rem;
            color: var(--mongo-green);
            font-family: 'Source Code Pro', monospace;
        }

        .shard-body {
            padding: 14px;
        }

        /* Region Row */
        .region-row {
            display: flex;
            align-items: stretch;
            gap: 10px;
            margin-bottom: 12px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border-left: 3px solid;
        }

        .region-row.virginia { border-color: var(--region-virginia); }
        .region-row.ohio { border-color: var(--region-ohio); }
        .region-row.california { border-color: var(--region-california); }
        .region-row.down { opacity: 0.5; }

        .region-label {
            min-width: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 2px;
        }

        .region-name {
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .region-latency {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.4);
        }

        .region-nodes {
            display: flex;
            gap: 8px;
            flex: 1;
            flex-wrap: wrap;
        }

        /* Node Card */
        .node-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .node-card:hover { transform: translateY(-2px); }

        .node-card.primary { border-color: var(--primary-color); box-shadow: 0 0 12px rgba(255, 209, 102, 0.2); }
        .node-card.secondary { border-color: var(--secondary-color); }
        .node-card.priority-zero { border-color: var(--priority-zero); border-style: dashed; }
        .node-card.down { border-color: var(--danger-color); opacity: 0.5; }
        .node-card.recovering { border-color: var(--warning-color); }
        .node-card.resyncing { 
            border-color: var(--zoom-blue); 
            animation: resyncPulse 1s ease-in-out infinite;
        }

        @keyframes resyncPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(45, 140, 255, 0.3); }
            50% { box-shadow: 0 0 15px rgba(45, 140, 255, 0.6); }
        }

        @keyframes criticalPulse {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(239, 71, 111, 0.3);
                border-color: var(--danger-color);
            }
            50% { 
                box-shadow: 0 0 25px rgba(239, 71, 111, 0.6);
                border-color: #ff4444;
            }
        }

        .node-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .node-icon { font-size: 1rem; }
        .node-name { font-size: 0.8rem; font-weight: 600; }

        .node-role {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: auto;
        }

        .node-card.primary .node-role { background: var(--primary-color); color: var(--mongo-forest); }
        .node-card.secondary .node-role { background: var(--secondary-color); color: var(--mongo-forest); }
        .node-card.priority-zero .node-role { background: var(--priority-zero); color: white; }
        .node-card.down .node-role { background: var(--danger-color); color: white; }

        .node-oplog {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.5);
            font-family: 'Source Code Pro', monospace;
        }

        .node-card.acknowledged::after {
            content: '‚úì';
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: var(--mongo-green);
            color: var(--mongo-forest);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            animation: ackPop 0.3s ease-out;
        }

        @keyframes ackPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .node-card.receiving {
            animation: receiveFlash 0.5s ease-out;
        }

        @keyframes receiveFlash {
            0% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.8); }
            100% { box-shadow: none; }
        }

        /* Event Log */
        .event-log-panel {
            background: rgba(0, 30, 43, 0.7);
            border-radius: 10px;
            border: 1px solid rgba(0, 237, 100, 0.15);
            padding: 12px;
            margin-top: 20px;
        }

        .event-log-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--mongo-green);
            margin-bottom: 10px;
        }

        .event-log {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 6px;
            font-family: 'Source Code Pro', monospace;
            font-size: 0.75rem;
        }

        .log-entry {
            flex-shrink: 0;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
            max-width: 280px;
        }

        .log-entry.info { border-color: var(--secondary-color); }
        .log-entry.success { border-color: var(--mongo-green); }
        .log-entry.warning { border-color: var(--warning-color); }
        .log-entry.error { border-color: var(--danger-color); }

        .log-time { color: rgba(255, 255, 255, 0.4); font-size: 0.65rem; margin-bottom: 2px; }
        .log-msg { color: rgba(255, 255, 255, 0.9); }

        /* Write Flow Panel */
        .write-flow-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 340px;
            background: rgba(0, 30, 43, 0.95);
            border: 2px solid var(--mongo-green);
            border-radius: 12px;
            padding: 14px;
            z-index: 100;
            display: none;
        }

        .write-flow-panel.visible { display: block; animation: slideUp 0.3s ease-out; }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .write-flow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .write-flow-title { font-weight: 600; font-size: 0.9rem; }

        .write-flow-wc {
            font-size: 0.8rem;
            padding: 3px 8px;
            background: rgba(0, 237, 100, 0.2);
            border-radius: 8px;
            color: var(--mongo-green);
        }

        .write-flow-steps { display: flex; flex-direction: column; gap: 6px; }

        .write-flow-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            font-size: 0.8rem;
            opacity: 0.4;
            transition: all 0.3s;
        }

        .write-flow-step.active {
            opacity: 1;
            background: rgba(0, 237, 100, 0.1);
            border-left: 3px solid var(--mongo-green);
        }

        .write-flow-step.complete { opacity: 1; }

        .step-icon { font-size: 0.9rem; width: 22px; text-align: center; }
        .step-label { font-size: 0.8rem; }
        .step-detail { font-size: 0.7rem; color: rgba(255,255,255,0.5); }

        .write-flow-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85rem;
            display: none;
        }

        .write-flow-result.success {
            display: block;
            background: rgba(0, 237, 100, 0.15);
            color: var(--mongo-green);
            border: 1px solid var(--mongo-green);
        }

        .write-flow-result.failed {
            display: block;
            background: rgba(239, 71, 111, 0.15);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        /* Election Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.visible { opacity: 1; visibility: visible; }

        .modal {
            background: var(--mongo-slate);
            border-radius: 16px;
            border: 1px solid rgba(0, 237, 100, 0.3);
            padding: 30px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.visible .modal { transform: scale(1); }
        .modal-icon { font-size: 2.5rem; margin-bottom: 12px; }
        .modal-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 8px; }
        .modal-text { color: rgba(255, 255, 255, 0.7); margin-bottom: 15px; line-height: 1.5; font-size: 0.9rem; }

        .election-progress {
            height: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .election-progress-bar {
            height: 100%;
            background: var(--mongo-green);
            width: 0%;
            transition: width 0.3s;
        }

        #election-status { font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); }

        /* Flow Particles */
        .replication-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        .flow-particle {
            position: fixed;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transition: all 0.4s ease-out;
        }

        .flow-particle.write {
            background: #ff6b6b;
            box-shadow: 0 0 15px #ff6b6b, 0 0 30px #ff6b6b;
        }

        .flow-particle.read {
            background: #4ecdc4;
            box-shadow: 0 0 15px #4ecdc4, 0 0 30px #4ecdc4;
        }

        .flow-particle.replication {
            background: var(--mongo-green);
            box-shadow: 0 0 12px var(--mongo-green), 0 0 24px var(--mongo-green);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .shards-container { flex-direction: column; }
            .shard-panel { min-width: 100%; }
            .write-flow-panel { width: 300px; right: 10px; bottom: 10px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">Z</div>
            <div class="logo-text">Zoom <span id="header-title">Architecture</span></div>
        </div>
        <div class="header-controls">
            <code id="header-config" style="background: rgba(0,237,100,0.1); padding: 3px 8px; border-radius: 5px; font-family: 'Source Code Pro', monospace; font-size: 0.75rem;">2 Shards √ó 5 Nodes (2-2-1) + 3 Config Servers</code>
            <div class="cluster-status healthy" id="cluster-status">
                <span class="status-dot"></span>
                <span id="status-text">Healthy</span>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn current active" onclick="switchTab('current')">‚ö†Ô∏è Current State</button>
            <button class="tab-btn future" onclick="switchTab('future')">‚ú® Future State</button>
            <button class="tab-btn comparison" onclick="switchTab('comparison')">üìä Comparison</button>
        </div>

        <!-- CURRENT STATE TAB -->
        <div class="tab-content active" id="tab-current">
            <div class="issues-panel">
                <div class="issues-title">‚ö†Ô∏è Custom Replication Layer (DSP) Issues</div>
                <div class="issues-grid">
                    <div class="issue-item"><span class="issue-icon">üíî</span><span class="issue-text"><strong>Data Loss Risk:</strong> Two-way async sync with ~30s lag - region failure = 30s of data loss</span></div>
                    <div class="issue-item"><span class="issue-icon">‚ö°</span><span class="issue-text"><strong>Single Point of Failure:</strong> DSP failure causes split-brain - both regions diverge</span></div>
                    <div class="issue-item"><span class="issue-icon">üîß</span><span class="issue-text"><strong>Not Native:</strong> Version compatibility issues with every MongoDB upgrade</span></div>
                    <div class="issue-item"><span class="issue-icon">üîç</span><span class="issue-text"><strong>Feature Gap:</strong> Cannot handle Atlas Search or Vector Search index capabilities</span></div>
                    <div class="issue-item"><span class="issue-icon">üö®</span><span class="issue-text"><strong>Ops Overhead:</strong> Custom sync layer maintenance, P1 incidents, performance degradation on failover</span></div>
                </div>
            </div>

            <div class="controls-section">
                <div class="control-card">
                    <div class="control-title">‚ö° Operations</div>
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="currentSimulateWrite('insert')">‚ûï Insert</button>
                        <button class="action-btn primary" onclick="currentSimulateWrite('update')">‚úèÔ∏è Update</button>
                        <button class="action-btn secondary" onclick="currentSimulateRead()">üìñ Read</button>
                    </div>
                </div>
                <div class="control-card">
                    <div class="control-title">üíª App Source</div>
                    <select id="current-app-source-select" class="control-select">
                        <option value="virginia">üóΩ Virginia Apps</option>
                        <option value="ohio">üå∞ Ohio Apps</option>
                    </select>
                </div>
                <div class="control-card">
                    <div class="control-title">üìñ Read Preference</div>
                    <select id="current-read-pref-select" class="control-select">
                        <option value="primary">primary</option>
                        <option value="primaryPreferred">primaryPreferred</option>
                        <option value="secondary">secondary</option>
                        <option value="secondaryPreferred" selected>secondaryPreferred</option>
                        <option value="nearest">nearest</option>
                    </select>
                </div>
                <div class="control-card">
                    <div class="control-title">üìù Write Concern</div>
                    <div class="wc-pills" id="current-wc-pills">
                        <div class="wc-pill selected" data-value="1" onclick="setCurrentWriteConcern('1', this)">w:1</div>
                        <div class="wc-pill" data-value="majority" onclick="setCurrentWriteConcern('majority', this)">w:majority</div>
                        <div class="wc-pill" data-value="all" onclick="setCurrentWriteConcern('all', this)">w:all</div>
                    </div>
                </div>
                <div class="control-card">
                    <div class="control-title">üá∫üá∏ Region Failure</div>
                    <div class="action-buttons" id="current-region-buttons">
                        <button class="region-btn virginia" onclick="currentToggleRegion('virginia')">üí• Kill Virginia</button>
                        <button class="region-btn ohio" onclick="currentToggleRegion('ohio')">üí• Kill Ohio</button>
                    </div>
                </div>
                <div class="control-card">
                    <div class="control-title">üí• DSP Failure</div>
                    <div class="action-buttons">
                        <button class="action-btn danger" id="dsp-toggle-btn" onclick="toggleDSP()">üí• Break DSP Sync</button>
                    </div>
                </div>
                <div class="control-card">
                    <div class="control-title">‚ÑπÔ∏è Failover Mode</div>
                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); padding: 6px 0;">
                        App failover is <strong style="color: var(--mongo-green);">AUTOMATIC</strong><br>
                        <span style="color: rgba(255,255,255,0.4);">Region failure ‚Üí Apps auto-activate in surviving region</span>
                    </div>
                </div>
                <div class="control-card">
                    <div class="control-title">üéÆ Cluster</div>
                    <div class="action-buttons">
                        <button class="action-btn danger" onclick="currentKillPrimary()">üí• Kill Primary</button>
                        <button class="action-btn secondary" onclick="currentResetCluster()">üîÑ Reset</button>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 12px; font-size: 0.8rem; color: rgba(255,255,255,0.5);">
                <span style="background: rgba(239,71,111,0.1); padding: 4px 12px; border-radius: 12px; border: 1px dashed rgba(239,71,111,0.3);">
                    üëÜ <strong>Tip:</strong> Click on any node to simulate failure/recovery
                </span>
            </div>

            <div class="architecture-layout">
                <!-- Application Layer -->
                <div class="app-layer" id="app-layer">
                    <div class="app-group">
                        <div class="app-layer-title">üóΩ Hosted in Virginia</div>
                        <div class="app-node active" id="va-app-main">
                            <span class="app-node-icon">üíª</span>
                            <div>
                                <div>Virginia Apps</div>
                                <div class="app-node-label">‚úì Writing to Virginia RS</div>
                            </div>
                        </div>
                        <div class="app-node failover" id="oh-failover-app">
                            <span class="app-node-icon">üíª</span>
                            <div>
                                <div>Ohio Failover</div>
                                <div class="app-node-label">Standby for Ohio traffic</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="app-connection" id="va-connection">
                        <span class="app-arrow to-va">‚Üí</span>
                        <span class="write-concern-badge" id="current-wc-va">w:1</span>
                        <div style="font-size: 0.65rem; color: rgba(255,255,255,0.4);">to Virginia RS</div>
                    </div>
                    
                    <div style="text-align: center; padding: 10px;" id="traffic-status">
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">Normal Operation</div>
                        <div style="font-size: 0.7rem; color: rgba(255,255,255,0.3);">Each region handles its traffic</div>
                    </div>
                    
                    <div class="app-connection" id="oh-connection">
                        <span class="app-arrow to-oh">‚Üê</span>
                        <span class="write-concern-badge" id="current-wc-oh">w:1</span>
                        <div style="font-size: 0.65rem; color: rgba(255,255,255,0.4);">to Ohio RS</div>
                    </div>
                    
                    <div class="app-group">
                        <div class="app-layer-title">üå∞ Hosted in Ohio</div>
                        <div class="app-node active" id="oh-app-main">
                            <span class="app-node-icon">üíª</span>
                            <div>
                                <div>Ohio Apps</div>
                                <div class="app-node-label">‚úì Writing to Ohio RS</div>
                            </div>
                        </div>
                        <div class="app-node failover" id="va-failover-app">
                            <span class="app-node-icon">üíª</span>
                            <div>
                                <div>Virginia Failover</div>
                                <div class="app-node-label">Standby for Virginia traffic</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Complete Outage Banner -->
                <div class="complete-outage-banner" id="complete-outage-banner" style="display: none; background: rgba(0, 0, 0, 0.8); border: 3px solid var(--danger-color); border-radius: 10px; padding: 20px; margin-bottom: 16px; text-align: center; animation: criticalPulse 0.5s ease-in-out infinite;">
                    <div style="font-weight: 700; color: var(--danger-color); font-size: 1.3rem;">üö®üö®üö® COMPLETE OUTAGE üö®üö®üö®</div>
                    <div style="font-size: 1rem; color: white; margin-top: 10px;">BOTH REGIONS ARE DOWN!</div>
                    <div style="font-size: 0.9rem; color: var(--danger-color); margin-top: 8px;">
                        ‚ùå Virginia: DOWN &nbsp;&nbsp;|&nbsp;&nbsp; ‚ùå Ohio: DOWN
                    </div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 10px;">All applications disconnected ‚Ä¢ No failover possible ‚Ä¢ Service unavailable</div>
                </div>

                <!-- Split Brain Critical Warning -->
                <div class="split-brain-banner" id="split-brain-banner" style="display: none; background: rgba(239, 71, 111, 0.25); border: 2px solid var(--danger-color); border-radius: 10px; padding: 16px; margin-bottom: 16px; text-align: center; animation: criticalPulse 1s ease-in-out infinite;">
                    <div style="font-weight: 700; color: var(--danger-color); font-size: 1.1rem;">üö® CRITICAL: SPLIT-BRAIN DETECTED üö®</div>
                    <div style="font-size: 0.9rem; color: var(--danger-color); margin-top: 8px;">Both regions accepting writes with NO synchronization!</div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin-top: 8px;">
                        <span style="color: var(--region-virginia);">Virginia RS</span> ‚ö° writes ‚Üê‚úï‚Üí writes ‚ö° <span style="color: var(--region-ohio);">Ohio RS</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--warning-color); margin-top: 8px;">üíî Data diverging! Manual reconciliation will be required!</div>
                </div>

                <!-- Performance Degradation Banner -->
                <div class="perf-degradation-banner" id="perf-degradation-banner" style="display: none; background: rgba(255, 159, 28, 0.15); border: 1px solid var(--warning-color); border-radius: 10px; padding: 12px 16px; margin-bottom: 16px; text-align: center;">
                    <div style="font-weight: 600; color: var(--warning-color); font-size: 0.9rem;">‚ö†Ô∏è PERFORMANCE DEGRADATION</div>
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);" id="perf-degradation-msg">All traffic routing to single region - 2x load</div>
                </div>

                <div class="shards-container" id="current-clusters">
                    <!-- Virginia Cluster -->
                    <div class="replica-set-panel virginia-rs" id="virginia-rs-panel">
                        <div class="rs-header">
                            <div class="rs-icon">üóΩ</div>
                            <div>
                                <div class="rs-title">Virginia Replica Set</div>
                                <div class="rs-subtitle">us-east-1 ‚Ä¢ 3 nodes + 1 hidden</div>
                            </div>
                            <span class="shard-status healthy" id="virginia-rs-status">‚úì Healthy</span>
                        </div>
                        <div class="rs-body" id="virginia-rs-nodes">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- DSP Layer - Two Way Sync -->
                    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-width: 220px;">
                        <div class="dsp-layer" id="dsp-layer">
                            <div class="dsp-title">üîÑ Custom DSP</div>
                            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.6); margin-bottom: 8px;">
                                Two-Way Replication Layer
                            </div>
                            
                            <!-- Two-way sync arrows -->
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.7rem;">
                                <div style="text-align: center;">
                                    <div style="color: var(--region-virginia);">VA ‚Üí OH</div>
                                    <div id="dsp-va-to-oh" style="color: var(--mongo-green);">‚úì Syncing</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="color: var(--region-ohio);">OH ‚Üí VA</div>
                                    <div id="dsp-oh-to-va" style="color: var(--mongo-green);">‚úì Syncing</div>
                                </div>
                            </div>
                            
                            <div class="dsp-issues">
                                <span class="problem-badge">SPOF</span>
                                <span class="problem-badge">~30s Lag</span>
                            </div>
                            <div class="sync-status syncing" id="dsp-status">
                                <span>üîÑ</span> Both directions: ~30s lag
                            </div>
                        </div>
                        <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 6px; text-align: center;">
                            ‚áÑ Bidirectional async replication
                        </div>
                    </div>

                    <!-- Ohio Cluster -->
                    <div class="replica-set-panel ohio-rs" id="ohio-rs-panel">
                        <div class="rs-header">
                            <div class="rs-icon">üå∞</div>
                            <div>
                                <div class="rs-title">Ohio Replica Set</div>
                                <div class="rs-subtitle">us-east-2 ‚Ä¢ 3 nodes</div>
                            </div>
                            <span class="shard-status healthy" id="ohio-rs-status">‚úì Healthy</span>
                        </div>
                        <div class="rs-body" id="ohio-rs-nodes">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="event-log-panel">
                <div class="event-log-title">üìã Event Log (Current State)</div>
                <div class="event-log" id="current-event-log"></div>
            </div>
        </div>

        <!-- FUTURE STATE TAB -->
        <div class="tab-content" id="tab-future">
            <div class="info-panel" id="info-panel">
                <div class="info-icon">‚úÖ</div>
                <div class="info-content">
                    <div class="info-title">Future State: Native MongoDB Sharded Cluster</div>
                    <div class="info-desc">
                        <strong>Shard 1:</strong> Primary in Virginia (unless VA down) ‚Ä¢ 
                        <strong>Shard 2:</strong> Primary in Ohio (unless OH down) ‚Ä¢ 
                        <strong>California:</strong> Priority 0 nodes (DR only, can't become primary) ‚Ä¢ 
                        <strong>Config Servers:</strong> CSRS replica set stores cluster metadata ‚Ä¢ 
                        Virginia ‚Üî Ohio: ~10ms, East ‚Üî West: ~70ms. w:majority = 3 nodes per shard.
                        <span style="opacity: 0.7; margin-left: 8px;">‚Ä¢ üëÜ Click nodes to simulate failure/recovery</span>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <div class="control-card">
                    <div class="control-title">‚ö° Operations</div>
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="simulateWrite('insert')">‚ûï Insert</button>
                        <button class="action-btn primary" onclick="simulateWrite('update')">‚úèÔ∏è Update</button>
                        <button class="action-btn secondary" onclick="simulateRead()">üìñ Read</button>
                    </div>
                </div>
                <div class="control-card">
                    <div class="control-title">üíª App Source</div>
                    <select id="app-source-select" class="control-select">
                        <option value="auto">Auto (based on shard)</option>
                        <option value="virginia">üóΩ Virginia Apps</option>
                        <option value="ohio">üå∞ Ohio Apps</option>
                    </select>
                </div>
                <div class="control-card">
                    <div class="control-title">üìñ Read Preference</div>
                    <select id="read-pref-select" class="control-select">
                        <option value="primary">primary</option>
                        <option value="primaryPreferred">primaryPreferred</option>
                        <option value="secondary">secondary</option>
                        <option value="secondaryPreferred" selected>secondaryPreferred</option>
                        <option value="nearest">nearest</option>
                    </select>
                </div>
                <div class="control-card">
                    <div class="control-title">üìù Write Concern</div>
                    <div class="wc-pills" id="wc-pills">
                        <div class="wc-pill" data-value="1">w:1</div>
                        <div class="wc-pill selected" data-value="majority">w:majority</div>
                        <div class="wc-pill" data-value="all">w:all</div>
                    </div>
                </div>
                <div class="control-card">
                    <div class="control-title">üá∫üá∏ Region Failure</div>
                    <div class="action-buttons" id="region-buttons">
                        <button class="region-btn virginia" onclick="toggleRegion('virginia')">üí• Kill Virginia</button>
                        <button class="region-btn ohio" onclick="toggleRegion('ohio')">üí• Kill Ohio</button>
                        <button class="region-btn california" onclick="toggleRegion('california')">üí• Kill California</button>
                    </div>
                </div>
                <div class="control-card">
                    <div class="control-title">üéÆ Cluster</div>
                    <div class="action-buttons">
                        <button class="action-btn danger" onclick="killRandomPrimary()">üí• Kill Primary</button>
                        <button class="action-btn secondary" onclick="resetCluster()">üîÑ Reset</button>
                    </div>
                </div>
                <div class="control-card">
                    <div class="control-title">‚öñÔ∏è Rebalance</div>
                    <div class="action-buttons">
                        <button class="action-btn primary" id="rebalance-btn" onclick="rebalancePrimaries()">üîÑ Rebalance Primaries</button>
                    </div>
                    <div id="rebalance-status" style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 6px;"></div>
                </div>
            </div>

            <div class="architecture-layout">
                <!-- Mongos + Config Layer (Top) -->
                <div class="cluster-infra">
                    <div class="mongos-layer">
                        <div class="layer-title">üîÄ Query Routers (mongos)</div>
                        <div class="mongos-grid" id="mongos-grid"></div>
                    </div>
                    <div class="config-layer">
                        <div class="layer-title">‚öôÔ∏è Config Servers (CSRS)</div>
                        <div class="config-grid" id="config-grid"></div>
                    </div>
                </div>

                <!-- Main Data Layer: Apps - Shards - Apps -->
                <div class="data-flow-layout">
                    <!-- Virginia Apps (Left) -->
                    <div class="side-app-panel virginia">
                        <div class="side-app-header">üóΩ Virginia Region</div>
                        <div class="side-app-node active" id="future-va-main">
                            <div class="side-app-label">Shard 1 Apps</div>
                            <div class="side-app-target">mongos-va ‚Üí Shard 1</div>
                            <div class="side-app-status">‚úì Active</div>
                        </div>
                        <div class="side-app-arrow">‚Üí</div>
                        <div class="side-app-node standby" id="future-oh-failover">
                            <div class="side-app-label">Shard 2 Failover</div>
                            <div class="side-app-target">mongos-va ‚Üí Shard 2</div>
                            <div class="side-app-status">‚è∏ Standby</div>
                        </div>
                        <div class="side-app-arrow">‚Üí</div>
                    </div>

                    <!-- Shards (Center) -->
                    <div class="shards-container" id="shards-container"></div>

                    <!-- Ohio Apps (Right) -->
                    <div class="side-app-panel ohio">
                        <div class="side-app-header">üå∞ Ohio Region</div>
                        <div class="side-app-node active" id="future-oh-main">
                            <div class="side-app-label">Shard 2 Apps</div>
                            <div class="side-app-target">mongos-oh ‚Üí Shard 2</div>
                            <div class="side-app-status">‚úì Active</div>
                        </div>
                        <div class="side-app-arrow">‚Üê</div>
                        <div class="side-app-node standby" id="future-va-failover">
                            <div class="side-app-label">Shard 1 Failover</div>
                            <div class="side-app-target">mongos-oh ‚Üí Shard 1</div>
                            <div class="side-app-status">‚è∏ Standby</div>
                        </div>
                        <div class="side-app-arrow">‚Üê</div>
                    </div>
                </div>
            </div>

            <div class="event-log-panel">
                <div class="event-log-title">üìã Event Log (Future State)</div>
                <div class="event-log" id="event-log"></div>
            </div>
        </div>

        <!-- COMPARISON TAB -->
        <div class="tab-content" id="tab-comparison">
            <div class="comparison-container">
                <div class="comparison-header">
                    <h2>üîÑ Architecture Comparison</h2>
                    <p>Side-by-side analysis of Current State vs Recommended Future State</p>
                </div>

                <!-- Visual Comparison -->
                <div class="comparison-grid">
                    <div class="comparison-column current">
                        <div class="comparison-column-header">‚ö†Ô∏è Current State</div>
                        <div class="comparison-column-body">
                            <div class="comparison-item">
                                <span class="comparison-item-icon">üè¢</span>
                                <div class="comparison-item-content">
                                    <div class="comparison-item-title">2 Separate Replica Sets</div>
                                    <div class="comparison-item-desc">Virginia RS (3 nodes + 1 hidden) + Ohio RS (3 nodes) operating independently</div>
                                </div>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-item-icon">üîÑ</span>
                                <div class="comparison-item-content">
                                    <div class="comparison-item-title">Custom DSP Sync Layer</div>
                                    <div class="comparison-item-desc">~30 second replication lag, single point of failure</div>
                                </div>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-item-icon">üëÅÔ∏è</span>
                                <div class="comparison-item-content">
                                    <div class="comparison-item-title">Hidden Analytics Node</div>
                                    <div class="comparison-item-desc">Virginia has hidden node - cannot participate in elections</div>
                                </div>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-item-icon">üîß</span>
                                <div class="comparison-item-content">
                                    <div class="comparison-item-title">Manual Cross-Region Failover</div>
                                    <div class="comparison-item-desc">Requires operator intervention to fail over to Ohio</div>
                                </div>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-item-icon">üìç</span>
                                <div class="comparison-item-content">
                                    <div class="comparison-item-title">2 Regions Only</div>
                                    <div class="comparison-item-desc">Virginia + Ohio (no disaster recovery region)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="comparison-arrow">‚Üí</div>

                    <div class="comparison-column future">
                        <div class="comparison-column-header">‚úÖ Future State</div>
                        <div class="comparison-column-body">
                            <div class="comparison-item">
                                <span class="comparison-item-icon">üì¶</span>
                                <div class="comparison-item-content">
                                    <div class="comparison-item-title">Native Sharded Cluster</div>
                                    <div class="comparison-item-desc">2 Shards √ó 5 Nodes each with 2-2-1 distribution</div>
                                </div>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-item-icon">‚ö°</span>
                                <div class="comparison-item-content">
                                    <div class="comparison-item-title">Real-time Replication</div>
                                    <div class="comparison-item-desc">Native MongoDB replication, sub-second sync</div>
                                </div>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-item-icon">üõ°Ô∏è</span>
                                <div class="comparison-item-content">
                                    <div class="comparison-item-title">Priority 0 DR Nodes</div>
                                    <div class="comparison-item-desc">California nodes for disaster recovery, can't become primary</div>
                                </div>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-item-icon">ü§ñ</span>
                                <div class="comparison-item-content">
                                    <div class="comparison-item-title">Automatic Failover</div>
                                    <div class="comparison-item-desc">Elections happen automatically, ~10-30 second failover</div>
                                </div>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-item-icon">üåé</span>
                                <div class="comparison-item-content">
                                    <div class="comparison-item-title">3 Regions</div>
                                    <div class="comparison-item-desc">Virginia + Ohio + California (survives any single region failure)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Comparison Table -->
                <div class="comparison-table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Aspect</th>
                                <th class="current">Current State</th>
                                <th class="future">Future State</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Architecture</td>
                                <td class="bad">2 separate replica sets + custom sync <span class="verdict-badge bad">‚ùå Complex</span></td>
                                <td class="good">Native sharded cluster <span class="verdict-badge good">‚úì Standard</span></td>
                            </tr>
                            <tr>
                                <td>Replication Lag</td>
                                <td class="bad">~30 seconds (DSP async) <span class="verdict-badge bad">‚ùå High</span></td>
                                <td class="good">Sub-second (native) <span class="verdict-badge good">‚úì Real-time</span></td>
                            </tr>
                            <tr>
                                <td>Data Loss Risk</td>
                                <td class="bad">High - DSP failures cause data divergence <span class="verdict-badge bad">‚ùå Risky</span></td>
                                <td class="good">Low - w:majority guarantees durability <span class="verdict-badge good">‚úì Safe</span></td>
                            </tr>
                            <tr>
                                <td>Cross-Region Failover</td>
                                <td class="bad">Manual intervention required <span class="verdict-badge bad">‚ùå Manual</span></td>
                                <td class="good">Automatic election (~10-30s) <span class="verdict-badge good">‚úì Auto</span></td>
                            </tr>
                            <tr>
                                <td>Write Concern</td>
                                <td class="bad">w:1 to Virginia only <span class="verdict-badge bad">‚ùå Weak</span></td>
                                <td class="good">w:majority across 3 nodes <span class="verdict-badge good">‚úì Strong</span></td>
                            </tr>
                            <tr>
                                <td>Total Nodes</td>
                                <td>7 nodes (4 in VA + 3 in OH)</td>
                                <td>10 nodes (5+5 per shard)</td>
                            </tr>
                            <tr>
                                <td>Regions</td>
                                <td>2 (Virginia, Ohio)</td>
                                <td class="good">3 (Virginia, Ohio, California) <span class="verdict-badge good">‚úì DR</span></td>
                            </tr>
                            <tr>
                                <td>Single Point of Failure</td>
                                <td class="bad">Yes - DSP layer <span class="verdict-badge bad">‚ùå SPOF</span></td>
                                <td class="good">None <span class="verdict-badge good">‚úì HA</span></td>
                            </tr>
                            <tr>
                                <td>Analytics Nodes</td>
                                <td>Hidden node (can't vote)</td>
                                <td class="good">Priority 0 nodes (participate in replication) <span class="verdict-badge good">‚úì Better</span></td>
                            </tr>
                            <tr>
                                <td>Horizontal Scaling</td>
                                <td class="bad">Manual application-level sharding <span class="verdict-badge bad">‚ùå Hard</span></td>
                                <td class="good">Native sharding with auto-balancing <span class="verdict-badge good">‚úì Easy</span></td>
                            </tr>
                            <tr>
                                <td>MongoDB Features</td>
                                <td class="bad">Limited (no change streams across clusters)</td>
                                <td class="good">Full (change streams, transactions, etc.) <span class="verdict-badge good">‚úì Full</span></td>
                            </tr>
                            <tr>
                                <td>Operational Overhead</td>
                                <td class="bad">High - maintain custom DSP <span class="verdict-badge bad">‚ùå High</span></td>
                                <td class="good">Low - standard MongoDB ops <span class="verdict-badge good">‚úì Low</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Migration Path -->
                <div class="migration-section">
                    <div class="migration-title">üöÄ Recommended Migration Path</div>
                    <div class="migration-steps">
                        <div class="migration-step">
                            <div class="migration-step-number">1</div>
                            <div class="migration-step-content">
                                <div class="migration-step-title">Deploy New Cluster</div>
                                <div class="migration-step-desc">Set up 2-shard cluster with 2-2-1 topology in Virginia, Ohio, and California</div>
                            </div>
                        </div>
                        <div class="migration-step">
                            <div class="migration-step-number">2</div>
                            <div class="migration-step-content">
                                <div class="migration-step-title">Enable Mongosync</div>
                                <div class="migration-step-desc">Use MongoDB mongosync for live migration with near-zero downtime</div>
                            </div>
                        </div>
                        <div class="migration-step">
                            <div class="migration-step-number">3</div>
                            <div class="migration-step-content">
                                <div class="migration-step-title">Cutover Applications</div>
                                <div class="migration-step-desc">Switch connection strings to new mongos routers, verify w:majority writes</div>
                            </div>
                        </div>
                        <div class="migration-step">
                            <div class="migration-step-number">4</div>
                            <div class="migration-step-content">
                                <div class="migration-step-title">Decommission DSP</div>
                                <div class="migration-step-desc">Remove custom sync layer and legacy replica sets after validation</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Benefits Summary -->
                <div class="info-panel" style="border-color: var(--mongo-green); background: rgba(0, 237, 100, 0.05);">
                    <div class="info-icon">üéØ</div>
                    <div class="info-content">
                        <div class="info-title" style="color: var(--mongo-green);">Key Benefits of Migration</div>
                        <div class="info-desc">
                            <strong>Eliminate Data Loss Risk</strong> - No more DSP sync failures causing data divergence<br>
                            <strong>Automatic Failover</strong> - Cross-region failover without manual intervention<br>
                            <strong>Better Durability</strong> - w:majority guarantees writes survive node failures<br>
                            <strong>Full Feature Access</strong> - Change streams, transactions, and all MongoDB features work natively<br>
                            <strong>Reduced Ops Burden</strong> - No custom sync layer to maintain
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="replication-overlay" id="replication-overlay"></div>

    <div class="write-flow-panel" id="write-flow-panel">
        <div class="write-flow-header">
            <div class="write-flow-title">‚úèÔ∏è Write Operation</div>
            <div class="write-flow-wc" id="flow-wc">w:majority</div>
        </div>
        <div class="write-flow-steps" id="write-flow-steps"></div>
        <div class="write-flow-result" id="write-flow-result"></div>
    </div>

    <div class="modal-overlay" id="election-modal">
        <div class="modal">
            <div class="modal-icon">üó≥Ô∏è</div>
            <div class="modal-title">Election in Progress</div>
            <div class="modal-text" id="election-text">Primary node is down. Initiating automatic failover...</div>
            <div class="election-progress">
                <div class="election-progress-bar" id="election-progress"></div>
            </div>
            <div id="election-status">Detecting failure...</div>
        </div>
    </div>

    <script>
        // ============ TAB SWITCHING ============
        let activeTab = 'current';

        function switchTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab-btn.${tab}`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            const headerTitle = document.getElementById('header-title');
            const headerConfig = document.getElementById('header-config');
            const clusterStatus = document.getElementById('cluster-status');
            const statusText = document.getElementById('status-text');
            
            if (tab === 'current') {
                headerTitle.innerHTML = '<span style="color: var(--danger-color);">Current State</span>';
                headerConfig.textContent = 'VA (3+1 hidden) + OH (3) + DSP';
                headerConfig.style.background = 'rgba(239, 71, 111, 0.2)';
                updateCurrentClusterStatus();
            } else if (tab === 'future') {
                headerTitle.innerHTML = '<span>Future State</span>';
                headerConfig.textContent = '2 Shards √ó 5 Nodes (2-2-1)';
                headerConfig.style.background = 'rgba(0,237,100,0.1)';
                updateClusterStatus();
            } else if (tab === 'comparison') {
                headerTitle.innerHTML = '<span style="color: var(--zoom-blue);">Comparison</span>';
                headerConfig.textContent = 'Current vs Future Architecture';
                headerConfig.style.background = 'rgba(45, 140, 255, 0.2)';
                clusterStatus.classList.remove('healthy', 'degraded', 'critical');
                clusterStatus.classList.add('healthy');
                statusText.textContent = 'Analysis';
            }
        }

        // ============ CLUSTER CONFIGURATION ============
        const REGIONS = {
            virginia: { name: 'Virginia', icon: 'üóΩ', location: 'us-east-1', latency: '~1ms', color: '#00b4d8' },
            ohio: { name: 'Ohio', icon: 'üå∞', location: 'us-east-2', latency: '~10ms', color: '#9d4edd' },
            california: { name: 'N. California', icon: 'üåâ', location: 'us-west-1', latency: '~70ms', color: '#ff6b6b' }
        };

        // ============ CURRENT STATE (Problematic Architecture) ============
        const currentState = {
            dspActive: true,
            dspLag: 30,
            writeConcern: '1', // Default w:1 for current state (typical legacy config)
            regionStatus: { virginia: 'healthy', ohio: 'healthy' },
            // App hosting: VA region hosts (vaMain + ohFailover), OH region hosts (ohMain + vaFailover)
            appStatus: {
                vaMain: 'active',      // Virginia Apps (hosted in Virginia) ‚Üí writes to Virginia RS
                ohFailover: 'standby', // Ohio Failover Apps (hosted in Virginia) ‚Üí standby for Ohio traffic
                ohMain: 'active',      // Ohio Apps (hosted in Ohio) ‚Üí writes to Ohio RS
                vaFailover: 'standby'  // Virginia Failover Apps (hosted in Ohio) ‚Üí standby for Virginia traffic
            },
            isElecting: {},
            virginiaRS: {
                id: 'virginia-rs',
                nodes: [
                    { id: 'va-1', name: 'mongo-va-1', role: 'primary', status: 'healthy', priority: 3, oplogCount: 0 },
                    { id: 'va-2', name: 'mongo-va-2', role: 'secondary', status: 'healthy', priority: 2, oplogCount: 0 },
                    { id: 'va-3', name: 'mongo-va-3', role: 'secondary', status: 'healthy', priority: 1, oplogCount: 0 },
                    { id: 'va-hidden', name: 'mongo-va-hidden', role: 'hidden', status: 'healthy', priority: 0, oplogCount: 0, hidden: true }
                ]
            },
            ohioRS: {
                id: 'ohio-rs',
                nodes: [
                    { id: 'oh-1', name: 'mongo-oh-1', role: 'primary', status: 'healthy', priority: 2, oplogCount: 0 },
                    { id: 'oh-2', name: 'mongo-oh-2', role: 'secondary', status: 'healthy', priority: 1, oplogCount: 0 },
                    { id: 'oh-3', name: 'mongo-oh-3', role: 'secondary', status: 'healthy', priority: 1, oplogCount: 0 }
                ]
            }
        };

        // ============ FUTURE STATE (Proper Sharded Cluster) ============
        const state = {
            writeConcern: 'majority',
            readPreference: 'secondaryPreferred',
            appSource: 'auto',
            regionStatus: { virginia: 'healthy', ohio: 'healthy', california: 'healthy' },
            isElecting: {},
            mongos: [
                { id: 'mongos-va', region: 'virginia', status: 'healthy' },
                { id: 'mongos-oh', region: 'ohio', status: 'healthy' },
                { id: 'mongos-ca', region: 'california', status: 'healthy' }
            ],
            configServers: [
                { id: 'cfg-va', name: 'config-va', region: 'virginia', role: 'primary', status: 'healthy' },
                { id: 'cfg-oh', name: 'config-oh', region: 'ohio', role: 'secondary', status: 'healthy' },
                { id: 'cfg-ca', name: 'config-ca', region: 'california', role: 'secondary', status: 'healthy' }
            ],
            shards: [
                {
                    id: 'shard1',
                    name: 'Shard 1',
                    preferredRegion: 'virginia', // Primary should be in Virginia
                    nodes: [
                        { id: 's1-va-1', name: 'shard1-va-1', region: 'virginia', role: 'primary', status: 'healthy', priority: 3, oplogCount: 0 },
                        { id: 's1-va-2', name: 'shard1-va-2', region: 'virginia', role: 'secondary', status: 'healthy', priority: 2, oplogCount: 0 },
                        { id: 's1-oh-1', name: 'shard1-oh-1', region: 'ohio', role: 'secondary', status: 'healthy', priority: 1, oplogCount: 0 },
                        { id: 's1-oh-2', name: 'shard1-oh-2', region: 'ohio', role: 'secondary', status: 'healthy', priority: 1, oplogCount: 0 },
                        { id: 's1-ca-1', name: 'shard1-ca-1', region: 'california', role: 'secondary', status: 'healthy', priority: 0, oplogCount: 0 }
                    ]
                },
                {
                    id: 'shard2',
                    name: 'Shard 2',
                    preferredRegion: 'ohio', // Primary should be in Ohio
                    nodes: [
                        { id: 's2-oh-1', name: 'shard2-oh-1', region: 'ohio', role: 'primary', status: 'healthy', priority: 3, oplogCount: 0 },
                        { id: 's2-oh-2', name: 'shard2-oh-2', region: 'ohio', role: 'secondary', status: 'healthy', priority: 2, oplogCount: 0 },
                        { id: 's2-va-1', name: 'shard2-va-1', region: 'virginia', role: 'secondary', status: 'healthy', priority: 1, oplogCount: 0 },
                        { id: 's2-va-2', name: 'shard2-va-2', region: 'virginia', role: 'secondary', status: 'healthy', priority: 1, oplogCount: 0 },
                        { id: 's2-ca-1', name: 'shard2-ca-1', region: 'california', role: 'secondary', status: 'healthy', priority: 0, oplogCount: 0 }
                    ]
                }
            ]
        };

        // ============ HELPERS ============
        function getMajorityRequired(shard) {
            return Math.floor(shard.nodes.length / 2) + 1; // 5/2+1 = 3
        }

        function getHealthyNodes(shard) {
            return shard.nodes.filter(n => n.status === 'healthy');
        }

        function hasMajority(shard) {
            return getHealthyNodes(shard).length >= getMajorityRequired(shard);
        }

        function log(message, type = 'info') {
            const eventLog = document.getElementById('event-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            entry.innerHTML = `<div class="log-time">${time}</div><div class="log-msg">${message}</div>`;
            eventLog.insertBefore(entry, eventLog.firstChild);
            while (eventLog.children.length > 12) eventLog.removeChild(eventLog.lastChild);
        }

        function animateParticle(fromEl, toEl, type = 'write', duration = 400) {
            if (!fromEl || !toEl) return Promise.resolve();
            
            const fromRect = fromEl.getBoundingClientRect();
            const toRect = toEl.getBoundingClientRect();
            
            const particle = document.createElement('div');
            particle.className = `flow-particle ${type}`;
            particle.style.left = `${fromRect.left + fromRect.width / 2 - 7}px`;
            particle.style.top = `${fromRect.top + fromRect.height / 2 - 7}px`;
            document.body.appendChild(particle);
            
            // Highlight source
            fromEl.style.boxShadow = type === 'write' ? '0 0 20px rgba(255, 107, 107, 0.6)' : '0 0 20px rgba(78, 205, 196, 0.6)';
            
            return new Promise(resolve => {
                requestAnimationFrame(() => {
                    particle.style.left = `${toRect.left + toRect.width / 2 - 7}px`;
                    particle.style.top = `${toRect.top + toRect.height / 2 - 7}px`;
                    particle.style.transition = `all ${duration}ms ease-out`;
                });
                
                setTimeout(() => {
                    fromEl.style.boxShadow = '';
                    toEl.style.boxShadow = type === 'write' ? '0 0 20px rgba(255, 107, 107, 0.6)' : '0 0 20px rgba(78, 205, 196, 0.6)';
                    setTimeout(() => {
                        toEl.style.boxShadow = '';
                        particle.remove();
                        resolve();
                    }, 300);
                }, duration);
            });
        }

        // ============ RENDERING ============
        function renderMongos() {
            const grid = document.getElementById('mongos-grid');
            grid.innerHTML = state.mongos.map(m => {
                const region = REGIONS[m.region];
                const isDown = state.regionStatus[m.region] === 'down';
                return `
                    <div class="mongos-node ${isDown ? 'down' : ''}" id="mongos-${m.region}" onclick="toggleMongos('${m.id}')">
                        <span class="mongos-icon">üîÄ</span>
                        <div>
                            <div class="mongos-info">${m.id}</div>
                            <div class="mongos-region">${region.icon} ${region.name}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderConfigServers() {
            const grid = document.getElementById('config-grid');
            // Config servers form their own replica set (CSRS)
            const healthyConfigs = state.configServers.filter(c => c.status === 'healthy');
            const hasPrimary = state.configServers.some(c => c.role === 'primary' && c.status === 'healthy');
            
            grid.innerHTML = state.configServers.map(c => {
                const region = REGIONS[c.region];
                const isDown = c.status === 'down';
                const isPrimary = c.role === 'primary' && c.status === 'healthy';
                return `
                    <div class="config-node ${isDown ? 'down' : ''} ${isPrimary ? 'primary' : ''}">
                        <span class="config-icon">‚öôÔ∏è</span>
                        <div>
                            <div class="config-info">${c.name}</div>
                            <div class="config-region">${region.icon} ${region.name}</div>
                        </div>
                        <span class="config-role">${isDown ? 'DOWN' : (isPrimary ? 'PRIMARY' : 'SECONDARY')}</span>
                    </div>
                `;
            }).join('');
        }

        function renderFutureAppLayer() {
            const shard1 = state.shards.find(s => s.id === 'shard1');
            const shard2 = state.shards.find(s => s.id === 'shard2');
            
            const vaUp = state.regionStatus.virginia !== 'down';
            const ohUp = state.regionStatus.ohio !== 'down';
            
            const shard1Primary = shard1.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
            const shard2Primary = shard2.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
            const shard1HasMajority = hasMajority(shard1);
            const shard2HasMajority = hasMajority(shard2);
            
            // Virginia Main (Shard 1 Apps) - hosted in Virginia
            const vaMainEl = document.getElementById('future-va-main');
            if (vaMainEl) {
                if (!vaUp) {
                    updateSideAppNode(vaMainEl, 'down', '‚ùå Down', '‚úï VA down');
                } else if (!shard1Primary || !shard1HasMajority) {
                    updateSideAppNode(vaMainEl, 'degraded', '‚ö†Ô∏è Read Only', 'mongos-va ‚Üí Shard 1');
                } else {
                    updateSideAppNode(vaMainEl, 'active', '‚úì Active', 'mongos-va ‚Üí Shard 1');
                }
            }
            
            // Ohio Failover (for Shard 2) - hosted in Virginia
            const ohFailoverEl = document.getElementById('future-oh-failover');
            if (ohFailoverEl) {
                if (!vaUp) {
                    updateSideAppNode(ohFailoverEl, 'down', '‚ùå Down', '‚úï VA down');
                } else if (!ohUp) {
                    if (!shard2Primary || !shard2HasMajority) {
                        updateSideAppNode(ohFailoverEl, 'degraded', '‚ö†Ô∏è Read Only', 'mongos-va ‚Üí Shard 2');
                    } else {
                        updateSideAppNode(ohFailoverEl, 'active', '‚úì Active', 'mongos-va ‚Üí Shard 2');
                    }
                } else {
                    updateSideAppNode(ohFailoverEl, 'standby', '‚è∏ Standby', 'mongos-va ‚Üí Shard 2');
                }
            }
            
            // Ohio Main (Shard 2 Apps) - hosted in Ohio
            const ohMainEl = document.getElementById('future-oh-main');
            if (ohMainEl) {
                if (!ohUp) {
                    updateSideAppNode(ohMainEl, 'down', '‚ùå Down', '‚úï OH down');
                } else if (!shard2Primary || !shard2HasMajority) {
                    updateSideAppNode(ohMainEl, 'degraded', '‚ö†Ô∏è Read Only', 'mongos-oh ‚Üí Shard 2');
                } else {
                    updateSideAppNode(ohMainEl, 'active', '‚úì Active', 'mongos-oh ‚Üí Shard 2');
                }
            }
            
            // Virginia Failover (for Shard 1) - hosted in Ohio
            const vaFailoverEl = document.getElementById('future-va-failover');
            if (vaFailoverEl) {
                if (!ohUp) {
                    updateSideAppNode(vaFailoverEl, 'down', '‚ùå Down', '‚úï OH down');
                } else if (!vaUp) {
                    if (!shard1Primary || !shard1HasMajority) {
                        updateSideAppNode(vaFailoverEl, 'degraded', '‚ö†Ô∏è Read Only', 'mongos-oh ‚Üí Shard 1');
                    } else {
                        updateSideAppNode(vaFailoverEl, 'active', '‚úì Active', 'mongos-oh ‚Üí Shard 1');
                    }
                } else {
                    updateSideAppNode(vaFailoverEl, 'standby', '‚è∏ Standby', 'mongos-oh ‚Üí Shard 1');
                }
            }
        }
        
        function updateSideAppNode(el, statusClass, statusText, targetText) {
            el.className = `side-app-node ${statusClass}`;
            el.querySelector('.side-app-status').textContent = statusText;
            el.querySelector('.side-app-target').textContent = targetText;
        }

        function renderShards() {
            const container = document.getElementById('shards-container');
            container.innerHTML = state.shards.map(shard => {
                const healthyCount = getHealthyNodes(shard).length;
                const hasPrimary = shard.nodes.some(n => n.role === 'primary' && n.status === 'healthy');
                const statusClass = healthyCount === 5 && hasPrimary ? 'healthy' : 
                                   hasPrimary && hasMajority(shard) ? 'degraded' : 'critical';
                const statusText = healthyCount === 5 && hasPrimary ? '‚úì Healthy' :
                                  hasPrimary ? `${healthyCount}/5 nodes` : '‚ö†Ô∏è No Primary';

                const regionGroups = {};
                shard.nodes.forEach(n => {
                    if (!regionGroups[n.region]) regionGroups[n.region] = [];
                    regionGroups[n.region].push(n);
                });

                const preferredRegion = REGIONS[shard.preferredRegion];
                const currentPrimary = shard.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
                const primaryRegion = currentPrimary ? REGIONS[currentPrimary.region] : null;
                const isPrimaryInPreferred = currentPrimary && currentPrimary.region === shard.preferredRegion;
                
                return `
                    <div class="shard-panel">
                        <div class="shard-header">
                            <div class="shard-icon">üì¶</div>
                            <div class="shard-title">${shard.name}</div>
                            <div class="shard-config">2-2-1</div>
                            <span class="shard-status ${statusClass}">${statusText}</span>
                        </div>
                        <div style="padding: 6px 15px; background: rgba(0,0,0,0.2); font-size: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <span style="color: rgba(255,255,255,0.5);">Preferred Primary:</span> 
                            <span style="color: ${preferredRegion.color};">${preferredRegion.icon} ${preferredRegion.name}</span>
                            ${currentPrimary ? `<span style="margin-left: 10px; color: rgba(255,255,255,0.5);">Current:</span> <span style="color: ${primaryRegion.color};">${primaryRegion.icon} ${primaryRegion.name}</span>` : ''}
                            ${currentPrimary && !isPrimaryInPreferred ? '<span style="margin-left: 8px; color: var(--warning-color);">‚ö†Ô∏è Failover active</span>' : ''}
                        </div>
                        <div class="shard-body">
                            ${Object.entries(regionGroups).map(([region, nodes]) => {
                                const r = REGIONS[region];
                                const isDown = state.regionStatus[region] === 'down';
                                return `
                                    <div class="region-row ${region} ${isDown ? 'down' : ''}">
                                        <div class="region-label">
                                            <div class="region-name">${r.icon} ${r.name}</div>
                                            <div class="region-latency">${r.latency}</div>
                                        </div>
                                        <div class="region-nodes">
                                            ${nodes.map(n => renderNodeCard(n, shard.id)).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderNodeCard(node, shardId) {
            const roleClass = node.status === 'down' ? 'down' : 
                             node.status === 'recovering' ? 'recovering' :
                             node.priority === 0 ? 'priority-zero' : node.role;
            const roleLabel = node.status === 'down' ? 'DOWN' : 
                             node.status === 'recovering' ? 'SYNC' :
                             node.priority === 0 ? 'P:0' : node.role.toUpperCase();
            const icon = node.role === 'primary' ? 'üëë' : node.priority === 0 ? 'üõ°Ô∏è' : 'üìö';
            
            // Priority color: higher priority = more prominent color
            const priorityColor = node.priority === 0 ? 'rgba(255,255,255,0.3)' : 
                                 node.priority >= 3 ? 'var(--mongo-green)' :
                                 node.priority >= 2 ? 'var(--zoom-blue)' : 'rgba(255,255,255,0.5)';

            return `
                <div class="node-card ${roleClass}" id="node-${node.id}" onclick="toggleNode('${shardId}', '${node.id}')">
                    <div class="node-header">
                        <span class="node-icon">${icon}</span>
                        <span class="node-name">${node.name.split('-').slice(-2).join('-')}</span>
                        <span class="node-role">${roleLabel}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem;">
                        <span class="node-oplog">oplog: ${node.oplogCount}</span>
                        <span style="color: ${priorityColor}; font-weight: 600;">priority: ${node.priority}</span>
                    </div>
                </div>
            `;
        }

        function updateClusterStatus() {
            const allHealthy = state.shards.every(s => getHealthyNodes(s).length === 5 && s.nodes.some(n => n.role === 'primary' && n.status === 'healthy'));
            const anyPrimary = state.shards.every(s => s.nodes.some(n => n.role === 'primary' && n.status === 'healthy'));
            const anyMajority = state.shards.every(s => hasMajority(s));

            const statusEl = document.getElementById('cluster-status');
            const statusText = document.getElementById('status-text');
            
            statusEl.classList.remove('healthy', 'degraded', 'critical');
            
            if (allHealthy) {
                statusEl.classList.add('healthy');
                statusText.textContent = 'Healthy';
            } else if (anyPrimary && anyMajority) {
                statusEl.classList.add('degraded');
                statusText.textContent = 'Degraded';
            } else {
                statusEl.classList.add('critical');
                statusText.textContent = anyMajority ? 'No Primary' : 'No Majority';
            }
        }

        function updateRegionButtons() {
            document.getElementById('region-buttons').innerHTML = Object.entries(REGIONS).map(([key, r]) => {
                const isDown = state.regionStatus[key] === 'down';
                return `<button class="region-btn ${key}" onclick="toggleRegion('${key}')">${isDown ? '‚úì Restore' : 'üí• Kill'} ${r.name}</button>`;
            }).join('');
        }

        // ============ NODE/REGION CONTROL ============
        function toggleNode(shardId, nodeId) {
            const shard = state.shards.find(s => s.id === shardId);
            const node = shard.nodes.find(n => n.id === nodeId);
            
            if (node.status === 'down') {
                node.status = 'recovering';
                renderShards();
                renderFutureAppLayer();
                log(`${node.name} recovering...`, 'warning');
                
                setTimeout(() => {
                    node.status = 'healthy';
                    renderShards();
                    renderFutureAppLayer();
                    updateClusterStatus();
                    log(`${node.name} is healthy (priority ${node.priority})`, 'success');
                    
                    // Only auto-elect if there's NO primary at all
                    // Higher priority nodes returning do NOT auto-trigger election (MongoDB behavior)
                    if (!shard.nodes.some(n => n.role === 'primary' && n.status === 'healthy') && hasMajority(shard)) {
                        triggerElection(shard);
                    } else {
                        // Check if rebalance is needed
                        const currentPrimary = shard.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
                        if (currentPrimary && node.priority > currentPrimary.priority) {
                            log(`‚ö†Ô∏è ${node.name} has higher priority (${node.priority}) than current primary (${currentPrimary.priority})`, 'warning');
                            log(`‚Üí Manual rebalance required: rs.stepDown()`, 'info');
                        }
                    }
                    updateRebalanceStatus();
                }, 2000);
            } else {
                const wasPrimary = node.role === 'primary';
                node.status = 'down';
                node.role = 'secondary';
                node.oplogCount = 0;
                renderShards();
                renderFutureAppLayer();
                updateClusterStatus();
                log(`${node.name} is DOWN`, 'error');
                
                if (wasPrimary) {
                    triggerElection(shard);
                }
                
                // Check if current primary lost majority
                const primary = shard.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
                if (primary && !hasMajority(shard)) {
                    log(`${primary.name} stepping down: lost majority`, 'warning');
                    primary.role = 'secondary';
                    renderShards();
                    updateClusterStatus();
                }
                updateRebalanceStatus();
            }
        }

        function toggleRegion(regionKey) {
            const isDown = state.regionStatus[regionKey] === 'down';
            
            if (isDown) {
                state.regionStatus[regionKey] = 'healthy';
                state.mongos.filter(m => m.region === regionKey).forEach(m => m.status = 'healthy');
                
                // Restore config server in this region
                state.configServers.filter(c => c.region === regionKey).forEach(c => {
                    c.status = 'healthy';
                });
                // Elect config server primary if needed
                if (!state.configServers.some(c => c.role === 'primary' && c.status === 'healthy')) {
                    const healthyConfig = state.configServers.find(c => c.status === 'healthy');
                    if (healthyConfig) {
                        healthyConfig.role = 'primary';
                        log(`Config server ${healthyConfig.name} elected PRIMARY`, 'success');
                    }
                }
                
                state.shards.forEach(shard => {
                    shard.nodes.filter(n => n.region === regionKey).forEach(n => {
                        n.status = 'recovering';
                    });
                });
                
                log(`${REGIONS[regionKey].name} coming back online...`, 'warning');
                renderMongos();
                renderConfigServers();
                renderFutureAppLayer();
                renderShards();
                updateRegionButtons();
                
                setTimeout(() => {
                    state.shards.forEach(shard => {
                        const restoredNodes = shard.nodes.filter(n => n.region === regionKey);
                        restoredNodes.forEach(n => {
                            n.status = 'healthy';
                        });
                        
                        const currentPrimary = shard.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
                        
                        // Only auto-elect if there's NO primary at all
                        if (!currentPrimary && hasMajority(shard)) {
                            triggerElection(shard);
                        } else if (currentPrimary) {
                            // Check if any restored node has higher priority
                            const higherPriorityRestored = restoredNodes.find(n => n.priority > currentPrimary.priority);
                            if (higherPriorityRestored) {
                                log(`‚ö†Ô∏è ${shard.name}: ${higherPriorityRestored.name} (p:${higherPriorityRestored.priority}) > current primary (p:${currentPrimary.priority})`, 'warning');
                                log(`‚Üí ${shard.name}: Manual rebalance required`, 'info');
                            }
                        }
                    });
                    
                    log(`${REGIONS[regionKey].name} restored`, 'success');
                    renderShards();
                    renderFutureAppLayer();
                    updateClusterStatus();
                    updateRebalanceStatus();
                }, 2000);
            } else {
                state.regionStatus[regionKey] = 'down';
                state.mongos.filter(m => m.region === regionKey).forEach(m => m.status = 'down');
                
                // Config server in this region goes down
                const configInRegion = state.configServers.find(c => c.region === regionKey);
                if (configInRegion) {
                    const wasPrimary = configInRegion.role === 'primary';
                    configInRegion.status = 'down';
                    configInRegion.role = 'secondary';
                    
                    if (wasPrimary) {
                        // Elect new config primary from healthy configs
                        const newConfigPrimary = state.configServers.find(c => c.status === 'healthy');
                        if (newConfigPrimary) {
                            newConfigPrimary.role = 'primary';
                            log(`Config server ${newConfigPrimary.name} elected PRIMARY`, 'success');
                        }
                    }
                }
                
                const affectedShards = [];
                state.shards.forEach(shard => {
                    const regionNodes = shard.nodes.filter(n => n.region === regionKey);
                    const hadPrimary = regionNodes.some(n => n.role === 'primary');
                    
                    regionNodes.forEach(n => {
                        n.status = 'down';
                        n.role = 'secondary';
                        n.oplogCount = 0;
                    });
                    
                    if (hadPrimary) affectedShards.push(shard);
                    
                    const primary = shard.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
                    if (primary && !hasMajority(shard)) {
                        log(`${primary.name} stepping down: lost majority`, 'warning');
                        primary.role = 'secondary';
                    }
                });
                
                log(`‚ö†Ô∏è ${REGIONS[regionKey].name} FAILED`, 'error');
                renderMongos();
                renderConfigServers();
                renderFutureAppLayer();
                renderShards();
                updateRegionButtons();
                updateClusterStatus();
                updateRebalanceStatus();
                
                affectedShards.forEach(shard => triggerElection(shard));
            }
        }

        function killRandomPrimary() {
            // Get all shards that have a healthy primary
            const shardsWithPrimary = state.shards.filter(s => 
                s.nodes.some(n => n.role === 'primary' && n.status === 'healthy')
            );
            
            if (shardsWithPrimary.length === 0) {
                log('No healthy primary to kill', 'warning');
                return;
            }
            
            // Randomly select one of the shards with a primary
            const randomIndex = Math.floor(Math.random() * shardsWithPrimary.length);
            const shard = shardsWithPrimary[randomIndex];
            const primary = shard.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
            
            log(`Killing ${shard.name} primary: ${primary.name} (${REGIONS[primary.region].name})`, 'warning');
            toggleNode(shard.id, primary.id);
        }

        function resetCluster() {
            Object.keys(state.regionStatus).forEach(k => state.regionStatus[k] = 'healthy');
            state.mongos.forEach(m => m.status = 'healthy');
            
            // Reset config servers (Virginia is primary)
            state.configServers.forEach((c, i) => {
                c.status = 'healthy';
                c.role = i === 0 ? 'primary' : 'secondary';
            });
            
            // Reset shards with correct primaries based on preferred region
            state.shards.forEach(shard => {
                shard.nodes.forEach(n => {
                    n.status = 'healthy';
                    n.oplogCount = 0;
                    n.role = 'secondary';
                });
                // Set primary in preferred region (highest priority node there)
                const preferredNodes = shard.nodes.filter(n => n.region === shard.preferredRegion && n.priority > 0);
                if (preferredNodes.length > 0) {
                    const primaryNode = preferredNodes.sort((a, b) => b.priority - a.priority)[0];
                    primaryNode.role = 'primary';
                }
            });
            
            renderMongos();
            renderConfigServers();
            renderFutureAppLayer();
            renderShards();
            updateRegionButtons();
            updateClusterStatus();
            updateRebalanceStatus();
            document.getElementById('event-log').innerHTML = '';
            log('Cluster reset to healthy state', 'success');
            log('Shard 1 PRIMARY ‚Üí Virginia, Shard 2 PRIMARY ‚Üí Ohio', 'info');
            log('Virginia apps ‚Üí Shard 1, Ohio apps ‚Üí Shard 2', 'info');
        }

        // ============ REBALANCE PRIMARIES ============
        function getShardsNeedingRebalance() {
            return state.shards.filter(shard => {
                const currentPrimary = shard.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
                if (!currentPrimary) return false;
                
                // Find the highest priority healthy node that can become primary (priority > 0)
                const eligibleNodes = shard.nodes.filter(n => n.status === 'healthy' && n.priority > 0);
                if (eligibleNodes.length === 0) return false;
                
                const highestPriorityNode = eligibleNodes.sort((a, b) => b.priority - a.priority)[0];
                
                // Rebalance needed if current primary is NOT the highest priority available node
                return highestPriorityNode.id !== currentPrimary.id;
            });
        }

        function updateRebalanceStatus() {
            const shardsToRebalance = getShardsNeedingRebalance();
            const statusEl = document.getElementById('rebalance-status');
            const btnEl = document.getElementById('rebalance-btn');
            
            if (shardsToRebalance.length > 0) {
                const shardNames = shardsToRebalance.map(s => s.name).join(', ');
                statusEl.innerHTML = `<span style="color: var(--warning-color);">‚ö†Ô∏è ${shardNames} can be rebalanced</span>`;
                btnEl.disabled = false;
                btnEl.style.opacity = '1';
            } else {
                statusEl.innerHTML = `<span style="color: var(--mongo-green);">‚úì All primaries optimal</span>`;
                btnEl.disabled = true;
                btnEl.style.opacity = '0.5';
            }
        }

        async function rebalancePrimaries() {
            const shardsToRebalance = getShardsNeedingRebalance();
            
            if (shardsToRebalance.length === 0) {
                log('All primaries are already in optimal positions', 'info');
                return;
            }

            for (const shard of shardsToRebalance) {
                const currentPrimary = shard.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
                const targetPrimary = shard.nodes
                    .filter(n => n.status === 'healthy' && n.priority > 0)
                    .sort((a, b) => b.priority - a.priority)[0];

                if (!currentPrimary || !targetPrimary || currentPrimary.id === targetPrimary.id) continue;

                // Step 1: Check replication lag
                log(`${shard.name}: Checking replication status...`, 'info');
                log(`> rs.printSlaveReplicationInfo()`, 'info');
                await sleep(800);
                
                // Simulate replication lag check
                const lagSeconds = Math.floor(Math.random() * 3); // 0-2 seconds
                log(`${shard.name}: ${targetPrimary.name} is ${lagSeconds} seconds behind primary`, lagSeconds === 0 ? 'success' : 'warning');
                
                if (lagSeconds > 0) {
                    log(`${shard.name}: Waiting for replication to catch up...`, 'warning');
                    await sleep(1500);
                    log(`${shard.name}: ${targetPrimary.name} is 0 seconds behind primary ‚úì`, 'success');
                }
                
                await sleep(500);
                
                // Step 2: Step down current primary
                log(`${shard.name}: Stepping down current primary...`, 'info');
                log(`> rs.stepDown()`, 'info');
                await sleep(600);
                
                currentPrimary.role = 'secondary';
                renderShards();
                renderFutureAppLayer();
                log(`${shard.name}: ${currentPrimary.name} stepped down`, 'warning');
                
                await sleep(400);
                
                // Step 3: Election happens, highest priority wins
                log(`${shard.name}: Election triggered...`, 'info');
                await sleep(800);
                
                targetPrimary.role = 'primary';
                const region = REGIONS[targetPrimary.region];
                renderShards();
                renderFutureAppLayer();
                updateClusterStatus();
                
                log(`${shard.name}: ${targetPrimary.name} elected PRIMARY (${region.name}, priority ${targetPrimary.priority}) ‚úì`, 'success');
                
                await sleep(300);
            }
            
            updateRebalanceStatus();
            log('Rebalance complete! All primaries in optimal positions.', 'success');
        }

        // ============ ELECTION ============
        function triggerElection(shard) {
            if (state.isElecting[shard.id]) return;
            state.isElecting[shard.id] = true;
            
            const majorityRequired = getMajorityRequired(shard);
            const healthyNodes = getHealthyNodes(shard);
            const eligibleCandidates = healthyNodes.filter(n => n.priority > 0);
            
            const modal = document.getElementById('election-modal');
            const progressBar = document.getElementById('election-progress');
            const electionStatus = document.getElementById('election-status');
            const electionText = document.getElementById('election-text');
            const modalTitle = modal.querySelector('.modal-title');
            const modalIcon = modal.querySelector('.modal-icon');
            
            modal.classList.add('visible');
            electionText.textContent = `${shard.name}: Primary is down. Initiating automatic failover...`;
            
            if (healthyNodes.length < majorityRequired) {
                modalIcon.textContent = '‚ö†Ô∏è';
                modalTitle.textContent = 'Election Failed';
                electionText.innerHTML = `<strong style="color: var(--danger-color);">${shard.name}: No majority!</strong><br>Healthy: ${healthyNodes.length}, Required: ${majorityRequired}`;
                progressBar.style.width = '100%';
                progressBar.style.background = 'var(--danger-color)';
                electionStatus.textContent = 'Shard is READ-ONLY';
                
                log(`${shard.name} election FAILED: no majority (${healthyNodes.length}/${majorityRequired})`, 'error');
                
                setTimeout(() => {
                    modal.classList.remove('visible');
                    state.isElecting[shard.id] = false;
                    progressBar.style.width = '0%';
                    progressBar.style.background = 'var(--mongo-green)';
                    modalIcon.textContent = 'üó≥Ô∏è';
                    modalTitle.textContent = 'Election in Progress';
                }, 3000);
                return;
            }
            
            if (eligibleCandidates.length === 0) {
                modalIcon.textContent = '‚ö†Ô∏è';
                modalTitle.textContent = 'Election Failed';
                electionText.innerHTML = `<strong style="color: var(--danger-color);">${shard.name}: No eligible candidates!</strong><br>Only Priority 0 nodes available`;
                progressBar.style.width = '100%';
                progressBar.style.background = 'var(--danger-color)';
                electionStatus.textContent = 'Priority 0 nodes cannot become primary';
                
                log(`${shard.name} election FAILED: only P:0 nodes available`, 'error');
                
                setTimeout(() => {
                    modal.classList.remove('visible');
                    state.isElecting[shard.id] = false;
                    progressBar.style.width = '0%';
                    progressBar.style.background = 'var(--mongo-green)';
                    modalIcon.textContent = 'üó≥Ô∏è';
                    modalTitle.textContent = 'Election in Progress';
                }, 3000);
                return;
            }
            
            // Sort candidates by priority (highest first)
            const sortedCandidates = eligibleCandidates.sort((a, b) => b.priority - a.priority);
            const newPrimary = sortedCandidates[0];
            const candidateList = sortedCandidates.map(c => `${c.name.split('-').slice(-2).join('-')} (p:${c.priority})`).join(', ');
            
            const steps = [
                { progress: 20, text: 'Detecting primary failure...' },
                { progress: 40, text: `Checking quorum: ${healthyNodes.length}/${majorityRequired} ‚úì` },
                { progress: 50, text: `Eligible candidates: ${candidateList}` },
                { progress: 70, text: `Highest priority: ${newPrimary.name.split('-').slice(-2).join('-')} (priority ${newPrimary.priority})` },
                { progress: 85, text: 'Votes collected, majority achieved!' },
                { progress: 100, text: `${newPrimary.name.split('-').slice(-2).join('-')} elected PRIMARY!` }
            ];

            let stepIndex = 0;
            const stepInterval = setInterval(() => {
                if (stepIndex < steps.length) {
                    progressBar.style.width = `${steps[stepIndex].progress}%`;
                    electionStatus.textContent = steps[stepIndex].text;
                    stepIndex++;
                } else {
                    clearInterval(stepInterval);
                    
                    newPrimary.role = 'primary';
                    
                    const region = REGIONS[newPrimary.region];
                    log(`${shard.name}: ${newPrimary.name} elected PRIMARY (${region.name}, priority ${newPrimary.priority})`, 'success');
                    
                    setTimeout(() => {
                        modal.classList.remove('visible');
                        state.isElecting[shard.id] = false;
                        renderShards();
                        renderFutureAppLayer();
                        updateClusterStatus();
                        updateRebalanceStatus();
                        progressBar.style.width = '0%';
                    }, 800);
                }
            }, 350);
        }

        // ============ WRITE SIMULATION ============
        async function simulateWrite(operation) {
            // Get app source selection
            const appSource = document.getElementById('app-source-select').value;
            
            // Determine target shard based on app source
            let targetShard, appElId, mongosRegion;
            
            if (appSource === 'virginia') {
                targetShard = state.shards.find(s => s.id === 'shard1');
                appElId = state.regionStatus.virginia !== 'down' ? 'future-va-main' : 'future-va-failover';
                mongosRegion = state.regionStatus.virginia !== 'down' ? 'virginia' : 'ohio';
            } else if (appSource === 'ohio') {
                targetShard = state.shards.find(s => s.id === 'shard2');
                appElId = state.regionStatus.ohio !== 'down' ? 'future-oh-main' : 'future-oh-failover';
                mongosRegion = state.regionStatus.ohio !== 'down' ? 'ohio' : 'virginia';
            } else {
                // Auto: random shard
                targetShard = state.shards[Math.floor(Math.random() * state.shards.length)];
                appElId = targetShard.id === 'shard1' ? 
                    (state.regionStatus.virginia !== 'down' ? 'future-va-main' : 'future-va-failover') :
                    (state.regionStatus.ohio !== 'down' ? 'future-oh-main' : 'future-oh-failover');
                mongosRegion = targetShard.id === 'shard1' ?
                    (state.regionStatus.virginia !== 'down' ? 'virginia' : 'ohio') :
                    (state.regionStatus.ohio !== 'down' ? 'ohio' : 'virginia');
            }
            
            const activeMongos = state.mongos.find(m => m.region === mongosRegion && state.regionStatus[m.region] === 'healthy');
            if (!activeMongos) {
                log('WRITE FAILED: No mongos available', 'error');
                return;
            }

            const primary = targetShard.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
            
            if (!primary) {
                log(`${operation.toUpperCase()} FAILED: No primary on ${targetShard.name}`, 'error');
                return;
            }

            const secondaries = targetShard.nodes.filter(n => n.role === 'secondary' && n.status === 'healthy');
            const majorityNeeded = getMajorityRequired(targetShard);
            const wcRequired = state.writeConcern === 'majority' ? majorityNeeded : 
                              state.writeConcern === '1' ? 1 : targetShard.nodes.length;

            // w:all check - if ANY node in the shard is down, write will timeout
            if (state.writeConcern === 'all') {
                const downNodes = targetShard.nodes.filter(n => n.status !== 'healthy');
                if (downNodes.length > 0) {
                    const downNames = downNodes.map(n => n.name.split('-').slice(-2).join('-')).join(', ');
                    log(`${operation.toUpperCase()} TIMEOUT: w:all requires all ${targetShard.nodes.length} nodes on ${targetShard.name}`, 'error');
                    log(`‚è≥ Waiting indefinitely for: ${downNames}`, 'error');
                    log(`üí° Reduce write concern or restore nodes to proceed`, 'warning');
                    
                    showWriteFlowPanel(operation, targetShard, primary, secondaries, wcRequired);
                    updateFlowStep(1, true);
                    await sleep(300);
                    updateFlowStep(1, false, true);
                    updateFlowStep(2, true);
                    await sleep(500);
                    showWriteResult(false, `‚úó TIMEOUT: Waiting for ${downNames} (w:all needs all ${targetShard.nodes.length} nodes)`);
                    return;
                }
            }

            const appEl = document.getElementById(appElId);

            showWriteFlowPanel(operation, targetShard, primary, secondaries, wcRequired);
            
            log(`${operation.toUpperCase()} ‚Üí ${targetShard.name} via ${activeMongos.id}`, 'info');

            // Get the specific mongos element for this region
            const mongosEl = document.getElementById(`mongos-${mongosRegion}`);

            // Step 1: App ‚Üí mongos (animate particle)
            updateFlowStep(1, true);
            if (appEl && mongosEl) {
                await animateParticle(appEl, mongosEl, 'write', 300);
            }
            updateFlowStep(1, false, true);

            // Step 2: mongos ‚Üí primary (animate particle)
            updateFlowStep(2, true);
            const primaryEl = document.getElementById(`node-${primary.id}`);
            if (mongosEl && primaryEl) {
                await animateParticle(mongosEl, primaryEl, 'write', 350);
            }
            if (primaryEl) {
                primaryEl.classList.add('receiving');
                setTimeout(() => primaryEl.classList.remove('receiving'), 500);
            }
            primary.oplogCount++;
            renderShards();
            await sleep(200);
            updateFlowStep(2, false, true);

            let ackCount = 1;

            // Step 3: Oplog
            updateFlowStep(3, true);
            await sleep(200);
            updateFlowStep(3, false, true);

            // Step 4: Replicate
            updateFlowStep(4, true);

            if (state.writeConcern === '1') {
                updateFlowStep(4, false, true);
                updateFlowStep(5, true);
                await sleep(200);
                updateFlowStep(5, false, true);
                log(`${operation.toUpperCase()} acknowledged (w:1 = primary only)`, 'success');
                showWriteResult(true, `‚úì Acknowledged: 1/${targetShard.nodes.length} (primary only)`);
                
                // Background replication
                secondaries.forEach((sec, i) => {
                    setTimeout(() => {
                        if (sec.status === 'healthy') {
                            sec.oplogCount++;
                            const el = document.getElementById(`node-${sec.id}`);
                            if (el) {
                                el.classList.add('receiving');
                                setTimeout(() => el.classList.remove('receiving'), 500);
                            }
                            renderShards();
                        }
                    }, 100 + i * 100);
                });
                return;
            }

            let majorityReached = false;
            for (let i = 0; i < secondaries.length; i++) {
                const sec = secondaries[i];
                await sleep(120);
                
                if (sec.status !== 'healthy') continue;
                
                sec.oplogCount++;
                const el = document.getElementById(`node-${sec.id}`);
                if (el) {
                    el.classList.add('receiving');
                    setTimeout(() => el.classList.remove('receiving'), 500);
                }
                renderShards();
                ackCount++;

                if (ackCount >= wcRequired && !majorityReached) {
                    majorityReached = true;
                    updateFlowStep(4, false, true);
                    updateFlowStep(5, true);
                    
                    if (el) {
                        el.classList.add('acknowledged');
                        setTimeout(() => el.classList.remove('acknowledged'), 1500);
                    }
                    
                    await sleep(200);
                    updateFlowStep(5, false, true);
                    
                    const wcName = state.writeConcern === 'majority' ? 'majority' : 'all';
                    log(`${operation.toUpperCase()} acknowledged (w:${wcName} = ${wcRequired} acks)`, 'success');
                    showWriteResult(true, `‚úì Acknowledged: ${ackCount}/${targetShard.nodes.length} (${wcName})`);
                }
            }
        }

        function showWriteFlowPanel(operation, shard, primary, secondaries, wcRequired) {
            const panel = document.getElementById('write-flow-panel');
            const wcLabel = document.getElementById('flow-wc');
            const stepsContainer = document.getElementById('write-flow-steps');
            const resultEl = document.getElementById('write-flow-result');
            
            wcLabel.textContent = `w:${state.writeConcern}`;
            resultEl.className = 'write-flow-result';
            resultEl.style.display = 'none';

            const step4Label = state.writeConcern === '1' ? 'Background Replication' : 
                              state.writeConcern === 'majority' ? 'Replicate (wait for majority)' : 'Replicate (wait for all)';
            
            stepsContainer.innerHTML = `
                <div class="write-flow-step" id="step-1">
                    <span class="step-icon">üìù</span>
                    <div>
                        <div class="step-label">Client ‚Üí mongos</div>
                        <div class="step-detail">${operation.toUpperCase()}</div>
                    </div>
                </div>
                <div class="write-flow-step" id="step-2">
                    <span class="step-icon">üîÄ</span>
                    <div>
                        <div class="step-label">mongos ‚Üí ${shard.name} Primary</div>
                        <div class="step-detail">${primary.name}</div>
                    </div>
                </div>
                <div class="write-flow-step" id="step-3">
                    <span class="step-icon">üìã</span>
                    <div>
                        <div class="step-label">Write to Oplog</div>
                        <div class="step-detail">local.oplog.rs</div>
                    </div>
                </div>
                <div class="write-flow-step" id="step-4">
                    <span class="step-icon">${state.writeConcern === '1' ? 'üí®' : 'üîÑ'}</span>
                    <div>
                        <div class="step-label">${step4Label}</div>
                        <div class="step-detail">${secondaries.length} secondaries</div>
                    </div>
                </div>
                <div class="write-flow-step" id="step-5">
                    <span class="step-icon">‚úÖ</span>
                    <div>
                        <div class="step-label">Acknowledgment</div>
                        <div class="step-detail">w:${state.writeConcern} = ${wcRequired} nodes</div>
                    </div>
                </div>
            `;
            
            panel.classList.add('visible');
        }

        function updateFlowStep(stepNum, active, complete = false) {
            const step = document.getElementById(`step-${stepNum}`);
            if (step) {
                step.classList.remove('active', 'complete');
                if (active) step.classList.add('active');
                if (complete) step.classList.add('complete');
            }
        }

        function showWriteResult(success, message) {
            const resultEl = document.getElementById('write-flow-result');
            resultEl.textContent = message;
            resultEl.className = `write-flow-result ${success ? 'success' : 'failed'}`;
            resultEl.style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('write-flow-panel').classList.remove('visible');
            }, 2000);
        }

        async function simulateRead() {
            // Get selections
            const appSource = document.getElementById('app-source-select').value;
            const readPref = document.getElementById('read-pref-select').value;
            
            // Determine target shard and app based on selection
            let targetShard, appElId, mongosRegion;
            
            if (appSource === 'virginia') {
                targetShard = state.shards.find(s => s.id === 'shard1');
                appElId = state.regionStatus.virginia !== 'down' ? 'future-va-main' : 'future-va-failover';
                mongosRegion = state.regionStatus.virginia !== 'down' ? 'virginia' : 'ohio';
            } else if (appSource === 'ohio') {
                targetShard = state.shards.find(s => s.id === 'shard2');
                appElId = state.regionStatus.ohio !== 'down' ? 'future-oh-main' : 'future-oh-failover';
                mongosRegion = state.regionStatus.ohio !== 'down' ? 'ohio' : 'virginia';
            } else {
                // Auto: random shard
                targetShard = state.shards[Math.floor(Math.random() * state.shards.length)];
                appElId = targetShard.id === 'shard1' ? 
                    (state.regionStatus.virginia !== 'down' ? 'future-va-main' : 'future-va-failover') :
                    (state.regionStatus.ohio !== 'down' ? 'future-oh-main' : 'future-oh-failover');
                mongosRegion = targetShard.id === 'shard1' ?
                    (state.regionStatus.virginia !== 'down' ? 'virginia' : 'ohio') :
                    (state.regionStatus.ohio !== 'down' ? 'ohio' : 'virginia');
            }
            
            const activeMongos = state.mongos.find(m => m.region === mongosRegion && state.regionStatus[m.region] === 'healthy');
            if (!activeMongos) {
                log('READ FAILED: No mongos available', 'error');
                return;
            }

            const healthyNodes = targetShard.nodes.filter(n => n.status === 'healthy');
            
            if (healthyNodes.length === 0) {
                log(`READ FAILED: No healthy nodes on ${targetShard.name}`, 'error');
                return;
            }

            // Select target node based on read preference
            let targetNode;
            const primary = healthyNodes.find(n => n.role === 'primary');
            const secondaries = healthyNodes.filter(n => n.role === 'secondary');
            
            switch (readPref) {
                case 'primary':
                    targetNode = primary;
                    if (!targetNode) {
                        log(`READ FAILED: No primary available (readPreference: primary)`, 'error');
                        return;
                    }
                    break;
                case 'primaryPreferred':
                    targetNode = primary || secondaries[Math.floor(Math.random() * secondaries.length)];
                    break;
                case 'secondary':
                    if (secondaries.length === 0) {
                        log(`READ FAILED: No secondaries available (readPreference: secondary)`, 'error');
                        return;
                    }
                    targetNode = secondaries[Math.floor(Math.random() * secondaries.length)];
                    break;
                case 'secondaryPreferred':
                    targetNode = secondaries.length > 0 ? 
                        secondaries[Math.floor(Math.random() * secondaries.length)] : primary;
                    break;
                case 'nearest':
                    // Prefer nodes in same region as mongos
                    const sameRegionNodes = healthyNodes.filter(n => n.region === mongosRegion);
                    targetNode = sameRegionNodes.length > 0 ?
                        sameRegionNodes[Math.floor(Math.random() * sameRegionNodes.length)] :
                        healthyNodes[Math.floor(Math.random() * healthyNodes.length)];
                    break;
                default:
                    targetNode = healthyNodes[Math.floor(Math.random() * healthyNodes.length)];
            }
            
            const region = REGIONS[targetNode.region];
            const appEl = document.getElementById(appElId);
            // Get the specific mongos element for this region
            const mongosEl = document.getElementById(`mongos-${mongosRegion}`);
            const nodeEl = document.getElementById(`node-${targetNode.id}`);
            
            log(`READ (${readPref}) ‚Üí ${targetShard.name}/${targetNode.name} via ${activeMongos.id}`, 'info');
            
            // Animate: App ‚Üí mongos
            if (appEl && mongosEl) {
                await animateParticle(appEl, mongosEl, 'read', 250);
            }
            
            // Animate: mongos ‚Üí node
            if (mongosEl && nodeEl) {
                await animateParticle(mongosEl, nodeEl, 'read', 300);
            }
            
            // Animate response: node ‚Üí app
            if (nodeEl && appEl) {
                await animateParticle(nodeEl, appEl, 'read', 350);
            }
            
            log(`READ ‚Üê ${targetShard.name}/${targetNode.name} complete`, 'success');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ============ CURRENT STATE FUNCTIONS ============
        function currentLog(message, type = 'info') {
            const eventLog = document.getElementById('current-event-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            entry.innerHTML = `<div class="log-time">${time}</div><div class="log-msg">${message}</div>`;
            eventLog.insertBefore(entry, eventLog.firstChild);
            while (eventLog.children.length > 12) eventLog.removeChild(eventLog.lastChild);
        }

        function renderCurrentNodes(containerId, rs, region) {
            const container = document.getElementById(containerId);
            const hasPrimary = rs.nodes.some(n => n.role === 'primary' && n.status === 'healthy');
            const healthyVoters = rs.nodes.filter(n => n.status === 'healthy' && !n.hidden).length;
            const hasHealthyNodes = rs.nodes.some(n => n.status === 'healthy' && !n.hidden);
            const hasMajority = healthyVoters >= 2; // Need 2 out of 3 voting members
            
            container.innerHTML = rs.nodes.map(node => {
                const isDown = node.status === 'down';
                const isRecovering = node.status === 'recovering';
                const isResyncing = node.status === 'resyncing';
                const isPrimaryNoMajority = node.role === 'primary' && node.status === 'healthy' && !hasMajority;
                
                let roleClass, roleLabel, icon, statusMsg = '';
                
                if (isDown) {
                    roleClass = 'down';
                    roleLabel = '‚ö†Ô∏è DOWN';
                    icon = 'üíÄ';
                    statusMsg = '<div style="font-size: 0.7rem; color: var(--danger-color); margin-top: 4px;">‚ùå Unreachable</div>';
                } else if (isRecovering) {
                    roleClass = 'recovering';
                    roleLabel = 'RECOVERING';
                    icon = 'üîÑ';
                    statusMsg = '<div style="font-size: 0.7rem; color: var(--warning-color); margin-top: 4px;">‚è≥ Starting up...</div>';
                } else if (isResyncing) {
                    roleClass = 'resyncing';
                    roleLabel = 'üîÑ RESYNCING';
                    icon = node.role === 'primary' ? 'üëë' : 'üìö';
                    statusMsg = '<div style="font-size: 0.7rem; color: var(--zoom-blue); margin-top: 4px;">‚è≥ DSP catching up...</div>';
                } else if (node.hidden) {
                    roleClass = 'hidden-node';
                    roleLabel = 'HIDDEN';
                    icon = 'üëÅÔ∏è';
                    statusMsg = '<div style="font-size: 0.65rem; color: #6c757d; margin-top: 4px;">‚ö†Ô∏è Analytics only - can\'t vote</div>';
                } else if (isPrimaryNoMajority) {
                    // Primary that lost majority - stepped down
                    roleClass = 'down';
                    roleLabel = '‚ö†Ô∏è NO MAJORITY';
                    icon = 'üëë';
                    statusMsg = '<div style="font-size: 0.7rem; color: var(--danger-color); margin-top: 4px;">‚ùå Stepped down - no quorum</div>';
                } else if (node.role === 'primary') {
                    roleClass = 'primary';
                    roleLabel = 'PRIMARY';
                    icon = 'üëë';
                } else {
                    roleClass = 'secondary';
                    roleLabel = 'SECONDARY';
                    icon = 'üìö';
                }
                
                return `
                    <div class="node-card ${roleClass}" id="current-node-${node.id}" onclick="currentToggleNode('${rs.id}', '${node.id}')">
                        <div class="node-header">
                            <span class="node-icon">${icon}</span>
                            <span class="node-name">${node.name}</span>
                            <span class="node-role">${roleLabel}</span>
                        </div>
                        <div class="node-oplog">oplog: ${node.oplogCount}</div>
                        ${statusMsg}
                    </div>
                `;
            }).join('');
            
            // Add cluster-level write/read status banner
            const effectiveHasPrimary = hasPrimary && hasMajority;
            updateRSWriteReadStatus(rs.id, effectiveHasPrimary, hasHealthyNodes);
        }
        
        function updateRSWriteReadStatus(rsId, hasPrimary, hasHealthyNodes) {
            const panel = document.getElementById(`${rsId}-panel`);
            if (!panel) return;
            
            // Remove existing status banner if any
            const existingBanner = panel.querySelector('.rs-status-banner');
            if (existingBanner) existingBanner.remove();
            
            // Add status banner after header
            const header = panel.querySelector('.rs-header');
            if (header) {
                let bannerHTML = '';
                if (!hasPrimary && !hasHealthyNodes) {
                    bannerHTML = `
                        <div class="rs-status-banner" style="background: rgba(239, 71, 111, 0.2); padding: 8px 16px; display: flex; gap: 16px; justify-content: center; border-bottom: 1px solid var(--danger-color);">
                            <span style="color: var(--danger-color); font-weight: 600; font-size: 0.85rem;">‚ùå Writes: BLOCKED</span>
                            <span style="color: var(--danger-color); font-weight: 600; font-size: 0.85rem;">‚ùå Reads: UNAVAILABLE</span>
                        </div>
                    `;
                } else if (!hasPrimary) {
                    bannerHTML = `
                        <div class="rs-status-banner" style="background: rgba(255, 159, 28, 0.15); padding: 8px 16px; display: flex; gap: 16px; justify-content: center; border-bottom: 1px solid var(--warning-color);">
                            <span style="color: var(--danger-color); font-weight: 600; font-size: 0.85rem;">‚ùå Writes: BLOCKED</span>
                            <span style="color: var(--warning-color); font-weight: 600; font-size: 0.85rem;">‚ö†Ô∏è Reads: Secondaries Only</span>
                        </div>
                    `;
                }
                
                if (bannerHTML) {
                    header.insertAdjacentHTML('afterend', bannerHTML);
                }
            }
        }

        function renderCurrentState() {
            renderCurrentNodes('virginia-rs-nodes', currentState.virginiaRS, 'virginia');
            renderCurrentNodes('ohio-rs-nodes', currentState.ohioRS, 'ohio');
            renderApplicationLayer();
            updateDSPStatus();
            updateCurrentClusterStatus();
            updateCurrentButtons();
            updateSplitBrainWarning();
            updateCompleteOutageBanner();
        }
        
        function updateCurrentButtons() {
            // Update region buttons
            const regionBtnsContainer = document.getElementById('current-region-buttons');
            if (regionBtnsContainer) {
                const vaDown = currentState.virginiaRS.nodes.every(n => n.status === 'down');
                const ohDown = currentState.ohioRS.nodes.every(n => n.status === 'down');
                
                regionBtnsContainer.innerHTML = `
                    <button class="region-btn virginia" onclick="currentToggleRegion('virginia')">
                        ${vaDown ? '‚úì Restore Virginia' : 'üí• Kill Virginia'}
                    </button>
                    <button class="region-btn ohio" onclick="currentToggleRegion('ohio')">
                        ${ohDown ? '‚úì Restore Ohio' : 'üí• Kill Ohio'}
                    </button>
                `;
            }
            
            // Update DSP button - disable if any region is down (DSP irrelevant)
            const dspBtn = document.getElementById('dsp-toggle-btn');
            if (dspBtn) {
                const vaDown = currentState.virginiaRS.nodes.every(n => n.status === 'down');
                const ohDown = currentState.ohioRS.nodes.every(n => n.status === 'down');
                const anyRegionDown = vaDown || ohDown;
                const anyRecovering = currentState.virginiaRS.nodes.some(n => n.status === 'recovering' || n.status === 'resyncing') ||
                                     currentState.ohioRS.nodes.some(n => n.status === 'recovering' || n.status === 'resyncing');
                
                if (anyRegionDown || anyRecovering) {
                    // Disable button when a region is down or recovering
                    dspBtn.disabled = true;
                    dspBtn.className = 'action-btn secondary';
                    dspBtn.style.opacity = '0.5';
                    dspBtn.style.cursor = 'not-allowed';
                    if (anyRegionDown) {
                        dspBtn.textContent = '‚è∏Ô∏è DSP N/A (region down)';
                    } else {
                        dspBtn.textContent = '‚è≥ DSP Resyncing...';
                    }
                } else if (currentState.dspActive) {
                    dspBtn.disabled = false;
                    dspBtn.style.opacity = '1';
                    dspBtn.style.cursor = 'pointer';
                    dspBtn.textContent = 'üí• Break DSP Sync';
                    dspBtn.className = 'action-btn danger';
                } else {
                    dspBtn.disabled = false;
                    dspBtn.style.opacity = '1';
                    dspBtn.style.cursor = 'pointer';
                    dspBtn.textContent = '‚úì Restore DSP Sync';
                    dspBtn.className = 'action-btn primary';
                }
            }
        }
        
        function updateSplitBrainWarning() {
            const banner = document.getElementById('split-brain-banner');
            if (!banner) return;
            
            // Check for split-brain: DSP down AND both regions FULLY HEALTHY and ACCEPTING WRITES
            // Not split-brain if nodes are recovering/resyncing (apps haven't failed over yet)
            const vaFullyHealthy = currentState.virginiaRS.nodes.some(n => n.status === 'healthy' && n.role === 'primary');
            const ohFullyHealthy = currentState.ohioRS.nodes.some(n => n.status === 'healthy' && n.role === 'primary');
            const vaRecovering = currentState.virginiaRS.nodes.some(n => n.status === 'recovering' || n.status === 'resyncing');
            const ohRecovering = currentState.ohioRS.nodes.some(n => n.status === 'recovering' || n.status === 'resyncing');
            
            // Also check if apps in both regions are actively writing
            const vaAppsActive = currentState.appStatus.vaMain === 'active';
            const ohAppsActive = currentState.appStatus.ohMain === 'active';
            
            // Split-brain only when:
            // 1. DSP is down
            // 2. Both regions have healthy primaries (not recovering/resyncing)
            // 3. Apps in both regions are active (writing to their respective RS)
            const isSplitBrain = !currentState.dspActive && 
                                 vaFullyHealthy && ohFullyHealthy && 
                                 !vaRecovering && !ohRecovering &&
                                 vaAppsActive && ohAppsActive;
            
            if (isSplitBrain) {
                banner.style.display = 'block';
            } else {
                banner.style.display = 'none';
            }
        }
        
        function updateCompleteOutageBanner() {
            const banner = document.getElementById('complete-outage-banner');
            if (!banner) return;
            
            // Complete outage: both regions are down
            const vaDown = currentState.virginiaRS.nodes.every(n => n.status === 'down');
            const ohDown = currentState.ohioRS.nodes.every(n => n.status === 'down');
            const isCompleteOutage = vaDown && ohDown;
            
            if (isCompleteOutage) {
                banner.style.display = 'block';
            } else {
                banner.style.display = 'none';
            }
        }

        function renderApplicationLayer() {
            const apps = currentState.appStatus;
            
            // Check if we're in degraded mode (one region down)
            const virginiaDown = apps.vaMain === 'down';
            const ohioDown = apps.ohMain === 'down';
            const isDegraded = virginiaDown || ohioDown;
            
            // Virginia main apps (hosted in Virginia)
            const vaMain = document.getElementById('va-app-main');
            if (vaMain) {
                vaMain.className = 'app-node';
                if (apps.vaMain === 'down') {
                    vaMain.className += ' down';
                    vaMain.querySelector('.app-node-label').textContent = '‚ùå DISCONNECTED (VA down)';
                } else if (apps.vaMain === 'active') {
                    vaMain.className += ' active';
                    vaMain.querySelector('.app-node-label').textContent = ohioDown ? '‚ö° Writing to Virginia RS (2x load)' : '‚úì Writing to Virginia RS';
                }
            }
            
            // Ohio failover (hosted in Virginia, handles Ohio traffic when Ohio is down)
            const ohFailover = document.getElementById('oh-failover-app');
            if (ohFailover) {
                if (apps.ohFailover === 'active') {
                    ohFailover.className = 'app-node active';
                    ohFailover.querySelector('.app-node-label').textContent = '‚ö° ACTIVE - Handling Ohio traffic';
                } else if (apps.ohFailover === 'down') {
                    ohFailover.className = 'app-node down';
                    ohFailover.querySelector('.app-node-label').textContent = '‚ùå DOWN (VA region down)';
                } else {
                    ohFailover.className = 'app-node failover';
                    ohFailover.querySelector('.app-node-label').textContent = 'Standby for Ohio traffic';
                }
            }
            
            // Ohio main apps (hosted in Ohio)
            const ohMain = document.getElementById('oh-app-main');
            if (ohMain) {
                ohMain.className = 'app-node';
                if (apps.ohMain === 'down') {
                    ohMain.className += ' down';
                    ohMain.querySelector('.app-node-label').textContent = '‚ùå DISCONNECTED (OH down)';
                } else if (apps.ohMain === 'active') {
                    ohMain.className += ' active';
                    ohMain.querySelector('.app-node-label').textContent = virginiaDown ? '‚ö° Writing to Ohio RS (2x load)' : '‚úì Writing to Ohio RS';
                }
            }
            
            // Virginia failover (hosted in Ohio, handles Virginia traffic when Virginia is down)
            const vaFailover = document.getElementById('va-failover-app');
            if (vaFailover) {
                if (apps.vaFailover === 'active') {
                    vaFailover.className = 'app-node active';
                    vaFailover.querySelector('.app-node-label').textContent = '‚ö° ACTIVE - Handling Virginia traffic';
                } else if (apps.vaFailover === 'down') {
                    vaFailover.className = 'app-node down';
                    vaFailover.querySelector('.app-node-label').textContent = '‚ùå DOWN (OH region down)';
                } else {
                    vaFailover.className = 'app-node failover';
                    vaFailover.querySelector('.app-node-label').textContent = 'Standby for Virginia traffic';
                }
            }
            
            // Update traffic status indicator
            const trafficStatus = document.getElementById('traffic-status');
            if (trafficStatus) {
                if (virginiaDown) {
                    trafficStatus.innerHTML = `
                        <div style="font-size: 0.85rem; color: var(--warning-color); font-weight: 600;">‚ö†Ô∏è ALL ‚Üí OHIO</div>
                        <div style="font-size: 0.7rem; color: var(--danger-color);">Virginia traffic rerouted</div>
                    `;
                } else if (ohioDown) {
                    trafficStatus.innerHTML = `
                        <div style="font-size: 0.85rem; color: var(--warning-color); font-weight: 600;">‚ö†Ô∏è ALL ‚Üí VIRGINIA</div>
                        <div style="font-size: 0.7rem; color: var(--danger-color);">Ohio traffic rerouted</div>
                    `;
                } else {
                    trafficStatus.innerHTML = `
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">Normal Operation</div>
                        <div style="font-size: 0.7rem; color: rgba(255,255,255,0.3);">Each region handles its traffic</div>
                    `;
                }
            }
            
            // Update performance degradation banner
            const perfBanner = document.getElementById('perf-degradation-banner');
            if (perfBanner) {
                if (isDegraded) {
                    perfBanner.style.display = 'block';
                    const targetRegion = virginiaDown ? 'Ohio' : 'Virginia';
                    document.getElementById('perf-degradation-msg').textContent = 
                        `All traffic routing to ${targetRegion} - 2x load, increased latency for ${virginiaDown ? 'Virginia' : 'Ohio'} users`;
                } else {
                    perfBanner.style.display = 'none';
                }
            }
        }

        function updateDSPStatus() {
            const dspEl = document.getElementById('dsp-layer');
            const statusEl = document.getElementById('dsp-status');
            const vaToOhEl = document.getElementById('dsp-va-to-oh');
            const ohToVaEl = document.getElementById('dsp-oh-to-va');
            
            // Check which regions are down
            const vaDown = currentState.virginiaRS.nodes.every(n => n.status === 'down');
            const ohDown = currentState.ohioRS.nodes.every(n => n.status === 'down');
            
            // Update individual sync direction statuses
            if (vaToOhEl) {
                if (vaDown || ohDown || !currentState.dspActive) {
                    vaToOhEl.style.color = 'var(--danger-color)';
                    vaToOhEl.textContent = vaDown ? '‚ùå VA down' : ohDown ? '‚ùå OH down' : '‚ùå Broken';
                } else {
                    vaToOhEl.style.color = 'var(--mongo-green)';
                    vaToOhEl.textContent = '‚úì Syncing';
                }
            }
            
            if (ohToVaEl) {
                if (vaDown || ohDown || !currentState.dspActive) {
                    ohToVaEl.style.color = 'var(--danger-color)';
                    ohToVaEl.textContent = ohDown ? '‚ùå OH down' : vaDown ? '‚ùå VA down' : '‚ùå Broken';
                } else {
                    ohToVaEl.style.color = 'var(--mongo-green)';
                    ohToVaEl.textContent = '‚úì Syncing';
                }
            }
            
            // Update overall DSP status
            if (!currentState.dspActive || vaDown || ohDown) {
                dspEl.style.borderColor = 'var(--danger-color)';
                dspEl.style.background = 'rgba(239, 71, 111, 0.2)';
                statusEl.className = 'sync-status lag';
                
                if (vaDown && ohDown) {
                    statusEl.innerHTML = '<span>‚ùå</span> BOTH REGIONS DOWN!';
                } else if (vaDown) {
                    statusEl.innerHTML = '<span>‚ùå</span> VA‚ÜíOH: BROKEN (VA down)';
                } else if (ohDown) {
                    statusEl.innerHTML = '<span>‚ùå</span> OH‚ÜíVA: BROKEN (OH down)';
                } else {
                    statusEl.innerHTML = '<span>‚ùå</span> SYNC BROKEN - Data Loss Risk!';
                }
            } else {
                dspEl.style.borderColor = 'var(--danger-color)';
                dspEl.style.background = 'rgba(239, 71, 111, 0.1)';
                statusEl.className = 'sync-status syncing';
                statusEl.innerHTML = `<span>üîÑ</span> Both directions: ~${currentState.dspLag}s lag`;
            }
        }

        function updateCurrentClusterStatus() {
            const clusterStatus = document.getElementById('cluster-status');
            const statusText = document.getElementById('status-text');
            
            const vaHealthy = currentState.virginiaRS.nodes.filter(n => n.status === 'healthy').length;
            const ohHealthy = currentState.ohioRS.nodes.filter(n => n.status === 'healthy').length;
            const vaPrimary = currentState.virginiaRS.nodes.some(n => n.role === 'primary' && n.status === 'healthy');
            const ohPrimary = currentState.ohioRS.nodes.some(n => n.role === 'primary' && n.status === 'healthy');
            
            clusterStatus.classList.remove('healthy', 'degraded', 'critical');
            
            // Virginia: 4 nodes (3 voting + 1 hidden), Ohio: 3 nodes = 7 total
            if (vaHealthy === 4 && ohHealthy === 3 && currentState.dspActive) {
                clusterStatus.classList.add('degraded'); // Never truly healthy due to DSP
                statusText.textContent = 'DSP Lag';
            } else if (!currentState.dspActive) {
                clusterStatus.classList.add('critical');
                statusText.textContent = 'DSP Down!';
            } else if (!vaPrimary || !ohPrimary) {
                clusterStatus.classList.add('critical');
                statusText.textContent = 'No Primary';
            } else {
                clusterStatus.classList.add('degraded');
                statusText.textContent = `${vaHealthy + ohHealthy}/7 nodes`;
            }
            
            // Update individual RS status
            const vaStatus = document.getElementById('virginia-rs-status');
            const ohStatus = document.getElementById('ohio-rs-status');
            
            // Virginia needs 2 voting members for majority (3 voting members, hidden doesn't vote)
            if (vaStatus) {
                const vaVotingHealthy = currentState.virginiaRS.nodes.filter(n => n.status === 'healthy' && !n.hidden).length;
                vaStatus.className = 'shard-status ' + (vaPrimary && vaVotingHealthy >= 2 ? 'healthy' : 'critical');
                vaStatus.textContent = vaPrimary && vaVotingHealthy >= 2 ? `${vaHealthy}/4 nodes` : '‚ö†Ô∏è No Primary';
            }
            // Ohio needs 2 voting members for majority (3 voting members)
            if (ohStatus) {
                ohStatus.className = 'shard-status ' + (ohPrimary && ohHealthy >= 2 ? 'healthy' : 'critical');
                ohStatus.textContent = ohPrimary && ohHealthy >= 2 ? `${ohHealthy}/3 nodes` : '‚ö†Ô∏è No Primary';
            }
        }

        function currentToggleNode(rsId, nodeId) {
            const rs = rsId === 'virginia-rs' ? currentState.virginiaRS : currentState.ohioRS;
            const node = rs.nodes.find(n => n.id === nodeId);
            const rsName = rsId === 'virginia-rs' ? 'Virginia' : 'Ohio';
            
            if (node.status === 'down') {
                node.status = 'recovering';
                renderCurrentState();
                currentLog(`${node.name} recovering...`, 'warning');
                
                setTimeout(() => {
                    node.status = 'healthy';
                    renderCurrentState();
                    currentLog(`${node.name} is healthy`, 'success');
                    
                    if (!rs.nodes.some(n => n.role === 'primary' && n.status === 'healthy')) {
                        currentTriggerElection(rs);
                    }
                }, 2000);
            } else {
                const wasPrimary = node.role === 'primary';
                node.status = 'down';
                if (!node.hidden) node.role = 'secondary';
                node.oplogCount = 0;
                
                if (wasPrimary) {
                    currentLog(`‚ö†Ô∏è ${rsName} RS: PRIMARY DOWN - Writes BLOCKED!`, 'error');
                }
                currentLog(`${node.name} is DOWN`, 'error');
                
                // Check if current primary lost majority (need 2 out of 3 voting members)
                const healthyVoters = rs.nodes.filter(n => n.status === 'healthy' && !n.hidden).length;
                const currentPrimary = rs.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
                if (currentPrimary && healthyVoters < 2) {
                    currentLog(`‚ö†Ô∏è ${currentPrimary.name} stepping down: lost majority (${healthyVoters}/2 voters)`, 'warning');
                    currentPrimary.role = 'secondary';
                    currentLog(`‚ö†Ô∏è ${rsName} RS: NO PRIMARY - Writes BLOCKED!`, 'error');
                }
                
                renderCurrentState();
                
                if (wasPrimary) {
                    currentTriggerElection(rs);
                }
            }
        }

        function currentToggleRegion(regionKey) {
            const rs = regionKey === 'virginia' ? currentState.virginiaRS : currentState.ohioRS;
            const otherRegion = regionKey === 'virginia' ? 'ohio' : 'virginia';
            const allDown = rs.nodes.every(n => n.status === 'down');
            
            if (allDown) {
                // ========== RESTORE REGION ==========
                // Check if other region is still down
                const otherRS = regionKey === 'virginia' ? currentState.ohioRS : currentState.virginiaRS;
                const otherRegionStillDown = otherRS.nodes.every(n => n.status === 'down');
                
                // Step 1: Nodes come back in recovering state
                rs.nodes.forEach(n => n.status = 'recovering');
                renderCurrentState();
                currentLog(`${REGIONS[regionKey].name} coming back online...`, 'warning');
                currentLog(`‚è≥ Nodes recovering...`, 'info');
                
                // Step 2: After 2s - Elect primary
                setTimeout(() => {
                    rs.nodes.forEach(n => n.status = 'healthy');
                    currentLog(`‚úì ${REGIONS[regionKey].name} nodes healthy`, 'success');
                    
                    // Trigger election in recovered region
                    currentTriggerElection(rs, () => {
                        if (otherRegionStillDown) {
                            // ========== RECOVERING FROM COMPLETE OUTAGE ==========
                            // Other region is still down - activate failover apps for that region
                            if (regionKey === 'virginia') {
                                // Virginia is back, Ohio still down
                                currentState.appStatus.vaMain = 'active';
                                currentState.appStatus.ohFailover = 'active'; // Ohio's failover (hosted in VA) - handles Ohio traffic
                                currentState.appStatus.ohMain = 'down';       // Ohio main still down
                                currentState.appStatus.vaFailover = 'down';   // Virginia failover (hosted in OH) still down
                                
                                currentLog(`‚úì Virginia Apps: ACTIVE`, 'success');
                                currentLog(`‚úì Ohio Failover (in VA): AUTO-ACTIVATED - handling Ohio traffic`, 'success');
                                currentLog(`‚ö†Ô∏è ALL TRAFFIC ‚Üí VIRGINIA (2x load)`, 'warning');
                            } else {
                                // Ohio is back, Virginia still down
                                currentState.appStatus.ohMain = 'active';
                                currentState.appStatus.vaFailover = 'active'; // Virginia's failover (hosted in OH) - handles VA traffic
                                currentState.appStatus.vaMain = 'down';       // Virginia main still down
                                currentState.appStatus.ohFailover = 'down';   // Ohio failover (hosted in VA) still down
                                
                                currentLog(`‚úì Ohio Apps: ACTIVE`, 'success');
                                currentLog(`‚úì Virginia Failover (in OH): AUTO-ACTIVATED - handling VA traffic`, 'success');
                                currentLog(`‚ö†Ô∏è ALL TRAFFIC ‚Üí OHIO (2x load)`, 'warning');
                            }
                            
                            // DSP stays disabled - other region still down
                            currentState.dspActive = false;
                            currentLog(`‚ö†Ô∏è DSP remains disabled - other region still down`, 'warning');
                            currentLog(`‚úì SERVICE PARTIALLY RESTORED`, 'success');
                            renderCurrentState();
                        } else {
                            // ========== NORMAL RECOVERY - Other region is healthy ==========
                            // Step 3: After election - Re-enable DSP sync
                            currentLog(`‚è≥ Re-enabling DSP sync...`, 'info');
                            currentState.dspActive = true;
                            
                            // Step 4: Put nodes in resync status
                            currentLog(`‚è≥ DSP resyncing data between regions (~5s)...`, 'warning');
                            rs.nodes.forEach(n => n.status = 'resyncing');
                            renderCurrentState();
                            
                            // Step 5: After 5s resync - Failover apps back to normal
                            setTimeout(() => {
                                rs.nodes.forEach(n => n.status = 'healthy');
                                
                                // Now restore apps to normal dual-region operation
                                if (regionKey === 'virginia') {
                                    currentState.appStatus.vaMain = 'active';
                                    currentState.appStatus.ohFailover = 'standby';
                                    currentState.appStatus.vaFailover = 'standby';
                                } else {
                                    currentState.appStatus.ohMain = 'active';
                                    currentState.appStatus.vaFailover = 'standby';
                                    currentState.appStatus.ohFailover = 'standby';
                                }
                                
                                renderCurrentState();
                                currentLog(`‚úì DSP resync complete`, 'success');
                                currentLog(`‚úì ${REGIONS[regionKey].name} Apps reconnected`, 'success');
                                currentLog(`‚úì Normal dual-region operation resumed`, 'success');
                            }, 5000);
                        }
                    });
                    
                    renderCurrentState();
                }, 2000);
            } else {
                // ========== KILL REGION ==========
                // First check if other region is already down
                const otherRS = regionKey === 'virginia' ? currentState.ohioRS : currentState.virginiaRS;
                const otherRegionDown = otherRS.nodes.every(n => n.status === 'down');
                
                const hadPrimary = rs.nodes.some(n => n.role === 'primary');
                rs.nodes.forEach(n => {
                    n.status = 'down';
                    if (!n.hidden) n.role = 'secondary';
                    n.oplogCount = 0;
                });
                
                if (otherRegionDown) {
                    // ========== COMPLETE OUTAGE - BOTH REGIONS DOWN ==========
                    currentState.appStatus.vaMain = 'down';
                    currentState.appStatus.ohMain = 'down';
                    currentState.appStatus.vaFailover = 'down';
                    currentState.appStatus.ohFailover = 'down';
                    currentState.dspActive = false;
                    
                    currentLog(`üö®üö®üö® COMPLETE OUTAGE! üö®üö®üö®`, 'error');
                    currentLog(`‚ùå BOTH REGIONS ARE DOWN!`, 'error');
                    currentLog(`‚ùå ALL APPLICATIONS: DOWN`, 'error');
                    currentLog(`‚ùå NO FAILOVER POSSIBLE - No surviving region!`, 'error');
                    currentLog(`üíî SERVICE COMPLETELY UNAVAILABLE`, 'error');
                } else {
                    // Handle app failover to surviving region
                    if (regionKey === 'virginia') {
                        currentState.appStatus.vaMain = 'down';
                        currentState.appStatus.ohFailover = 'down';
                        currentState.appStatus.vaFailover = 'active';
                        // ohMain stays as is (active)
                        
                        currentLog(`üö® VIRGINIA REGION FAILURE!`, 'error');
                        currentLog(`üíî ~30 SECONDS OF DATA LOSS (unsynced writes)`, 'error');
                        currentLog(`‚ùå Virginia Apps: DOWN`, 'error');
                        currentLog(`‚ùå Ohio Failover Apps (in VA): DOWN`, 'error');
                        currentLog(`‚úì Virginia Failover (in OH): AUTO-ACTIVATED`, 'success');
                        currentLog(`‚ö†Ô∏è ALL TRAFFIC ‚Üí OHIO (2x load, degraded performance)`, 'warning');
                    } else {
                        currentState.appStatus.ohMain = 'down';
                        currentState.appStatus.vaFailover = 'down';
                        currentState.appStatus.ohFailover = 'active';
                        // vaMain stays as is (active)
                        
                        currentLog(`üö® OHIO REGION FAILURE!`, 'error');
                        currentLog(`üíî ~30 SECONDS OF DATA LOSS (unsynced writes)`, 'error');
                        currentLog(`‚ùå Ohio Apps: DOWN`, 'error');
                        currentLog(`‚ùå Virginia Failover Apps (in OH): DOWN`, 'error');
                        currentLog(`‚úì Ohio Failover (in VA): AUTO-ACTIVATED`, 'success');
                        currentLog(`‚ö†Ô∏è ALL TRAFFIC ‚Üí VIRGINIA (2x load, degraded performance)`, 'warning');
                    }
                    
                    // DSP breaks when either region goes down
                    if (currentState.dspActive) {
                        currentState.dspActive = false;
                        currentLog(`‚ùå DSP SYNC BROKEN - ${REGIONS[regionKey].name} unavailable`, 'error');
                    }
                }
                
                renderCurrentState();
            }
        }

        function toggleDSP() {
            currentState.dspActive = !currentState.dspActive;
            updateDSPStatus();
            updateCurrentButtons();
            updateSplitBrainWarning();
            
            if (currentState.dspActive) {
                currentLog('‚úì DSP sync restored', 'success');
                currentLog('‚ö†Ô∏è Data reconciliation required - conflicts possible', 'warning');
            } else {
                // Check if both regions are active - this is SPLIT BRAIN
                const vaUp = !currentState.virginiaRS.nodes.every(n => n.status === 'down');
                const ohUp = !currentState.ohioRS.nodes.every(n => n.status === 'down');
                
                if (vaUp && ohUp) {
                    currentLog('üö®üö®üö® CRITICAL: SPLIT-BRAIN DETECTED! üö®üö®üö®', 'error');
                    currentLog('‚ùå DSP SYNC BROKEN while BOTH REGIONS ACTIVE!', 'error');
                    currentLog('‚ùå Virginia RS accepting writes ‚Üí NOT syncing to Ohio', 'error');
                    currentLog('‚ùå Ohio RS accepting writes ‚Üí NOT syncing to Virginia', 'error');
                    currentLog('üíî DATA DIVERGENCE IN PROGRESS!', 'error');
                    currentLog('‚ö†Ô∏è Immediate action required to prevent data loss!', 'warning');
                } else {
                    currentLog('‚ö†Ô∏è DSP SYNC BROKEN', 'error');
                }
            }
        }

        function manualFailover(targetRegion) {
            if (targetRegion === 'virginia') {
                // Activate Virginia failover apps (takes traffic from Ohio)
                if (currentState.appStatus.ohMain === 'down') {
                    currentState.appStatus.vaFailover = 'active';
                    currentLog('‚úì Virginia failover apps MANUALLY ACTIVATED', 'success');
                    currentLog('‚ö†Ô∏è Now serving Ohio traffic from Virginia', 'warning');
                    currentLog('‚ö†Ô∏è Data written during outage is LOST (~30s worth)', 'error');
                } else {
                    currentLog('Ohio is still healthy - no failover needed', 'info');
                }
            } else {
                // Activate Ohio failover apps (takes traffic from Virginia)
                if (currentState.appStatus.vaMain === 'down') {
                    currentState.appStatus.ohFailover = 'active';
                    currentLog('‚úì Ohio failover apps MANUALLY ACTIVATED', 'success');
                    currentLog('‚ö†Ô∏è Now serving Virginia traffic from Ohio', 'warning');
                    currentLog('‚ö†Ô∏è Data written during outage is LOST (~30s worth)', 'error');
                } else {
                    currentLog('Virginia is still healthy - no failover needed', 'info');
                }
            }
            renderApplicationLayer();
        }

        function currentKillPrimary() {
            const rs = Math.random() > 0.5 ? currentState.virginiaRS : currentState.ohioRS;
            const primary = rs.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
            if (primary) {
                currentToggleNode(rs.id, primary.id);
            } else {
                currentLog('No healthy primary to kill', 'warning');
            }
        }

        function currentResetCluster() {
            currentState.dspActive = true;
            currentState.dspLag = 30;
            
            // Reset app status - normal dual-region operation
            currentState.appStatus = {
                vaMain: 'active',      // Virginia Apps ‚Üí Virginia RS
                ohFailover: 'standby', // Ohio Failover (in VA) ‚Üí standby
                ohMain: 'active',      // Ohio Apps ‚Üí Ohio RS
                vaFailover: 'standby'  // Virginia Failover (in OH) ‚Üí standby
            };
            
            // Virginia: 3 voting nodes + 1 hidden (4 total)
            currentState.virginiaRS.nodes.forEach((n, i) => {
                n.status = 'healthy';
                n.oplogCount = 0;
                if (n.hidden) {
                    n.role = 'hidden';
                } else {
                    n.role = i === 0 ? 'primary' : 'secondary';
                }
            });
            
            // Ohio: 3 voting nodes
            currentState.ohioRS.nodes.forEach((n, i) => {
                n.status = 'healthy';
                n.oplogCount = 0;
                n.role = i === 0 ? 'primary' : 'secondary';
            });
            
            renderCurrentState();
            document.getElementById('current-event-log').innerHTML = '';
            currentLog('Current state cluster reset', 'success');
            currentLog('Virginia: 3 nodes + 1 hidden, Ohio: 3 nodes', 'info');
        }

        function currentTriggerElection(rs, callback = null) {
            if (currentState.isElecting[rs.id]) return;
            currentState.isElecting[rs.id] = true;
            
            const healthyVoters = rs.nodes.filter(n => n.status === 'healthy' && !n.hidden).length;
            const rsName = rs.id === 'virginia-rs' ? 'Virginia' : 'Ohio';
            
            const modal = document.getElementById('election-modal');
            const progressBar = document.getElementById('election-progress');
            const electionStatus = document.getElementById('election-status');
            const electionText = document.getElementById('election-text');
            const modalTitle = modal.querySelector('.modal-title');
            const modalIcon = modal.querySelector('.modal-icon');
            
            modal.classList.add('visible');
            electionText.textContent = `${rsName} RS: Initiating election...`;
            
            if (healthyVoters < 2) {
                modalIcon.textContent = '‚ö†Ô∏è';
                modalTitle.textContent = 'Election Failed';
                electionText.innerHTML = `<strong style="color: var(--danger-color);">${rsName}: No majority!</strong><br>Healthy voters: ${healthyVoters}/2 required`;
                progressBar.style.width = '100%';
                progressBar.style.background = 'var(--danger-color)';
                electionStatus.textContent = 'Replica set is READ-ONLY';
                
                currentLog(`${rsName} election FAILED: no majority`, 'error');
                
                setTimeout(() => {
                    modal.classList.remove('visible');
                    currentState.isElecting[rs.id] = false;
                    progressBar.style.width = '0%';
                    progressBar.style.background = 'var(--mongo-green)';
                    modalIcon.textContent = 'üó≥Ô∏è';
                    modalTitle.textContent = 'Election in Progress';
                    if (callback) callback();
                }, 3000);
                return;
            }
            
            const steps = [
                { progress: 25, text: 'Detecting node status...' },
                { progress: 50, text: `Checking quorum: ${healthyVoters}/2` },
                { progress: 75, text: 'Voting...' },
                { progress: 100, text: 'New primary elected!' }
            ];

            let stepIndex = 0;
            const stepInterval = setInterval(() => {
                if (stepIndex < steps.length) {
                    progressBar.style.width = `${steps[stepIndex].progress}%`;
                    electionStatus.textContent = steps[stepIndex].text;
                    stepIndex++;
                } else {
                    clearInterval(stepInterval);
                    
                    const candidates = rs.nodes.filter(n => n.status === 'healthy' && !n.hidden && n.priority > 0);
                    if (candidates.length > 0) {
                        candidates.sort((a, b) => b.priority - a.priority)[0].role = 'primary';
                        currentLog(`‚úì ${rsName}: New primary elected`, 'success');
                    }
                    
                    setTimeout(() => {
                        modal.classList.remove('visible');
                        currentState.isElecting[rs.id] = false;
                        renderCurrentState();
                        progressBar.style.width = '0%';
                        if (callback) callback();
                    }, 800);
                }
            }, 400);
        }

        async function currentSimulateWrite(operation) {
            // Get app source selection
            const appSource = document.getElementById('current-app-source-select').value;
            
            const vaDown = currentState.appStatus.vaMain === 'down';
            const ohDown = currentState.appStatus.ohMain === 'down';
            
            let targetRS, targetRSName, otherRS, otherRSName, appElId;
            
            if (vaDown && ohDown) {
                currentLog(`${operation.toUpperCase()} FAILED: Both regions down!`, 'error');
                return;
            }
            
            // Determine target based on selected app source
            // If region is down, failover app in surviving region writes locally
            if (appSource === 'virginia') {
                if (vaDown) {
                    // Virginia is down - Virginia Failover (hosted in Ohio) writes to Ohio RS
                    targetRS = currentState.ohioRS;
                    targetRSName = 'Ohio';
                    otherRS = currentState.virginiaRS;
                    otherRSName = 'Virginia';
                    appElId = 'va-failover-app'; // Virginia failover is hosted in Ohio
                    currentLog(`‚ö†Ô∏è Virginia down - using Virginia Failover (in Ohio)`, 'warning');
                } else {
                    targetRS = currentState.virginiaRS;
                    targetRSName = 'Virginia';
                    otherRS = currentState.ohioRS;
                    otherRSName = 'Ohio';
                    appElId = 'va-app-main';
                }
            } else {
                if (ohDown) {
                    // Ohio is down - Ohio Failover (hosted in Virginia) writes to Virginia RS
                    targetRS = currentState.virginiaRS;
                    targetRSName = 'Virginia';
                    otherRS = currentState.ohioRS;
                    otherRSName = 'Ohio';
                    appElId = 'oh-failover-app'; // Ohio failover is hosted in Virginia
                    currentLog(`‚ö†Ô∏è Ohio down - using Ohio Failover (in Virginia)`, 'warning');
                } else {
                    targetRS = currentState.ohioRS;
                    targetRSName = 'Ohio';
                    otherRS = currentState.virginiaRS;
                    otherRSName = 'Virginia';
                    appElId = 'oh-app-main';
                }
            }
            
            const primary = targetRS.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
            
            if (!primary) {
                currentLog(`${operation.toUpperCase()} FAILED: No primary in ${targetRSName}`, 'error');
                return;
            }
            
            // Calculate write concern requirements
            const votingNodes = targetRS.nodes.filter(n => !n.hidden);
            const healthyVoting = votingNodes.filter(n => n.status === 'healthy').length;
            const majorityNeeded = Math.floor(votingNodes.length / 2) + 1;
            const wcRequired = currentState.writeConcern === 'majority' ? majorityNeeded : 
                              currentState.writeConcern === '1' ? 1 : votingNodes.length;
            
            // w:all check - if ANY voting node is down, write will timeout
            if (currentState.writeConcern === 'all') {
                const downNodes = votingNodes.filter(n => n.status !== 'healthy');
                if (downNodes.length > 0) {
                    const downNames = downNodes.map(n => n.name).join(', ');
                    currentLog(`${operation.toUpperCase()} TIMEOUT: w:all requires all ${votingNodes.length} nodes in ${targetRSName} RS`, 'error');
                    currentLog(`‚è≥ Waiting indefinitely for: ${downNames}`, 'error');
                    currentLog(`üí° Reduce write concern or restore nodes to proceed`, 'warning');
                    return;
                }
            }
            
            // w:majority check - need majority of voting nodes
            if (currentState.writeConcern === 'majority' && healthyVoting < majorityNeeded) {
                currentLog(`${operation.toUpperCase()} FAILED: w:majority requires ${majorityNeeded} nodes, only ${healthyVoting} healthy`, 'error');
                return;
            }
            
            currentLog(`${operation.toUpperCase()} ‚Üí ${targetRSName} RS (w:${currentState.writeConcern})`, 'info');
            
            // Animate: App ‚Üí Primary
            const appEl = document.getElementById(appElId);
            const primaryEl = document.getElementById(`current-node-${primary.id}`);
            
            if (appEl && primaryEl) {
                await animateParticle(appEl, primaryEl, 'write', 400);
            }
            
            if (primaryEl) {
                primaryEl.classList.add('receiving');
                setTimeout(() => primaryEl.classList.remove('receiving'), 500);
            }
            primary.oplogCount++;
            targetRS.nodes.filter(n => n.role !== 'primary' && n.status === 'healthy').forEach(n => n.oplogCount++);
            renderCurrentState();
            
            await sleep(300);
            
            // Log based on write concern
            if (currentState.writeConcern === '1') {
                currentLog(`${operation.toUpperCase()} acknowledged by ${targetRSName} RS (w:1 = primary only)`, 'success');
            } else if (currentState.writeConcern === 'majority') {
                currentLog(`${operation.toUpperCase()} acknowledged by ${targetRSName} RS (w:majority = ${majorityNeeded}/${votingNodes.length} nodes)`, 'success');
            } else {
                currentLog(`${operation.toUpperCase()} acknowledged by ${targetRSName} RS (w:all = ${votingNodes.length}/${votingNodes.length} nodes)`, 'success');
            }
            
            // DSP two-way sync (async, with lag)
            const otherDown = otherRS.nodes.every(n => n.status === 'down');
            
            if (currentState.dspActive && !otherDown) {
                currentLog(`Queued for DSP sync to ${otherRSName} (~${currentState.dspLag}s lag)...`, 'warning');
                
                setTimeout(() => {
                    const otherPrimary = otherRS.nodes.find(n => n.role === 'primary' && n.status === 'healthy');
                    if (otherPrimary && currentState.dspActive) {
                        otherPrimary.oplogCount++;
                        otherRS.nodes.filter(n => n.role !== 'primary' && n.status === 'healthy').forEach(n => n.oplogCount++);
                        renderCurrentState();
                        currentLog(`‚úì DSP synced ${operation} to ${otherRSName}`, 'info');
                    }
                }, 2000);
            } else if (otherDown) {
                currentLog(`‚ö†Ô∏è ${otherRSName} down - ${operation} NOT replicated!`, 'error');
                currentLog(`‚ö†Ô∏è Data loss if ${targetRSName} fails before ${otherRSName} recovers!`, 'error');
            } else {
                currentLog(`‚ö†Ô∏è DSP down - ${operation} NOT replicated to ${otherRSName}!`, 'error');
            }
        }

        async function currentSimulateRead() {
            // Get selections
            const appSource = document.getElementById('current-app-source-select').value;
            const readPref = document.getElementById('current-read-pref-select').value;
            
            const vaDown = currentState.appStatus.vaMain === 'down';
            const ohDown = currentState.appStatus.ohMain === 'down';
            
            if (vaDown && ohDown) {
                currentLog('READ FAILED: Both regions down!', 'error');
                return;
            }
            
            // Determine which app and which RS based on selection
            // If region is down, failover app in surviving region reads locally
            let targetRS, region, appElId;
            
            if (appSource === 'virginia') {
                if (vaDown) {
                    // Virginia is down - Virginia Failover (hosted in Ohio) reads from Ohio RS
                    targetRS = currentState.ohioRS;
                    region = 'Ohio';
                    appElId = 'va-failover-app';
                    currentLog(`‚ö†Ô∏è Virginia down - using Virginia Failover (in Ohio)`, 'warning');
                } else {
                    targetRS = currentState.virginiaRS;
                    region = 'Virginia';
                    appElId = 'va-app-main';
                }
            } else {
                if (ohDown) {
                    // Ohio is down - Ohio Failover (hosted in Virginia) reads from Virginia RS
                    targetRS = currentState.virginiaRS;
                    region = 'Virginia';
                    appElId = 'oh-failover-app';
                    currentLog(`‚ö†Ô∏è Ohio down - using Ohio Failover (in Virginia)`, 'warning');
                } else {
                    targetRS = currentState.ohioRS;
                    region = 'Ohio';
                    appElId = 'oh-app-main';
                }
            }
            
            const healthyNodes = targetRS.nodes.filter(n => n.status === 'healthy' && !n.hidden);
            
            if (healthyNodes.length === 0) {
                currentLog('READ FAILED: No healthy nodes', 'error');
                return;
            }
            
            // Select target node based on read preference
            let targetNode;
            const primary = healthyNodes.find(n => n.role === 'primary');
            const secondaries = healthyNodes.filter(n => n.role === 'secondary');
            
            switch (readPref) {
                case 'primary':
                    targetNode = primary;
                    if (!targetNode) {
                        currentLog(`READ FAILED: No primary available (readPreference: primary)`, 'error');
                        return;
                    }
                    break;
                case 'primaryPreferred':
                    targetNode = primary || secondaries[Math.floor(Math.random() * secondaries.length)];
                    break;
                case 'secondary':
                    if (secondaries.length === 0) {
                        currentLog(`READ FAILED: No secondaries available (readPreference: secondary)`, 'error');
                        return;
                    }
                    targetNode = secondaries[Math.floor(Math.random() * secondaries.length)];
                    break;
                case 'secondaryPreferred':
                    targetNode = secondaries.length > 0 ? 
                        secondaries[Math.floor(Math.random() * secondaries.length)] : primary;
                    break;
                case 'nearest':
                default:
                    targetNode = healthyNodes[Math.floor(Math.random() * healthyNodes.length)];
            }
            
            if (!targetNode) {
                currentLog('READ FAILED: No eligible nodes for read preference', 'error');
                return;
            }
            
            const appEl = document.getElementById(appElId);
            const nodeEl = document.getElementById(`current-node-${targetNode.id}`);
            
            currentLog(`READ (${readPref}) ‚Üí ${region}/${targetNode.name}`, 'info');
            
            // Animate: App ‚Üí Node
            if (appEl && nodeEl) {
                await animateParticle(appEl, nodeEl, 'read', 350);
            }
            
            // Animate response: Node ‚Üí App
            if (nodeEl && appEl) {
                await animateParticle(nodeEl, appEl, 'read', 350);
            }
            
            currentLog(`READ ‚Üê ${region}/${targetNode.name} complete`, 'success');
            
            if (!currentState.dspActive) {
                currentLog(`‚ö†Ô∏è Warning: Data may be stale (DSP down)`, 'warning');
            }
        }

        // ============ EVENT HANDLERS ============
        // Current State write concern handler (called via onclick)
        function setCurrentWriteConcern(value, element) {
            document.querySelectorAll('#current-wc-pills .wc-pill').forEach(p => p.classList.remove('selected'));
            element.classList.add('selected');
            currentState.writeConcern = value;
            
            // Update the connection badges
            const wcVa = document.getElementById('current-wc-va');
            const wcOh = document.getElementById('current-wc-oh');
            if (wcVa) wcVa.textContent = `w:${currentState.writeConcern}`;
            if (wcOh) wcOh.textContent = `w:${currentState.writeConcern}`;
            
            currentLog(`Write concern: w:${currentState.writeConcern}`, 'info');
        }

        function setupWriteConcernHandlers() {
            // Future State write concern pills
            document.querySelectorAll('#wc-pills .wc-pill').forEach(pill => {
                pill.addEventListener('click', () => {
                    document.querySelectorAll('#wc-pills .wc-pill').forEach(p => p.classList.remove('selected'));
                    pill.classList.add('selected');
                    state.writeConcern = pill.dataset.value;
                    log(`Write concern: w:${state.writeConcern}`, 'info');
                });
            });
            
            // App source dropdown
            const appSourceSelect = document.getElementById('app-source-select');
            if (appSourceSelect) {
                appSourceSelect.addEventListener('change', (e) => {
                    state.appSource = e.target.value;
                    const label = e.target.value === 'auto' ? 'Auto' : 
                                  e.target.value === 'virginia' ? 'üóΩ Virginia' : 'üå∞ Ohio';
                    log(`App source: ${label}`, 'info');
                });
            }
            
            // Read preference dropdown
            const readPrefSelect = document.getElementById('read-pref-select');
            if (readPrefSelect) {
                readPrefSelect.addEventListener('change', (e) => {
                    state.readPreference = e.target.value;
                    log(`Read preference: ${e.target.value}`, 'info');
                });
            }
        }

        // ============ INIT ============
        function init() {
            // Initialize Current State
            renderCurrentState();
            currentLog('Current state: Virginia (3+1 hidden) + Ohio (3) + DSP', 'warning');
            currentLog('‚ö†Ô∏è ~30s replication lag between regions', 'warning');
            
            // Initialize Future State
            renderMongos();
            renderConfigServers();
            renderFutureAppLayer();
            renderShards();
            updateRegionButtons();
            updateClusterStatus();
            updateRebalanceStatus();
            setupWriteConcernHandlers();
            log('Future state: Native sharded cluster', 'success');
            log('2 shards √ó 5 nodes (2-2-1), w:majority = 3 nodes', 'info');
            log('Shard 1 PRIMARY ‚Üí Virginia, Shard 2 PRIMARY ‚Üí Ohio', 'info');
            log('Virginia apps ‚Üí Shard 1, Ohio apps ‚Üí Shard 2', 'info');
            log('California nodes are Priority 0 (DR only)', 'info');
            
            // Start on Current State tab
            switchTab('current');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

