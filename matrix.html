<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Strategic Architecture Decision Matrix</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg role='img' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Ctitle%3EMongoDB%3C/title%3E%3Cpath fill='%2300ED64' d='M17.193 9.555c-1.264-5.58-4.252-7.414-4.573-8.115-.28-.394-.53-.954-.735-1.44-.036.495-.055.685-.523 1.184-.723.566-4.438 3.682-4.74 10.02-.282 5.912 4.27 9.435 4.888 9.884l.07.05A73.49 73.49 0 0111.91 24h.481c.114-1.032.284-2.056.51-3.07.417-.296.604-.463.85-.693a11.342 11.342 0 003.639-8.464c.01-.814-.103-1.662-.197-2.218zm-5.336 8.195s0-8.291.275-8.29c.213 0 .49 10.695.49 10.695-.381-.045-.765-1.76-.765-2.405z'/%3E%3C/svg%3E">
    
   <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PZF6PVTQ');</script>
<!-- End Google Tag Manager -->
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    
    <style>
        /* --- CORE STYLES --- */
        :root {
            --bg-primary: #0a1929;
            --bg-secondary: #1a2332;
            --bg-tertiary: #001e2b;
            --bg-surface: rgba(255, 255, 255, 0.95);
            --bg-surface-gradient: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
            --bg-header: linear-gradient(135deg, #001E2B 0%, #003547 100%);
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --text-dark: #001e2b;
            --text-muted: #2c3e50;
            --accent-green: #00ED64;
            --accent-green-dark: #4DB33D;
            --shadow-color: rgba(0,0,0,0.4);
            --shadow-light: rgba(0,0,0,0.2);
            --border-color: rgba(77,179,61,0.2);
            --grid-color: #2a3f54;
            --control-bg: rgba(255, 255, 255, 0.95);
            --control-text: #001e2b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            background-color: #0a1929; /* Immediate dark background */
        }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
            transition: background 0.3s ease;
        }

        /* --- HEADER --- */
        header { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 70px; 
            background: linear-gradient(135deg, #001E2B 0%, #003547 100%);
            color: white; 
            display: flex; 
            align-items: center; 
            padding: 0 30px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.4), 0 0 40px rgba(77,179,61,0.1);
            z-index: 100;
            border-bottom: 1px solid rgba(77,179,61,0.2);
        }
        h1 { 
            margin: 0; 
            font-size: 1.5rem; 
            font-weight: 700; 
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #fff 0%, #e0e0e0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle { 
            margin-left: 20px; 
            font-size: 0.9rem; 
            color: #00ED64;
            font-weight: 600;
            border-left: 2px solid #00ED64; 
            padding-left: 20px; 
            letter-spacing: 0.5px;
        }

        /* --- DIAGRAM CONTAINER --- */
        #diagram-container { 
            position: relative;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 237, 100, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(77, 179, 61, 0.05) 0%, transparent 50%),
                radial-gradient(#2a3f54 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 30px 30px;
            overflow: hidden; 
            transition: margin-right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .mermaid { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            opacity: 0;
            animation: fadeIn 0.6s ease forwards;
        }
        .mermaid svg { 
            height: 100% !important; 
            width: 100% !important; 
            max-width: none !important;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }



        /* --- CONTROLS --- */
        .controls { 
            position: absolute; 
            bottom: 30px; 
            left: 30px; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px; 
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.1);
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            z-index: 90;
        }
        button.ctrl-btn { 
            width: 48px; 
            height: 48px; 
            border: none;
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 1.5rem; 
            color: #001e2b;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        button.ctrl-btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #00ED64 0%, #4DB33D 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        button.ctrl-btn:hover::before { opacity: 0.15; }
        button.ctrl-btn:hover { 
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 16px rgba(0,237,100,0.3);
        }
        button.ctrl-btn:active {
            transform: translateY(0) scale(0.98);
        }
        button.ctrl-btn span {
            position: relative;
            z-index: 1;
        }

        /* --- LEGEND --- */
        .legend { 
            position: absolute; 
            top: 90px; 
            left: 30px; 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 24px; 
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.1);
            font-size: 0.9rem; 
            z-index: 90;
            min-width: 240px;
        }
        .legend strong {
            display: block;
            font-size: 1rem;
            font-weight: 700;
            color: #001e2b;
            margin-bottom: 16px;
            letter-spacing: -0.3px;
        }
        .legend-item { 
            display: flex; 
            align-items: center; 
            margin-bottom: 12px; 
            color: #2c3e50;
            font-weight: 500;
            transition: transform 0.2s ease;
        }
        .legend-item:hover {
            transform: translateX(4px);
        }
        .dot { 
            width: 16px; 
            height: 16px; 
            border-radius: 5px; 
            margin-right: 14px;
            transition: transform 0.2s ease;
        }
        .legend-item:hover .dot {
            transform: scale(1.2);
        }
        .l-value { 
            background: linear-gradient(135deg, #00ED64 0%, #4DB33D 100%);
            border: none;
            box-shadow: 0 2px 8px rgba(0,237,100,0.3);
        }
        .l-tech { 
            background: #E3F2FD;
            border: 1px solid #1565C0;
        }
        .l-scale {
            background: #FFF3E0;
            border: 1px solid #EF6C00;
        }
        .l-plat {
            background: #F3E5F5;
            border: 1px solid #7B1FA2;
        }
        .l-deploy {
            background: #E8F5E9;
            border: 1px solid #2E7D32;
        }
        .l-start {
            background: #333;
            border: 1px solid #000;
        }
        .l-exit {
            background: #F5F5F5;
            border: 1px dashed #616161;
        }
        .l-final {
            background: #DEFFF8;
            border: 1px solid #46EDC8;
        }

        /* --- SIDE DRAWER --- */
        #side-drawer {
            position: fixed;
            top: 70px;
            right: -450px;
            width: 420px;
            bottom: 0;
            background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
            box-shadow: -8px 0 40px rgba(0,0,0,0.3);
            z-index: 200;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(0,237,100,0.2);
        }

        #side-drawer.open { right: 0; }

        .drawer-header {
            background: linear-gradient(135deg, #001E2B 0%, #003547 100%);
            padding: 28px 32px;
            border-bottom: 1px solid rgba(0,237,100,0.2);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .drawer-header h2 { 
            margin: 0; 
            font-size: 1.4rem; 
            color: #ffffff;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .close-btn { 
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            font-size: 1.6rem; 
            color: #ffffff;
            cursor: pointer; 
            padding: 0; 
            line-height: 1;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-btn:hover { 
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }

        .drawer-body { 
            padding: 32px; 
            overflow-y: auto; 
            flex-grow: 1;
        }

        .drawer-body::-webkit-scrollbar {
            width: 8px;
        }
        .drawer-body::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
        }
        .drawer-body::-webkit-scrollbar-thumb {
            background: rgba(0,237,100,0.3);
            border-radius: 4px;
        }
        .drawer-body::-webkit-scrollbar-thumb:hover {
            background: rgba(0,237,100,0.5);
        }

        .value-prop-box {
            background: linear-gradient(135deg, #E8F5E9 0%, #f1f8f4 100%);
            border-left: 4px solid #00ED64;
            padding: 24px;
            margin-bottom: 28px;
            border-radius: 0 12px 12px 0;
            box-shadow: 0 4px 12px rgba(0,237,100,0.1);
        }
        .value-label { 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            color: #2d7a4d;
            font-weight: 800;
            display: block; 
            margin-bottom: 10px; 
            letter-spacing: 1px;
        }
        .value-text { 
            font-size: 1.2rem; 
            color: #001e2b;
            font-weight: 700;
            line-height: 1.5;
        }

        .details-text { 
            color: #34495e;
            line-height: 1.8;
            font-size: 0.95rem; 
            margin-bottom: 32px;
        }

        .doc-link {
            display: block;
            text-align: center;
            background: linear-gradient(135deg, #001E2B 0%, #003547 100%);
            color: white;
            padding: 14px 24px;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0,30,43,0.3);
            position: relative;
            overflow: hidden;
        }
        .doc-link::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #00ED64 0%, #4DB33D 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .doc-link:hover::before {
            opacity: 1;
        }
        .doc-link:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,237,100,0.4);
        }
        .doc-link span {
            position: relative;
            z-index: 1;
        }
        .no-link { 
            background: #e0e0e0;
            color: #999; 
            pointer-events: none;
            box-shadow: none;
        }

        /* --- MONGODB LEAF LOGO --- */
        .mongodb-leaf {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 100px;
            height: 100px;
            opacity: 0.2;
            pointer-events: none;
            z-index: 85;
            transition: opacity 0.3s ease;
        }

        /* --- DUAL MODE INTERFACE --- */
        /* Mode Tabs */
        .mode-tabs {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 6px;
            z-index: 95;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .mode-tab {
            padding: 12px 30px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .mode-tab:hover {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }
        
        .mode-tab.active {
            background: linear-gradient(135deg, #00ED64 0%, #4DB33D 100%);
            color: #001e2b;
            box-shadow: 0 4px 15px rgba(0,237,100,0.4);
        }

        /* Mode Containers */
        .mode-container {
            position: absolute;
            top: 140px;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }
        
        .mode-container.active {
            opacity: 1;
            visibility: visible;
        }

        /* Guided Mode - Wizard */
        #guided-mode {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 40px;
            overflow-y: auto;
            max-height: calc(100vh - 70px);
        }

        .wizard-progress {
            width: 600px;
            margin-bottom: 40px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ED64 0%, #4DB33D 100%);
            border-radius: 10px;
            transition: width 0.4s ease;
            width: 0%;
        }
        
        .progress-text {
            text-align: center;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
            margin-top: 12px;
            font-weight: 500;
        }

        .wizard-card {
            width: 700px;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1);
            animation: fadeSlideUp 0.5s ease;
        }

        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-icon {
            font-size: 3.5rem;
            text-align: center;
            margin-bottom: 20px;
        }

        .wizard-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #001e2b;
            margin-bottom: 12px;
            text-align: center;
        }

        .wizard-subtitle {
            font-size: 1rem;
            color: #666;
            margin-bottom: 40px;
            text-align: center;
            line-height: 1.6;
        }

        .wizard-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .wizard-option {
            padding: 20px 25px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .wizard-option:hover {
            background: #fff;
            border-color: #00ED64;
            box-shadow: 0 4px 20px rgba(0,237,100,0.15);
            transform: translateY(-2px);
        }

        .wizard-option-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #001e2b;
            margin-bottom: 6px;
        }

        .wizard-option-desc {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.5;
        }

        .wizard-nav {
            display: flex;
            gap: 16px;
            margin-top: 40px;
            justify-content: center;
        }

        .wizard-btn {
            padding: 14px 32px;
            border: none;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wizard-btn.primary {
            background: linear-gradient(135deg, #00ED64 0%, #4DB33D 100%);
            color: #001e2b;
            box-shadow: 0 4px 15px rgba(0,237,100,0.3);
        }

        .wizard-btn.primary:hover {
            box-shadow: 0 6px 20px rgba(0,237,100,0.4);
            transform: translateY(-2px);
        }

        .wizard-btn.secondary {
            background: #f8f9fa;
            color: #001e2b;
        }

        .wizard-btn.secondary:hover {
            background: #e9ecef;
        }

        .wizard-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Inline Sub-Question Styling */
        .sub-question-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
            margin-left: 30px;
        }

        .sub-question-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #00A854;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sub-question-label::before {
            content: '‚Ü≥';
            font-size: 1.3rem;
        }

        .sub-options {
            gap: 12px;
        }

        .sub-option {
            padding: 16px 20px;
            background: #f0f8f5;
            border: 2px solid #d0e8e0;
        }

        .sub-option:hover {
            background: #e8f5f1;
            border-color: #00ED64;
        }

        .sub-option.selected {
            border-color: #00ED64;
            background: #ffffff;
        }

        /* Keyboard navigation focus indicator */
        .wizard-option.keyboard-focused {
            border-color: #4DB33D !important;
            box-shadow: 0 0 0 3px rgba(0, 237, 100, 0.2), 0 8px 16px rgba(0,0,0,0.15);
            transform: scale(1.02);
            transition: all 0.2s ease;
        }

        /* Recommendation Screen */
        .recommendation-card {
            width: 800px;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 60px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            text-align: center;
            animation: fadeSlideUp 0.5s ease;
        }

        .rec-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .rec-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: #001e2b;
            margin-bottom: 16px;
        }

        .rec-subtitle {
            font-size: 1.1rem;
            color: #00ED64;
            font-weight: 600;
            margin-bottom: 30px;
        }

        .rec-details {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: left;
        }

        .rec-section {
            margin-bottom: 20px;
        }

        .rec-section:last-child {
            margin-bottom: 0;
        }

        .rec-section-title {
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .rec-section-value {
            font-size: 1.15rem;
            color: #001e2b;
            font-weight: 600;
        }

        .rec-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        /* Expert View Enhancements */


        .back-to-guided {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 12px 24px;
            background: rgba(0,237,100,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0,237,100,0.3);
            border-radius: 12px;
            color: #00ED64;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 91;
            display: none;
        }

        .back-to-guided.visible {
            display: block;
        }

        .back-to-guided:hover {
            background: rgba(0,237,100,0.25);
            transform: translateX(-3px);
        }

        .path-highlight .node rect,
        .path-highlight .node polygon,
        .path-highlight .node circle {
            stroke-width: 4px !important;
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { filter: drop-shadow(0 0 15px currentColor); }
            50% { filter: drop-shadow(0 0 25px currentColor); }
        }

        /* Toggle Switch Styles */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 16px 0;
            border: 1px solid #e0e0e0;
        }
        
        .toggle-label {
            font-size: 1rem;
            font-weight: 500;
            color: #001e2b;
        }
        
        .toggle-switch {
            position: relative;
            width: 56px;
            height: 28px;
            background: #ccc;
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #00ED64;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(28px);
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PZF6PVTQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <header>
        <h1>MongoDB :  Architecture Decision Matrix</h1>
    </header>

    <!-- Mode Tabs -->
    <div class="mode-tabs">
        <button class="mode-tab active" data-mode="guided">
            <span>üéØ</span>
            <span>Guided Path</span>
        </button>
        <button class="mode-tab" data-mode="expert">
            <span>üó∫Ô∏è</span>
            <span>Expert View</span>
        </button>
    </div>

    <!-- Guided Mode Container -->
    <div id="guided-mode" class="mode-container active">
        <div class="wizard-progress">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 0.9rem; color: rgba(255,255,255,0.8); font-weight: 500;">Progress</span>
                <span id="progress-text" style="font-size: 0.9rem; color: #00ED64; font-weight: 600;">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
        <div id="wizard-content"></div>
    </div>

    <!-- Expert View Container -->
    <div id="expert-mode" class="mode-container">
        <button class="back-to-guided" id="back-to-guided">‚Üê Back to Guided Mode</button>

    <!-- MongoDB Leaf Logo Watermark -->
    <svg class="mongodb-leaf" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path fill="#00ED64" d="M17.193 9.555c-1.264-5.58-4.252-7.414-4.573-8.115-.28-.394-.53-.954-.735-1.44-.036.495-.055.685-.523 1.184-.723.566-4.438 3.682-4.74 10.02-.282 5.912 4.27 9.435 4.888 9.884l.07.05A73.49 73.49 0 0111.91 24h.481c.114-1.032.284-2.056.51-3.07.417-.296.604-.463.85-.693a11.342 11.342 0 003.639-8.464c.01-.814-.103-1.662-.197-2.218zm-5.336 8.195s0-8.291.275-8.29c.213 0 .49 10.695.49 10.695-.381-.045-.765-1.76-.765-2.405z"/>
    </svg>

    <div class="legend">
        <strong>Node Description</strong><br><br>
        <div class="legend-item"><div class="dot l-value"></div><strong>Value Proposition (Clickable)</strong></div>
        <div class="legend-item"><div class="dot l-tech"></div>Data & Workload</div>
        <div class="legend-item"><div class="dot l-scale"></div>Scalability & Performance</div>
        <div class="legend-item"><div class="dot l-plat"></div>Platform & Integration</div>
        <div class="legend-item"><div class="dot l-deploy"></div>Deployment & Security</div>
        <div class="legend-item"><div class="dot l-exit"></div>Exit / Alternative</div>
        <div class="legend-item"><div class="dot l-final"></div>Final Architecture</div>
    </div>
    <div class="controls">
        <button class="ctrl-btn" onclick="zoomIn()"><span>+</span></button>
        <button class="ctrl-btn" onclick="zoomOut()"><span>‚àí</span></button>
        <button class="ctrl-btn" onclick="resetZoom()"><span>‚Ü∫</span></button>
    </div>

    <div id="side-drawer">
        <div class="drawer-header">
            <h2 id="drawer-title">Node Title</h2>
            <button class="close-btn" onclick="closeDrawer()">√ó</button>
        </div>
        <div class="drawer-body">
            <div class="value-prop-box">
                <span class="value-label">Value Proposition</span>
                <span id="drawer-value" class="value-text">...</span>
            </div>
            <p id="drawer-details" class="details-text">...</p>
            <a id="drawer-link" href="#" target="_blank" class="doc-link"><span>Read Documentation ‚Üí</span></a>
        </div>
    </div>

    <div id="diagram-container" onclick="closeDrawer()">
        <div class="mermaid">
%%{init: {'theme': 'base', 'flowchart': {'curve': 'basis', 'layout': 'dagre', 'nodeSpacing': 180, 'rankSpacing': 200}, 'themeVariables': { 'background': 'transparent', 'mainBkg': 'transparent', 'fontFamily': 'Inter', 'fontSize': '16px', 'lineColor': '#ffffff' }}}%%
flowchart TB
    Start(["Start: Strategic Vision"]) --> WorkloadCheck{"**Workload Nature**<br>Transactional or<br>Analytical?"}
    
    %% Analytical Path
    WorkloadCheck -- Analytical (OLAP) --> AnalyticCheck{"**Analytical Nuance**<br>Massive Joins (10+),<br>Full Table Scans, OR<br>Deep History (&gt;500TB active data set)?"}
    AnalyticCheck -- Yes (Data Warehouse) --> DWH["**Data Warehouse / Lakehouse**<br>Snowflake / Databricks<br>(Cost Efficiency for Cold Data)"]
    AnalyticCheck -- "No (Real-Time Analytics)" --> DevSkill{"**Team Skillset**<br>Code-First (Devs)<br>or SQL-First (DBAs)?"}
    
    %% Transactional Path - Direct to DevSkill
    WorkloadCheck -- Transactional (OLTP) --> DevSkill
    
    %% Developer Skillset Branch
    DevSkill -- "SQL-First" --> AcidCheck{"**ACID Nuance**<br>Multi-table transactions<br>across 10+ tables?"}
    DevSkill -- "Code-First" --> ObjMatch["**Value: Dev Experience**<br>No ORM / Impedance Mismatch"]
    
    %% SQL-First Path
    AcidCheck -- Yes --> NormalizationCheck{"**Rigid Data Model**<br>is data is 3rd or 4th Normal form?"}
    AcidCheck -- No --> VolCheck{"**Volume Nuance**<br>Writes &lt; 1k/sec?"}
    NormalizationCheck -- No --> RigidSQL{"RigidSQL<br> is business logic embedded in sql and plsql?"}
    RigidSQL -- No --> RDBMS["**RDBMS**<br>SQL / Oracle"]
    RigidSQL -- Yes --> Migrator["**Relational Migrator**<br>Schema Transformation"]
    Migrator -- extension --> AMP["**MongoDB AMP**"]
    NormalizationCheck -- Datamodel Optimization --> Migrator
    Migrator --> MongoCore["**MongoDB Core**<br>Flexible Schema"]
    VolCheck -- No --> RDBMS
    VolCheck -- Yes --> MongoCore
    
    %% Code-First Path
    ObjMatch --> DataNature{"**Data Nature**<br>Is the schema volatile<br>or hierarchical?"}
    DataNature -- Yes (JSON) --> GraphCheck{"**Graph Nuance**<br>Unbounded depth<br>(&gt; 5 hops)?"}
    DataNature -- No (Rigid) --> AcidCheck
    GraphCheck -- Yes --> GraphDB["**Neo4j / Neptune**"]
    GraphCheck -- No --> KVCheck{"**Key-Value Nuance**<br>Simple ID Lookup?"}
    KVCheck -- Yes --> Latency{"**Latency Nuance**<br>Need &lt;1ms response<br>&amp; OK with data loss?"}
    Latency -- Yes --> Redis["**Redis / Memcached**"]
    Latency -- No --> MongoCore
    KVCheck -- No (Complex) --> QueryCheck{"**Query Nuance**<br>Need robust filtering,<br>secondary indexes,<br>or aggregations?"}
    QueryCheck -- Yes --> MongoCore
    
    %% MongoDB Core ‚Üí Business Model (Multi-Tenancy Decision)
    MongoCore --> BizModel{"**Business Model**<br>Internal Enterprise App<br>or B2B SaaS?"}
    
    %% B2B SaaS - Multi-Tenancy Branch
    BizModel -- B2B SaaS --> Tenancy{"**Multi-Tenancy Nuance**<br>Isolation Strategy?"}
    Tenancy -- Silo (1 Deployment per Tenant) --> Silo["**Devops Nightmare**<br>Not enforced by MongoDB even for hardware isolation"]
    Tenancy -- Pool (Shared DB) --> Isolation{"**Isolation Check**<br>Need strict data residency<br>per tenant?"}
    Isolation -- Logical Isolation --> Logical["**Logical Sharding**<br>Standard Collections"]
    Isolation -- Physical Isolation --> TenantShard["**Tenant-Aware Sharding**<br>Dedicate Nodes to VIPs"]
    Logical --> Agility{"**Velocity Check**<br>Does schema change<br>frequently?"}
    TenantShard --> Agility
    Silo --> Agility
    
    %% Internal App - Direct to Agility
    BizModel -- Internal App --> Agility
    
    %% Velocity & Scaling
    Agility -- Yes --> AgileVal["**Value: High Agility**<br>Faster Time-to-Market"]
    Agility -- No --> ScaleCheck{"**Scale Check**<br>Data &gt; 2TB OR<br>Writes &gt; 50k/s?"}
    AgileVal --> ScaleCheck
    ScaleCheck -- Yes --> ShardStrat{"**Sharding Strategy**<br>Access Pattern?"}
    ShardStrat -- Distributed Writes --> HashShard["**Hashed Sharding**<br>Uniform Distribution"]
    ShardStrat -- Location Based --> ZoneShard["**Zone Sharding**<br>Data Locality"]
    ShardStrat -- Range Queries --> RangeShard["**Ranged Sharding**<br>Time/Alpha Grouping"]
    ScaleCheck -- No --> Replica["**Replica Set**<br>High Availability"]
    HashShard --> PlatCheck{"**Workload Nuance**<br>Need Search, AI,<br>Streams, or Time Series?"}
    ZoneShard --> PlatCheck
    RangeShard --> PlatCheck
    Replica --> PlatCheck
    
    %% Platform Features
    PlatCheck -- Just CRUD --> Integration{"**Ecosystem Check**<br>Need mature connectors<br>(Kafka/Spark)?"}
    PlatCheck -- "Real-Time Streams" --> StreamCheck{"**Streaming Nuance**<br>Process data in-flight?"}
    StreamCheck -- Yes (Kafka+Flink) --> Flink["**Manage Separate Infra**<br>Complex Glue Code"]
    StreamCheck -- Yes (Unified) --> ASP["**Atlas Stream Processing**<br>Continuous Intelligence"]
    PlatCheck -- Search --> SearchDec{"**ETL Tolerance**<br>Want to manage<br>sync pipelines?"}
    SearchDec -- Yes --> Elastic["**Elasticsearch/SOLR**"]
    SearchDec -- No --> AtlasSearch["**Atlas Search**<br>Lucene on Node"]
    PlatCheck -- AI/Vector --> AIUse{"**AI Pattern**<br>How is Vector used?"}
    AIUse -- Chat History --> AgentMem["**Agent Memory**<br>Long-Term Context"]
    AIUse -- Reduce LLM Cost --> SemCache["**Semantic Cache**<br>Prevent Re-runs"]
    AIUse -- Knowledge Base --> RAG["**Knowledge Graph**<br>RAG + Filters"]
    PlatCheck -- IoT --> TimeSeries["**Time Series**<br>Columnar Store"]
    AtlasSearch --> Consolidation["**Value: Consolidation**<br>Reduced Tech Debt"]
    AgentMem --> Consolidation
    SemCache --> Consolidation
    RAG --> Consolidation
    TimeSeries --> Consolidation
    ASP --> Consolidation
    Consolidation --> Integration
    
    %% Deployment Path
    Integration -- No (Isolated) --> DeployCheck{"**Deployment**<br>Can data touch<br>public cloud?"}
    Integration -- Yes --> Connectors["**Value: Ecosystem**<br>Official Drivers/Connectors"]
    Connectors --> DeployCheck
    DeployCheck -- "No (Air-gapped)" --> SelfMan{"**Self-Managed**<br>Infrastructure?"}
    SelfMan -- Containers --> K8s["**Enterprise Operator**<br>OpenShift/K8s"]
    SelfMan -- VM/Metal --> OpsMan["**Ops Manager**<br>Automation"]
    K8s --> Secure@{ label: "**Trust Level**<br>Need 'Eyes-Off'?" }
    OpsMan --> Secure
    DeployCheck -- Yes (Cloud) --> Portability{"**Lock-In Check**<br>Need Cloud Agnostic<br>or Exit Strategy?"}
    Portability -- No (spefic Native) --> Dynamo["<br>cloud specific databases"]
    Portability -- Yes (Portable) --> NetCheck{"**Network Security**<br>Connection Method?"}
    NetCheck -- AWS/Azure Backbone --> PrivLink["**PrivateLink**<br>One-way Security"]
    NetCheck -- VPC Peering --> Peering["**VPC Peering**<br>Bi-directional"]
    NetCheck -- Public Internet --> IPList["**IP Whitelist**<br>Standard TLS"]
    PrivLink --> RTOCheck{"**DR Strategy**<br>RTO/RPO Requirements?"}
    Peering --> RTOCheck
    IPList --> RTOCheck
    RTOCheck -- "Near-Zero RPO<br>(Multi-Cloud Resilience)" --> MultiCloud["**Multi-Cloud Cluster**<br>AWS+Azure+GCP"]
    RTOCheck -- Minutes (Standard)<br>(Single Region) --> Standard["**Standard Cluster**<br>3-Node Replica"]
    Standard --> Lifecycle{"**Cost Efficiency**<br>Retain history &gt; 90 days?"}
    MultiCloud --> Lifecycle
    Lifecycle -- Yes --> Archive["**Online Archive**<br>Auto-Tiering to S3"]
    Lifecycle -- No --> ObsCheck{"**Ops Nuance**<br>Need Automated<br> Deployment Strategies ?  Performance Tuning?"}
    Archive --> ObsCheck
    ObsCheck -- No (Manual) --> ManualOps["**Manual Tuning**<br>Query Analysis"]
    ObsCheck -- Yes (Intelligent) --> PerfAdv["**MongoDB Atlas Landing Zone and Performance/Query Advisor**<br>*Templatized Deployment Configurations for control and ease of use<br>*Query Performance Visualization<br>*Auto-Index Suggest"]
    PerfAdv --> Secure
    ManualOps --> Secure
    Secure -- Yes (Regulated and High Compliance Requirements) --> CSFLE["Queryable Encryption<br>Client-Side filed encryptions<br>encryption at rest (KMIP)<br>encryption in motion<br><br>Compliance - First Platform<br>"]
    Secure -- No --> Final(["**Final DB choice : MongoDB**"])
    CSFLE --> Final
    AMP -.-> Consolidation

    %% --- CLICK BINDINGS ---
    click ObjMatch showInfo
    click AgileVal showInfo
    click Consolidation showInfo
    click Logical showInfo
    click TenantShard showInfo
    click Migrator showInfo
    click MongoCore showInfo
    click HashShard showInfo
    click ZoneShard showInfo
    click RangeShard showInfo
    click Replica showInfo
    click ASP showInfo
    click AtlasSearch showInfo
    click Vector showInfo
    click AgentMem showInfo
    click SemCache showInfo
    click RAG showInfo
    click TimeSeries showInfo
    click Connectors showInfo
    click K8s showInfo
    click OpsMan showInfo
    click PrivLink showInfo
    click Peering showInfo
    click IPList showInfo
    click MultiCloud showInfo
    click Standard showInfo
    click Archive showInfo
    click PerfAdv showInfo
    click CSFLE showInfo
    click AMP showInfo
    click Final "https://cloud.mongodb.com/" "Start with MongoDB Atlas" _blank

    %% --- STYLING ---
    Secure@{ shape: diamond}

     Start:::startNode
     BizModel:::techZone
     WorkloadCheck:::techZone
     Tenancy:::techZone
     Silo:::exitNode
     Isolation:::techZone
     Logical:::valueNode
     TenantShard:::valueNode
     AnalyticCheck:::techZone
     DWH:::exitNode
     DevSkill:::techZone
     AcidCheck:::techZone
     ObjMatch:::valueNode
     DataNature:::techZone
     NormalizationCheck:::techZone
     RigidSQL:::techZone
     RDBMS:::exitNode
     Migrator:::valueNode
     AMP:::valueNode
     MongoCore:::valueNode
     VolCheck:::techZone
     GraphCheck:::techZone
     GraphDB:::exitNode
     KVCheck:::techZone
     Latency:::techZone
     Redis:::exitNode
     QueryCheck:::techZone
     Agility:::techZone
     AgileVal:::valueNode
     ScaleCheck:::scaleZone
     ShardStrat:::scaleZone
     HashShard:::valueNode
     ZoneShard:::valueNode
     RangeShard:::valueNode
     Replica:::valueNode
     PlatCheck:::platZone
     Integration:::platZone
     StreamCheck:::platZone
     Flink:::exitNode
     ASP:::valueNode
     SearchDec:::platZone
     Elastic:::exitNode
     AtlasSearch:::valueNode
     AIUse:::platZone
     AgentMem:::valueNode
     SemCache:::valueNode
     RAG:::valueNode
     TimeSeries:::valueNode
     Consolidation:::valueNode
     DeployCheck:::deployZone
     Connectors:::valueNode
     SelfMan:::deployZone
     K8s:::valueNode
     OpsMan:::valueNode
     Secure:::deployZone
     Portability:::deployZone
     Dynamo:::exitNode
     NetCheck:::deployZone
     PrivLink:::valueNode
     Peering:::valueNode
     IPList:::valueNode
     RTOCheck:::deployZone
     MultiCloud:::valueNode
     Standard:::valueNode
     Lifecycle:::deployZone
     Archive:::valueNode
     ObsCheck:::deployZone
     ManualOps:::exitNode
     PerfAdv:::valueNode
     CSFLE:::valueNode
     Final:::Aqua
    classDef startNode fill:#333,stroke:#333,stroke-width:2px,color:#fff
    classDef techZone fill:#E3F2FD,stroke:#1565C0,stroke-width:2px,color:#000
    classDef scaleZone fill:#FFF3E0,stroke:#EF6C00,stroke-width:2px,color:#000
    classDef platZone fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px,color:#000
    classDef deployZone fill:#E8F5E9,stroke:#2E7D32,stroke-width:2px,color:#000
    classDef valueNode fill:#00ED64,stroke:#00684A,stroke-width:3px,font-weight:bold,color:#000
    classDef exitNode fill:#F5F5F5,stroke:#616161,stroke-width:1px,stroke-dasharray: 5 5,color:#666
    classDef Sky stroke-width:1px, stroke-dasharray:none, stroke:#374D7C, fill:#E2EBFF, color:#374D7C
    classDef Aqua stroke-width:1px, stroke-dasharray:none, stroke:#46EDC8, fill:#DEFFF8, color:#378E7A
   




        </div>
    </div>

    </div> <!-- /expert-mode -->

    <script>
        // --- DUAL MODE WIZARD ---
        
        /**
         * Sanitize HTML string to prevent XSS attacks
         * @param {string} str - String to sanitize  
         * @returns {string} Sanitized HTML-safe string
         */
        function sanitizeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /**
         * PRODUCTION ENHANCEMENT #1: Centralized Logging System
         * Captures errors and important events for production monitoring
         */
        const Logger = {
            levels: {
                DEBUG: 'DEBUG',
                INFO: 'INFO',
                WARN: 'WARN',
                ERROR: 'ERROR'
            },

            log: (level, message, data = {}) => {
                const timestamp = new Date().toISOString();
                const logEntry = {timestamp, level, message, data};
                
                // Always log to console
                console.log(`[${level}] ${message}`, data);
                
                // Send to external logging service in production (if available)
                if (window.Sentry) {
                    const sentryLevel = level === 'ERROR' ? 'error' : level === 'WARN' ? 'warning' : 'info';
                    window.Sentry.captureMessage(message, sentryLevel);
                    window.Sentry.setContext('data', data);
                }
                
                // Note: Custom API endpoint logging disabled for static hosting
                // Can be enabled if backend API becomes available
            },

            debug: (message, data) => Logger.log(Logger.levels.DEBUG, message, data),
            info: (message, data) => Logger.log(Logger.levels.INFO, message, data),
            warn: (message, data) => Logger.log(Logger.levels.WARN, message, data),
            error: (message, data) => Logger.log(Logger.levels.ERROR, message, data)
        };

        /**
         * PRODUCTION ENHANCEMENT #2: Analytics Tracking
         * Tracks user journey through the wizard for insights
         */
        const Analytics = {
            trackEvent: (eventName, eventData = {}) => {
                // Google Tag Manager - Push to dataLayer
                if (window.dataLayer) {
                    try {
                        window.dataLayer.push({
                            event: eventName,
                            ...eventData
                        });
                        console.log(`[GTM] Event pushed to dataLayer: ${eventName}`, eventData);
                    } catch (e) {
                        console.error(`[GTM] Error pushing event to dataLayer: ${eventName}`, e);
                    }
                } else {
                    console.warn('[GTM] dataLayer not initialized yet');
                }
                
                // Segment.com or custom tracking
                if (window.analytics) {
                    window.analytics.track(eventName, eventData);
                }
                
                Logger.debug(`Analytics: ${eventName}`, eventData);
            },

            trackQuestionAnswered: (questionId, answer) => {
                Analytics.trackEvent('question_answered', {
                    question_id: questionId,
                    answer_value: answer,
                    step: wizardData.currentStep
                });
            },

            trackRecommendationViewed: (dbChoice, architecture, deployment, features, reason, useCase) => {
                Analytics.trackEvent('recommendation_viewed', {
                    db_choice: dbChoice,
                    architecture: architecture,
                    deployment: deployment,
                    features: features.join(', '),
                    features_count: features.length,
                    reason: reason,
                    use_case: useCase,
                    total_steps_taken: wizardData.currentStep + 1,
                    session_duration: Date.now() - (window.sessionStartTime || Date.now())
                });
            },

            trackSessionStart: () => {
                window.sessionStartTime = Date.now();
                Analytics.trackEvent('session_start', {
                    timestamp: new Date().toISOString()
                });
            },

            trackModeSwitch: (mode) => {
                Analytics.trackEvent('mode_switched', {
                    to_mode: mode
                });
            }
        };

        /**
         * PRODUCTION ENHANCEMENT #3: Recommendation Export
         * Allows users to download or share recommendations
         */
        const RecommendationExport = {
            generateJSON: (dbChoice, architecture, deployment, features, reasoning, answers) => {
                // Build questions with answers mapping
                const questionAnswers = [];
                wizardData.questions.forEach(q => {
                    if (answers[q.id] !== undefined) {
                        questionAnswers.push({
                            id: q.id,
                            title: q.title,
                            answer: answers[q.id],
                            type: q.multiselect ? 'multiselect' : 'single'
                        });
                    }
                });
                
                return {
                    recommendation: {
                        database: dbChoice,
                        architecture: architecture,
                        deployment: deployment,
                        features: features,
                        reasoning: reasoning
                    },
                    questions_and_answers: questionAnswers,
                    user_answers: answers,
                    metadata: {
                        generated_date: new Date().toISOString(),
                        tool_version: '1.0',
                        browser: navigator.userAgent
                    }
                };
            },

            downloadJSON: (data, filename = null) => {
                try {
                    const json = JSON.stringify(data, null, 2);
                    const blob = new Blob([json], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename || `mongodb-recommendation-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    Analytics.trackEvent('recommendation_exported', {format: 'json'});
                    Logger.info('Recommendation exported as JSON');
                } catch (error) {
                    Logger.error('Failed to export recommendation', {error: error.message});
                }
            },

            generateCSV: (answers, recommendation = null) => {
                const rows = [];
                
                // Add recommendation verdict at top
                if (recommendation) {
                    rows.push(['RECOMMENDATION SUMMARY', '']);
                    rows.push(['Database Choice', recommendation.db || 'N/A']);
                    rows.push(['Architecture', recommendation.architecture || 'N/A']);
                    rows.push(['Deployment Model', recommendation.deployment || 'N/A']);
                    rows.push(['Recommended Features', (recommendation.features && recommendation.features.length > 0) ? recommendation.features.join(', ') : 'N/A']);
                    rows.push(['Reasoning', recommendation.reasoning || 'N/A']);
                    rows.push(['', '']);
                }
                
                // Add questions and answers
                rows.push(['Question ID', 'Question', 'Answer']);
                
                wizardData.questions.forEach((q, idx) => {
                    if (answers[q.id] !== undefined) {
                        const answerValue = Array.isArray(answers[q.id]) 
                            ? answers[q.id].join('; ')
                            : answers[q.id];
                        rows.push([q.id, q.title, answerValue]);
                    }
                });
                
                return rows.map(row => row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')).join('\n');
            },

            downloadCSV: (csv, filename = null) => {
                try {
                    const blob = new Blob([csv], {type: 'text/csv'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename || `mongodb-responses-${Date.now()}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    Analytics.trackEvent('recommendation_exported', {format: 'csv'});
                    Logger.info('Recommendation exported as CSV');
                } catch (error) {
                    Logger.error('Failed to export CSV', {error: error.message});
                }
            },

            copyToClipboard: (text) => {
                try {
                    navigator.clipboard.writeText(text);
                    Analytics.trackEvent('recommendation_copied_clipboard');
                    Logger.info('Recommendation copied to clipboard');
                } catch (error) {
                    Logger.error('Failed to copy to clipboard', {error: error.message});
                }
            }
        };

        // Question ID constants for type safety and maintainability
        const Q = {
            USE_CASE: 0,
            WORKLOAD: 1,
            ANALYTICAL_NUANCE: 2,
            BUSINESS_MODEL: 3,
            MULTI_TENANCY: 4,
            TEAM_SKILL: 5,
            MIGRATION_STATUS: 6,
            MIGRATION_SOURCE: 7,
            BUSINESS_LOGIC: 8, // WAS 10
            ACID_NEEDS: 9,     // WAS 8
            NORMALIZATION: 10, // WAS 9
            TRAFFIC_PATTERN: 11,
            SCALE: 12,
            DISTRIBUTION: 13,
            DATA_STRUCTURE: 14,
            GRAPH_DEPTH: 15,
            ACCESS_PATTERN: 16,
            LATENCY: 17,
            ADVANCED_FEATURES: 18,
            SEARCH_SCALE: 19,
            VECTOR_SCALE: 20,
            DEPLOYMENT: 21,
            SECURITY: 22,
            MOBILE_OFFLINE: 23
        };

        /**
         * Storage key for wizard state in localStorage
         * @constant {string}
         */
        const STORAGE_KEY = 'mongodb_wizard_state';

        /**
         * Save current wizard state to localStorage
         * Auto-saves answers and current step for session persistence
         */
        function saveWizardState() {
            try {
                const state = {
                    answers: wizardData.answers,
                    currentStep: wizardData.currentStep,
                    timestamp: Date.now()
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (error) {
                console.warn('Failed to save wizard state:', error);
            }
        }

        /**
         * Load wizard state from localStorage
         * @returns {Object|null} Saved state object or null if no valid state exists
         */
        function loadWizardState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return null;
                
                const state = JSON.parse(saved);
                // Only load if saved within last 7 days
                if (Date.now() - state.timestamp > 7 * 24 * 60 * 60 * 1000) {
                    clearWizardState();
                    return null;
                }
                return state;
            } catch (error) {
                console.warn('Failed to load wizard state:', error);
                return null;
            }
        }

        /**
         * Clear saved wizard state from localStorage
         */
        function clearWizardState() {
            try {
                localStorage.removeItem(STORAGE_KEY);
            } catch (error) {
                console.warn('Failed to clear wizard state:', error);
            }
        }

        /**
         * Format timestamp into human-readable relative time
         * @param {number} timestamp - Unix timestamp in milliseconds
         * @returns {string} Formatted time string (e.g., "5 minutes ago")
         */
        function formatTimestamp(timestamp) {
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
            return `${days} day${days !== 1 ? 's' : ''} ago`;
        }

        /**
         * Show resume prompt if saved wizard state exists
         * @param {Object} savedState - Previously saved wizard state
         */
        function showResumePrompt(savedState) {
            const wizardContent = document.getElementById('wizard-content');
            wizardContent.innerHTML = `
                <div class="wizard-card">
                    <div class="wizard-icon">üîÑ</div>
                    <h2 class="wizard-title">Resume Your Session?</h2>
                    <div class="wizard-subtitle">We found a saved wizard session from ${formatTimestamp(savedState.timestamp)}</div>
                    <div class="wizard-nav" style="justify-content: center; gap: 16px;">
                        <button class="wizard-btn secondary" onclick="startFresh()">Start Fresh</button>
                        <button class="wizard-btn primary" onclick="resumeSession()">Resume Session ‚Üí</button>
                    </div>
                </div>
            `;
        }

        /**
         * Resume wizard from saved state
         */
        function resumeSession() {
            const savedState = loadWizardState();
            if (savedState) {
                wizardData.answers = savedState.answers;
                wizardData.currentStep = savedState.currentStep;
            }
            renderWizardStep();
        }

        /**
         * Start wizard fresh, clearing any saved state
         */
        function startFresh() {
            clearWizardState();
            renderWizardStep();
        }

        const wizardData = {
            questions: [
                // Use Case Selection
                {
                    id: 0,
                    icon: 'üéØ',
                    title: "What's your primary use case?",
                    subtitle: "Select a scenario or choose 'Custom' for tailored guidance",
                    options: [
                        { value: 'custom', title: 'Custom / Explore Options', desc: 'Tailored guidance for unique needs' },
                        { value: 'saas', title: 'B2B SaaS Application', desc: 'Solution for external customers' },
                        { value: 'logs', title: 'Log Analytics / Observability', desc: 'PB-scale logs, metrics, traces' },
                        { value: 'iot', title: 'IoT / Time-Series', desc: 'Sensor data, metrics over time' },
                        { value: 'cms', title: 'Content Management', desc: 'Articles, media, flexible content' },
                        { value: 'marketplace', title: 'Marketplace', desc: 'Multi-vendor platform, product listings, transactions' },
                        { value: 'ecommerce', title: 'E-Commerce Platform', desc: 'Product catalog, orders, inventory' },
                        { value: 'social', title: 'Social Network', desc: 'User relationships, feeds, graphs' },
                        { value: 'mobile', title: 'Mobile / Edge App', desc: 'Offline-first, local data, sync' }

                    ]
                },
                // Workload Nature
                {
                    id: 1,
                    icon: '‚ö°',
                    title: "Workload nature?",
                    subtitle: "Primary characteristic of your application",
                    options: [
                        { value: 'transactional', title: 'Transactional (OLTP)', desc: 'Frequent reads/writes, user-facing, real-time' },
                        { value: 'analytical', title: 'Analytical (OLAP)', desc: 'Complex queries, reporting, BI, aggregations' }
                    ]
                },
                // Analytical Nuance (only if analytical) - INLINE
                {
                    id: 2,
                    isInline: true,
                    icon: 'üìä',
                    title: "Analytical characteristics?",
                    subtitle: "How complex are your analytical queries?",
                    condition: {1: 'analytical'},
                    options: [
                        { value: 'warehouse', title: 'Data Warehouse Needs', desc: 'Massive joins (10+), full table scans, >500TB working dataset' },
                        { value: 'realtime', title: 'Real-Time Analytics', desc: 'Lower latency analytics, moderate complexity' }
                    ]
                },
                // Business Model (before MongoDB Core decision) - INLINE
                {
                    id: 3,
                    isInline: true,
                    icon: 'üè¢',
                    title: "Business model?",
                    subtitle: "How do you serve your users?",
                    condition: {1: 'transactional'},
                    options: [
                        { value: 'internal', title: 'Internal Enterprise App', desc: 'Single organization, internal users' },
                        { value: 'saas', title: 'External Solution/Application', desc: 'External App or Application withMultiple customers (tenants)' }
                    ]
                },
                // Multi-Tenancy Strategy (only if SaaS) - INLINE
                {
                    id: 4,
                    isInline: true,
                    hasToggle: true,
                    toggleLabel: "Customize multi-tenancy strategy",
                    icon: 'üîê',
                    title: "Multi-tenancy isolation?",
                    subtitle: "Select your isolation strategy",
                    condition: {3: 'saas'},
                    options: [
                        { value: 'logical', title: 'Logical Isolation', desc: 'Shared collections, tenant_id field' },
                        { value: 'physical', title: 'Physical Isolation', desc: 'Dedicated nodes for VIP tenants' },
                        { value: 'silo', title: 'Silo (Complete Separation)', desc: 'Separate deployment per tenant (not recommended)' },
                        { value: 'na', title: 'Not Applicable', desc: 'Not multi tenant as it is not a SAAS' }
                    ]
                },
                // Team Skillset
                {
                    id: 5,
                    icon: 'üë•',
                    title: "Team skillset?",
                    subtitle: "What are your developers most comfortable with?",
                    options: [
                        { value: 'codefirst', title: 'Code-First Developers', desc: 'JavaScript, Python, Java - prefer APIs' },
                        { value: 'sqlfirst', title: 'SQL-First Engineers', desc: 'DBAs, data engineers - comfortable with SQL' }
                    ]
                },
                // Migration Intent
                {
                    id: 6,
                    icon: 'üîÑ',
                    title: "Migration status?",
                    subtitle: "Are you modernizing from an existing database?",
                    condition: {5: 'sqlfirst'},
                    options: [
                        { value: 'no', title: 'No, New Project', desc: 'Greenfield development' },
                        { value: 'yes', title: 'Yes, Migrating', desc: 'Modernizing from existing RDBMS' }
                    ]
                },
                // Migration Source (inline under Q6 if 'yes') - INLINE - WAS 6.5
                {
                    id: 7,
                    isInline: true,
                    icon: 'üì¶',
                    title: "Source database?",
                    subtitle: "Which database are you migrating from?",
                    condition: {6: 'yes'},
                    options: [
                        { value: 'oracle', title: 'Oracle', desc: 'Oracle Database modernization' },
                        { value: 'sqlserver', title: 'SQL Server', desc: 'Microsoft SQL Server modernization' },
                        { value: 'postgres', title: 'PostgreSQL flavours', desc: 'PostgreSQL modernization' },
                        { value: 'mysql', title: 'MySQL', desc: 'MySQL / MariaDB modernization' },
                        { value: 'db2', title: 'IBM Db2', desc: 'IBM Db2 modernization' },
                        { value: 'other', title: 'Other RDBMS', desc: 'Other relational database' }
                    ]
                },
                // Business Logic Location (Moved before ACID) - NOW Q8
                {
                    id: 8,
                    isInline: true,
                    icon: 'üíæ',
                    title: "Business logic location?",
                    subtitle: "Where is your business logic?/Where do you want your business logic?",
                    condition: {5: 'sqlfirst'}, // Show for all SQL-First teams
                    options: [
                        { value: 'database', title: 'In Database (SQL/PL-SQL)', desc: 'Stored procedures, triggers' },
                        { value: 'application', title: 'In Application Code', desc: 'Logic in app tier' }
                    ]
                },
                // ACID Requirements (for both developer types) - INLINE - NOW Q9
                {
                    id: 9,
                    isInline: true,
                    icon: 'üîí',
                    title: "ACID transaction needs?",
                    subtitle: "Do you need multi-table transactions?",
                    condition: [{5: 'sqlfirst'}, {5: 'codefirst'}],
                    options: [
                        { value: 'heavy', title: 'Transactions with normalized data model', desc: 'Complex multi-table (10+)  transactions' },
                        { value: 'moderate', title: 'Transactions with denormalized data model', desc: 'multi table transactions with few tables' }
                    ]
                },
                // Normalization Check (if heavy ACID) - INLINE - NOW Q10
                {
                    id: 10,
                    isInline: true,
                    icon: 'üìê',
                    title: "Data model rigidity?",
                    subtitle: "Is your data 3rd or 4th normal form?",
                    condition: {9: 'heavy'}, // Depends on Q9 (ACID)
                    options: [
                        { value: 'rigid', title: 'Highly Normalized', desc: '3NF/4NF, strict relational integrity' },
                        { value: 'optimizable', title: 'Already use Materialized Views for faster reads? i.e Denormalization friendly?', desc: 'Open to data model optimization' }
                    ]
                },
                // Traffic & Scale (Merged Q11 + Q12) - NOW Q11
                {
                    id: 11,
                    isInline: true,
                    icon: 'üìà',
                    title: "Expected scale & traffic?",
                    subtitle: "What is your data volume and write throughput?",
                    condition: [{9: 'moderate'}, {9: 'heavy'}],
                    options: [
                        { value: 'very-small', title: 'Very Small (Few GBs, <1k writes/sec)', desc: 'Startup, MVP, or low traffic' },
                        { value: 'small', title: 'Small (<2TB, <10k writes/sec)', desc: 'Moderate application' },
                        { value: 'large', title: 'Large (>2TB or >50k writes/sec)', desc: 'High-scale production (Consistent/Spiky Traffic)' },
                        { value: 'massive', title: 'Massive (Petabyte-scale)', desc: 'Huge datasets (Consistent/Spiky Traffic)' }
                    ]
                },
                // Data Distribution (Optional with Toggle) - Q13
                {
                    id: 13,
                    isInline: true,
                    hasToggle: true,
                    toggleLabel: "Customize sharding strategy",
                    icon: 'üóÇÔ∏è',
                    title: "Data distribution pattern?",
                    subtitle: "Select your sharding strategy",
                    condition: {11: ['large', 'massive']},
                    options: [
                        { value: 'distributed', title: 'Distributed Writes', desc: 'Uniform distribution across shards' },
                        { value: 'location', title: 'Geo-Partitioned', desc: 'Data locality by region/zone' },
                        { value: 'range', title: 'Range-Based', desc: 'Time-series or alphabetical grouping' }
                    ]
                },
                // Data Structure (moved from Q12) - NOW Q14
                {
                    id: 14,
                    icon: 'üìÇ',
                    title: "Data structure?",
                    subtitle: "How flexible is your schema?",
                    condition: [{5: 'codefirst'}, {5: 'sqlfirst'}, {1: 'analytical'}],
                    options: [
                        { value: 'document', title: 'Flexible & Hierarchical', desc: 'JSON-like, nested, frequent changes' },
                        { value: 'graph', title: 'Highly Connected / Graph', desc: 'Nodes and edges, complex relationships' },
                        { value: 'rigid', title: 'Rigid & Relational', desc: 'Fixed schema, normalized' }
                    ]
                },
                // Graph Depth (moved from Q13) - NOW Q15
                {
                    id: 15,
                    isInline: true,
                    icon: 'üï∏Ô∏è',
                    title: "Relationship depth?",
                    subtitle: "How deep are your relationship traversals?",
                    condition: {14: 'graph'},
                    options: [
                        { value: 'deep', title: 'Deep (>5 hops)', desc: 'Friend-of-friend-of-friend, unbounded traversals' },
                        { value: 'shallow', title: 'Shallow (‚â§3-5 hops)', desc: 'Simple relationships' }
                    ]
                },
                // Access Pattern (moved from Q14) - NOW Q16
                {
                    id: 16,
                    isInline: true,
                    icon: 'üîë',
                    title: "Access pattern?",
                    subtitle: "How do you access your data?",
                    condition: [{14: 'document'}, {15: 'shallow'}],
                    options: [
                        { value: 'simple', title: 'Simple ID Lookup', desc: 'Mostly get-by-ID, key-value style' },
                        { value: 'complex', title: 'Complex Queries', desc: 'Filtering, secondary indexes, aggregations' }
                    ]
                },
                // Latency (moved from Q15) - NOW Q17
                {
                    id: 17,
                    isInline: true,
                    icon: '‚ö°',
                    title: "Latency requirements?",
                    subtitle: "How fast do you need responses?",
                    condition: {16: 'simple'},
                    options: [
                        { value: 'submillisecond', title: 'Sub-millisecond (<1ms)', desc: 'Can tolerate some data loss for speed' },
                        { value: 'normal', title: 'Normal (1-10ms)', desc: 'Durability important' }
                    ]
                },
                
                // Advanced Features - STAYS Q18
                {
                    id: 18,
                    icon: 'üîç',
                    title: "Need advanced features?",
                    subtitle: "Select any that apply (or skip)",
                    multiselect: true,
                    options: [
                        { value: 'search', title: 'Full-Text Search', desc: 'Search engine capabilities' },
                        { value: 'ai', title: 'AI/Vector Search', desc: 'RAG, embeddings, semantic search' },
                        { value: 'streams', title: 'Real-Time Streams', desc: 'Change data capture, event processing' },
                        { value: 'timeseries', title: 'Time Series / IoT', desc: 'Sensor data, metrics over time' }
                    ],
                    allowSkip: true
                },
                // Search Scale (if search selected) - INLINE - WAS 18
                {
                    id: 19,
                    isInline: true,
                    icon: 'üîç',
                    title: "Search data scale?",
                    subtitle: "How much data needs to be searchable?",
                    condition: {18: ['search']},
                    options: [
                        { value: 'moderate', title: 'Moderate (< 3TB  size or 500GB active index size)', desc: 'Standard search needs' },
                        { value: 'petabyte', title: 'Petabyte-Scale', desc: 'Log analytics, massive search indices' }
                    ]
                },
                // Vector Scale (if AI/Vector Search selected) - INLINE - WAS 18.5
                {
                    id: 20,
                    isInline: true,
                    icon: 'üß†',
                    title: "Vector data scale?",
                    subtitle: "How many vectors do you need to store and search?",
                    condition: {18: ['ai']},
                    options: [
                        { value: 'small', title: '<100M vectors', desc: 'Agentic Memory, Agentic RAG, semantic search' },
                        { value: 'large', title: '>100M vectors', desc: 'Open Source Indexing etc' }
                    ]
                },
                // Deployment Location - WAS 19
                {
                    id: 21,
                    icon: '‚òÅÔ∏è',
                    title: "Deployment location?",
                    subtitle: "Where can your data live?",
                    options: [
                        { value: 'cloud', title: 'Cloud/hybrid-multi cloud', desc: 'AWS/Azure/GCP managed infrastructure' },
                        { value: 'onprem', title: 'On-Premise', desc: 'Private infrastructure' }
                    ]
                },
                // Security Level (Toggle) - INLINE - WAS 19.5
                {
                    id: 22,
                    isInline: true,
                    hasToggle: true,
                    toggleLabel: "Enable advanced security",
                    icon: 'üîí',
                    title: "Security & compliance level?",
                    subtitle: "Select your security requirements",
                    condition: {21: ['cloud', 'onprem']},
                    options: [
                        { value: 'standard', title: 'Standard Security', desc: 'TLS/SSL encryption in transit' },
                        { value: 'strict', title: 'Strict Compliance', desc: 'HIPAA/PCI, field-level encryption at rest' }
                    ]
                },
                // Mobile / Edge - WAS 20
                {
                    id: 23,
                    isInline: true,
                    icon: 'üì±',
                    title: "Offline-First Requirement?",
                    subtitle: "Do devices need to work without internet?",
                    condition: {0: 'mobile'},
                    options: [
                        { value: 'yes', title: 'Yes, Offline Sync', desc: 'Local DB with auto-sync to cloud' },
                        { value: 'no', title: 'No, Always Online', desc: 'Direct API calls to backend' }
                    ]
                }
            ],
            answers: {},
            currentStep: 0
        };

        // Mode switching
        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const mode = tab.dataset.mode;
                switchMode(mode);
            });
        });

        /**
         * Switch between Guided Path and Expert View modes
         * @param {string} mode - Mode to switch to ('guided' or 'expert')
         */
        function switchMode(mode) {
            // Update tabs
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // Update containers
            document.querySelectorAll('.mode-container').forEach(c => c.classList.remove('active'));
            document.getElementById(`${mode}-mode`).classList.add('active');

            if (mode === 'guided') {
                renderWizardStep();
            } else if (mode === 'expert') {
                // Re-render Mermaid diagram and re-init pan-zoom
                setTimeout(() => {
                    if (window.mermaid) {
                        mermaid.init(undefined, '.mermaid');
                        setupPanZoom(); // Re-attach pan-zoom to new SVG
                    }
                }, 100);
            }
        }

        // ... (renderWizardStep and other wizard functions remain here) ...

        /**
         * Setup pan and zoom functionality for Mermaid diagram
         * Attempts initialization with timeout to prevent memory leaks
         */
        function setupPanZoom() {
            // Clear any existing instance
            if (panZoomInstance) {
                panZoomInstance.destroy();
                panZoomInstance = null;
            }

            let attempts = 0;
            const maxAttempts = 50; // 5 seconds max
            
            const interval = setInterval(() => {
                attempts++;
                const svg = document.querySelector('.mermaid svg');
                
                if (svg && svg.getBoundingClientRect().height > 10) {
                    clearInterval(interval);
                    svg.style.height = '100%';
                    svg.style.width = '100%';
                    svg.style.maxWidth = 'none';

                    panZoomInstance = svgPanZoom(svg, {
                        zoomEnabled: true,
                        controlIconsEnabled: false,
                        fit: true,
                        center: true,
                        minZoom: 0.1,
                        maxZoom: 10
                    });
                    panZoomInstance.resize();
                    panZoomInstance.fit();
                    panZoomInstance.center();
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    console.error('Failed to initialize pan-zoom: SVG not found after 5 seconds');
                }
            }, 100);
        }

        // Initial setup
        setupPanZoom();

        /**
         * Handle keyboard navigation in wizard mode
         * Supports arrow keys, Enter, Escape, Tab, and number keys (1-9)
         * @param {KeyboardEvent} e - Keyboard event
         */
        function handleKeyboardNavigation(e) {
            // Only active in guided mode
            const guidedMode = document.getElementById('guided-mode');
            if (!guidedMode || !guidedMode.classList.contains('active')) return;
            
            // Get all visible options (main and sub-questions)
            const options = Array.from(document.querySelectorAll('.wizard-option:not([style*="display: none"])'));
            if (options.length === 0) return;
            
            // Find currently focused option
            let currentIndex = options.findIndex(opt => opt.classList.contains('keyboard-focused'));
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    moveFocus(options, currentIndex, 1);
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    moveFocus(options, currentIndex, -1);
                    break;
                    
                case 'Enter':
                    e.preventDefault();
                    if (currentIndex >= 0) {
                        options[currentIndex].click();
                    } else if (options.length > 0) {
                        // If nothing focused, select first option
                        options[0].click();
                    }
                    break;
                    
                case 'Escape':
                    e.preventDefault();
                    const prevBtn = document.querySelector('.wizard-btn.secondary');
                    if (prevBtn && !prevBtn.disabled) {
                        prevStep();
                    }
                    break;
                    
                case 'Tab':
                    // Let Tab work naturally to focus Next/Skip buttons
                    // Remove keyboard focus from options
                    options.forEach(opt => opt.classList.remove('keyboard-focused'));
                    break;
                    
                // Number keys for quick selection
                case '1': case '2': case '3': case '4': case '5':
                case '6': case '7': case '8': case '9':
                    e.preventDefault();
                    const idx = parseInt(e.key) - 1;
                    if (idx < options.length) {
                        moveFocus(options, currentIndex, idx - currentIndex);
                        setTimeout(() => options[idx].click(), 100);
                    }
                    break;
            }
        }

        /**
         * Move keyboard focus between wizard options
         * @param {HTMLElement[]} options - Array of option elements
         * @param {number} currentIndex - Current focused index (-1 if none)
         * @param {number} direction - Direction to move (positive or negative)
         */
        function moveFocus(options, currentIndex, direction) {
            // Remove current focus
            options.forEach(opt => opt.classList.remove('keyboard-focused'));
            
            // Calculate new index
            let newIndex = currentIndex + direction;
            
            // Handle wraparound
            if (newIndex < 0) newIndex = options.length - 1;
            if (newIndex >= options.length) newIndex = 0;
            
            // Add new focus
            options[newIndex].classList.add('keyboard-focused');
            options[newIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Attach keyboard navigation listener
        document.addEventListener('keydown', handleKeyboardNavigation);

        /**
         * Zoom in on the expert view diagram
         */
        function zoomIn() { if(panZoomInstance) panZoomInstance.zoomIn(); }
        
        /**
         * Zoom out on the expert view diagram
         */
        function zoomOut() { if(panZoomInstance) panZoomInstance.zoomOut(); }
        
        /**
         * Reset zoom and center the expert view diagram
         */
        function resetZoom() { if(panZoomInstance) { panZoomInstance.resetZoom(); panZoomInstance.center(); } }
       
        window.addEventListener('resize', function(){
            if(panZoomInstance) { panZoomInstance.resize(); panZoomInstance.fit(); panZoomInstance.center(); }
        });

        /**
         * Check if a question should be displayed based on its conditions
         * Handles both single conditions and array of condition objects
         * @param {Object} question - Question object with optional condition property
         * @returns {boolean} True if question should be shown
         */
        function shouldShowQuestion(question) {
            if (!question || !question.condition) return true;
            
            try {
                // Skip toggle questions if toggle is OFF
                if (question.hasToggle) {
                    const toggleId = `toggle-${question.id}`;
                    const isToggleOn = window[toggleId] || false;
                    if (!isToggleOn) {
                        return false; // Don't show as separate question if toggle is OFF
                    }
                }

                const checkCondition = (cond) => {
                    if (!cond || typeof cond !== 'object') return false;
                    
                    for (let [qId, expectedValue] of Object.entries(cond)) {
                        const qIdInt = parseInt(qId);
                        if (isNaN(qIdInt)) {
                            console.warn(`Invalid question ID in condition: ${qId}`);
                            return false;
                        }
                        
                        const answer = wizardData.answers[qIdInt];
                        if (Array.isArray(expectedValue)) {
                            if (!answer || !Array.isArray(answer)) return false;
                            if (!expectedValue.some(val => answer.includes(val))) return false;
                        } else {
                            if (answer !== expectedValue) return false;
                        }
                    }
                    return true;
                };

                if (Array.isArray(question.condition)) {
                    return question.condition.some(cond => checkCondition(cond));
                }
                return checkCondition(question.condition);
            } catch (error) {
                console.error('Error checking condition:', error, 'Question:', question);
                return false;
            }
        }

        /**
         * Render the current wizard step with question and options
         * Handles inline sub-questions, progress bar, and navigation buttons
         */
        function renderWizardStep() {
            const step = wizardData.currentStep;
            const question = wizardData.questions[step];
            const totalSteps = wizardData.questions.length;

            // Update progress bar and percentage text
            const progress = ((step + 1) / totalSteps) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${Math.round(progress)}%`;

            // Render question card
            const wizardContent = document.getElementById('wizard-content');
            const isMultiSelect = question.multiselect || false;
            const selectedValues = wizardData.answers[question.id] || (isMultiSelect ? [] : null);

            // Build inline sub-questions recursively
            let subQuestionHTML = '';
            let canAdvance = selectedValues;

            if (selectedValues) {
                subQuestionHTML = renderSubQuestions(question.id, selectedValues);
                canAdvance = validateSubQuestionChain(question.id, selectedValues);
            }

            wizardContent.innerHTML = `
                <div class="wizard-card">
                    <div class="wizard-icon">${question.icon}</div>
                    <h2 class="wizard-title">${question.title}</h2>
                    <div class="wizard-subtitle">${question.subtitle}</div>
                    <div class="wizard-options">
                        ${question.options.map(opt => {
                            const isSelected = isMultiSelect 
                                ? selectedValues.includes(opt.value)
                                : selectedValues === opt.value;
                            return `
                                <div class="wizard-option ${isSelected ? 'selected' : ''}" 
                                     onclick="selectOption(${question.id}, '${opt.value}', ${isMultiSelect})"
                                     style="${isSelected ? 'border-color: #00ED64; background: #fff;' : ''}">
                                    <div class="wizard-option-title">${isMultiSelect ? (isSelected ? '‚úì ' : '‚òê ') : ''}${sanitizeHTML(opt.title)}</div>
                                    <div class="wizard-option-desc">${sanitizeHTML(opt.desc)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${subQuestionHTML}
                    <div class="wizard-nav">
                        ${step > 0 ? '<button class="wizard-btn secondary" onclick="prevStep()">‚Üê Back</button>' : ''}
                        ${question.allowSkip ? '<button class="wizard-btn secondary" onclick="skipStep()">Skip</button>' : ''}
                        <button class="wizard-btn primary" onclick="nextStep()" 
                                ${!canAdvance ? 'disabled' : ''}>
                            ${step < totalSteps - 1 ? 'Next ‚Üí' : 'See Recommendation'}
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Recursively render sub-questions that depend on parent answers
         * @param {number} parentQuestionId - ID of parent question
         * @param {string} parentValue - Selected value from parent question
         * @returns {string} HTML string of sub-questions
         */
        function renderSubQuestions(parentQuestionId, parentValue) {
            let html = '';
            
            // Find all questions that depend on this parent AND are marked inline
            const subQuestions = wizardData.questions.filter(q => {
                if (!q.isInline) return false; // Only render explicitly inline questions
                if (!q.condition) return false;
                if (typeof q.condition !== 'object') return false;
                
                // Handle array conditions: check if ANY condition has the parent
                if (Array.isArray(q.condition)) {
                    return q.condition.some(cond => cond[parentQuestionId] !== undefined);
                }
                
                // Handle object conditions: check if condition has the parent
                return q.condition[parentQuestionId] !== undefined;
            });

            // Get sub-questions that should be shown
            const visibleSubQuestions = subQuestions.filter(subQ => {
                if (Array.isArray(subQ.condition)) {
                    // For array conditions, check if ANY condition matches
                    return subQ.condition.some(cond => {
                        const conditionValue = cond[parentQuestionId];
                        if (conditionValue === undefined) return false;
                        
                        if (Array.isArray(conditionValue)) {
                            return Array.isArray(parentValue) 
                                ? parentValue.some(v => conditionValue.includes(v))
                                : conditionValue.includes(parentValue);
                        }
                        return conditionValue === parentValue;
                    });
                } else {
                    // For object conditions
                    const conditionValue = subQ.condition[parentQuestionId];
                    if (Array.isArray(conditionValue)) {
                        return Array.isArray(parentValue) 
                            ? parentValue.some(v => conditionValue.includes(v))
                            : conditionValue.includes(parentValue);
                    }
                    return conditionValue === parentValue;
                }
            });

            // Render each visible sub-question and its children
            for (const subQ of visibleSubQuestions) {
                const subSelectedValues = wizardData.answers[subQ.id] || (subQ.multiselect ? [] : null);
                const subIsMultiSelect = subQ.multiselect || false;
                
                // Check if this sub-question has a toggle
                if (subQ.hasToggle) {
                    const toggleId = `toggle-${subQ.id}`;
                    const isToggleOn = window[toggleId] || false;
                    
                    html += `
                        <div class="sub-question-section" data-question-id="${subQ.id}">
                            <div class="toggle-container" onclick="toggleSubQuestion('${toggleId}', ${subQ.id})">
                                <div class="toggle-label">${subQ.toggleLabel || 'Show options'}</div>
                                <div class="toggle-switch ${isToggleOn ? 'active' : ''}" id="${toggleId}">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                            <div id="content-${subQ.id}" style="display: ${isToggleOn ? 'block' : 'none'}">
                                <div class="inline-question-header">
                                    <div class="inline-question-icon">${subQ.icon}</div>
                                    <div>
                                        <div class="inline-question-title">${subQ.title}</div>
                                        <div class="inline-question-subtitle">${subQ.subtitle}</div>
                                    </div>
                                </div>
                                <div class="wizard-options">
                                    ${subQ.options.map(opt => {
                                        const isSelected = subIsMultiSelect 
                                            ? (subSelectedValues || []).includes(opt.value)
                                            : subSelectedValues === opt.value;
                                        return `
                                            <div class="wizard-option ${isSelected ? 'selected' : ''}" 
                                                 onclick="selectOption(${subQ.id}, '${opt.value}', ${subIsMultiSelect})"
                                                 style="${isSelected ? 'border-color: #00ED64; background: #fff;' : ''}">
                                                <div class="wizard-option-title">${subIsMultiSelect ? (isSelected ? '‚úì ' : '‚òê ') : ''}${sanitizeHTML(opt.title)}</div>
                                                <div class="wizard-option-desc">${sanitizeHTML(opt.desc)}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Standard rendering for non-toggle sub-questions
                    html += `
                        <div class="sub-question-section" data-question-id="${subQ.id}">
                            <div class="inline-question-header">
                                <div class="inline-question-icon">${subQ.icon}</div>
                                <div>
                                    <div class="inline-question-title">${subQ.title}</div>
                                    <div class="inline-question-subtitle">${subQ.subtitle}</div>
                                </div>
                            </div>
                            <div class="wizard-options">
                                ${subQ.options.map(opt => {
                                    const isSelected = subIsMultiSelect 
                                        ? (subSelectedValues || []).includes(opt.value)
                                        : subSelectedValues === opt.value;
                                    return `
                                        <div class="wizard-option ${isSelected ? 'selected' : ''}" 
                                             onclick="selectOption(${subQ.id}, '${opt.value}', ${subIsMultiSelect})"
                                             style="${isSelected ? 'border-color: #00ED64; background: #fff;' : ''}">
                                            <div class="wizard-option-title">${subIsMultiSelect ? (isSelected ? '‚úì ' : '‚òê ') : ''}${sanitizeHTML(opt.title)}</div>
                                            <div class="wizard-option-desc">${sanitizeHTML(opt.desc)}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Recursively render nested sub-questions
                html += subSelectedValues ? renderSubQuestions(subQ.id, subSelectedValues) : '';
            }

            return html;
        }

        /**
         * Validate that all required sub-questions in a chain are answered
         * @param {number} questionId - ID of parent question to check
         * @param {string|string[]} questionValue - Value(s) of the parent question
         * @returns {boolean} True if all sub-questions are answered
         */
        function validateSubQuestionChain(questionId, questionValue) {
            // Find all descendants that must be answered
            const findRequiredDescendants = (qId, val) => {
                const descendants = [];
                const subQuestions = wizardData.questions.filter(q => {
                    if (!q.isInline) return false; // Only check explicitly inline questions
                    if (!q.condition) return false;
                    return q.condition[qId] !== undefined;
                });

                for (const subQ of subQuestions) {
                    const conditionValue = subQ.condition[qId];
                    const matches = Array.isArray(conditionValue)
                        ? (Array.isArray(val) ? val.some(v => conditionValue.includes(v)) : conditionValue.includes(val))
                        : conditionValue === val;
                    
                    if (matches) {
                        // Check if this is a toggle question and if it's OFF
                        if (subQ.hasToggle) {
                            const toggleId = `toggle-${subQ.id}`;
                            const isToggleOn = window[toggleId] || false;
                            if (!isToggleOn) {
                                continue; // Skip this branch if toggle is OFF
                            }
                        }

                        descendants.push(subQ);
                        const subVal = wizardData.answers[subQ.id];
                        if (subVal) {
                            descendants.push(...findRequiredDescendants(subQ.id, subVal));
                        }
                    }
                }
                return descendants;
            };

            const descendants = findRequiredDescendants(questionId, questionValue);
            
            // All required descendants must have answers
            return descendants.length === 0 || descendants.every(d => wizardData.answers[d.id]);
        }

        /**
         * Handle option selection in wizard
         * Validates input and manages multiselect vs single-select behavior
         * @param {number} questionId - ID of the question
         * @param {string} value - Value of selected option
         * @param {boolean} isMultiSelect - Whether question allows multiple selections
         */
        function selectOption(questionId, value, isMultiSelect) {
            try {
                const question = wizardData.questions.find(q => q.id === questionId);
                if (!question) {
                    console.error('Invalid question ID:', questionId);
                    return;
                }
                
                // Validate value is in allowed options
                const validValues = question.options.map(opt => opt.value);
                if (!validValues.includes(value)) {
                    console.error('Invalid option value:', value);
                    return;
                }
                
                if (isMultiSelect) {
                    if (!wizardData.answers[questionId]) {
                        wizardData.answers[questionId] = [];
                    }
                    const index = wizardData.answers[questionId].indexOf(value);
                    if (index > -1) {
                        wizardData.answers[questionId].splice(index, 1);
                    } else {
                        wizardData.answers[questionId].push(value);
                    }
                } else {
                    // If changing a parent answer, clear dependent answers
                    if (wizardData.answers[questionId] !== value) {
                        clearDependentAnswers(questionId);
                    }
                    wizardData.answers[questionId] = value;
                }
                
                // PRODUCTION ENHANCEMENT: Track user answer via analytics
                Analytics.trackQuestionAnswered(questionId, wizardData.answers[questionId]);
                Logger.debug(`Question answered`, {questionId, answer: wizardData.answers[questionId]});
                
                renderWizardStep();
                saveWizardState(); // Auto-save after selection
            } catch (error) {
                console.error('Error in selectOption:', error);
                Logger.error('selectOption error', {questionId, value, error: error.message});
            }
        }

        /**
         * Toggle visibility of optional sub-question
         * @param {string} toggleId - ID of the toggle element
         * @param {number} questionId - ID of the question to toggle
         */
        function toggleSubQuestion(toggleId, questionId) {
            // Toggle state
            window[toggleId] = !window[toggleId];
            
            // Re-render to update validation state (Next button) and UI
            renderWizardStep();
        }

        /**
         * Clear answers for questions that depend on a changed parent question
         * Only clears if the dependent question is no longer valid
         * @param {number} parentId - ID of parent question that changed
         */
        function clearDependentAnswers(parentId) {
            const dependents = wizardData.questions.filter(q => {
                if (!q.condition) return false;
                if (Array.isArray(q.condition)) {
                    return q.condition.some(cond => cond[parentId] !== undefined);
                }
                return q.condition[parentId] !== undefined;
            });

            dependents.forEach(q => {
                // Only clear if question is no longer valid with new parent value
                if (!shouldShowQuestion(q)) {
                    delete wizardData.answers[q.id];
                    clearDependentAnswers(q.id); // Recursive clear
                }
            });
        }


        /**
         * Advance to the next question in the wizard
         * Automatically skips questions that don't meet conditions
         */
        function nextStep() {
            const nextQuestion = findNextQuestion(wizardData.currentStep + 1);
            if (nextQuestion !== null) {
                wizardData.currentStep = nextQuestion;
                renderWizardStep();
                saveWizardState(); // Auto-save after advancing
            } else {
                showRecommendation();
            }
        }

        /**
         * Find the next visible question starting from a given index
         * Skips questions that don't meet their display conditions
         * @param {number} fromIndex - Index to start searching from
         * @returns {number|null} Index of next visible question or null if none
         */
        function findNextQuestion(fromIndex) {
            for (let i = fromIndex; i < wizardData.questions.length; i++) {
                // Skip inline sub-questions - they're handled inline
                if (wizardData.questions[i].isInline) {
                    continue;
                }
                if (shouldShowQuestion(wizardData.questions[i])) {
                    return i;
                }
            }
            return null; // No more questions
        }

        /**
         * Go back to the previous question in the wizard
         * Automatically skips questions that don't meet conditions
         */
        function prevStep() {
            if (wizardData.currentStep > 0) {
                // Find the previous visible question, skipping inline sub-questions
                for (let i = wizardData.currentStep - 1; i >= 0; i--) {
                    const question = wizardData.questions[i];
                    
                    // Skip inline sub-questions - they should never be navigation targets
                    if (question.isInline) {
                        continue;
                    }
                    
                    if (shouldShowQuestion(question)) {
                        wizardData.currentStep = i;
                        renderWizardStep();
                        saveWizardState(); // Auto-save after going back
                        return;
                    }
                }
            }
        }

        /**
         * Skip the current question
         * Sets answer to empty array for multiselect, null for single-select
         */
        function skipStep() {
            const question = wizardData.questions[wizardData.currentStep];
            wizardData.answers[question.id] = question.multiselect ? [] : null;
            nextStep(); // nextStep will auto-save
        }

        /**
         * Determine primary database recommendation based on answers
         * Core recommendation engine logic with multiple decision paths
         * @param {Object} answers - Object mapping question IDs to answer values
         * @returns {Object} Object with 'db' (database name) and 'reason' (decision path taken)
         */
        function determinePrimaryDB(answers) {
            // Validate required answers
            if (!answers[Q.USE_CASE] || !answers[Q.WORKLOAD]) {
                return { db: "MongoDB Atlas", reason: "default" };
            }
            
            const useCase = answers[Q.USE_CASE];
            const workload = answers[Q.WORKLOAD];
            const dataStructure = answers[Q.DATA_STRUCTURE];
            const graphDepth = answers[Q.GRAPH_DEPTH];
            const teamSkill = answers[Q.TEAM_SKILL];
            const migrationStatus = answers[Q.MIGRATION_STATUS];
            const migrationSource = answers[Q.MIGRATION_SOURCE];
            const migration = (migrationStatus === 'yes' && migrationSource) ? migrationSource : migrationStatus;
            const acidNeeds = answers[Q.ACID_NEEDS];
            const normalization = answers[Q.NORMALIZATION];
            
            // New Q11 Logic: Traffic & Scale merged
            const trafficAnswer = answers[Q.TRAFFIC_PATTERN];
            const isLargeScale = trafficAnswer === 'large' || trafficAnswer === 'massive';
            const isMassive = trafficAnswer === 'massive';
            
            const analyticalNuance = answers[Q.ANALYTICAL_NUANCE];
            
            // IoT workloads - Consider scale and team preferences
            if (useCase === 'iot') {
                if (isMassive) {
                    // Massive IoT needs specialized time-series databases + operational layer
                    return { db: "InfluxDB / Time Series Warehouse + MongoDB (Operational)", reason: "iot-massive" };
                } else if (trafficAnswer === 'very-small' && teamSkill === 'sqlfirst' && acidNeeds === 'heavy' && normalization === 'rigid') {
                    // Very small IoT with strong SQL/relational requirements
                    return { db: "TimescaleDB (PostgreSQL)", reason: "iot-small-sql" };
                } else {
                    // Small to Large IoT ‚Üí MongoDB Time Series
                    return { db: "MongoDB Time Series", reason: "iot-timeseries" };
                }
            }
            
            // Analytical path
            if (workload === 'analytical') {
                if (dataStructure === 'graph' && graphDepth === 'deep') {
                    return { db: "Neo4j Graph Data Science / TigerGraph", reason: "analytical-deep-graph" };
                } else if (dataStructure === 'graph') {
                    return { db: "MongoDB (Aggregation Pipeline)", reason: "analytical-shallow-graph" };
                } else if (analyticalNuance === 'warehouse' || isMassive) {
                    return { db: "Data Warehouse", reason: "analytical-warehouse" };
                } else {
                    const isOnPrem = answers[Q.DEPLOYMENT] === 'onprem';
                    if (isOnPrem) {
                        return { db: "MongoDB (Read-Only Nodes) scaled out for analytics or Data Warehouse", reason: "analytical-realtime-onprem" };
                    } else {
                        return { db: "MongoDB Atlas (Analytics Nodes) or Data Warehouse", reason: "analytical-realtime-cloud" };
                    }
                }
            }
            
            // Transactional path - Graph data structures
            if (dataStructure === 'graph') {
                if (graphDepth === 'deep') {
                    return { db: "MongoDB (Operational) + Neo4j (Graph Database)", reason: "transactional-deep-graph" };
                } else {
                    return { db: "MongoDB", reason: "transactional-shallow-graph" };
                }
            }
            
            // SQL-First team path
            if (teamSkill === 'sqlfirst') {
                const businessLogic = answers[Q.BUSINESS_LOGIC];
                
                // Check business logic preference FIRST (before scale considerations)
                // If they NEED stored procedures, recommend RDBMS even if suboptimal at scale
                if (businessLogic === 'database') {
                    if (isLargeScale) {
                        // Large scale + stored procedures = challenging combination
                        return { db: "RDBMS (with limitations) or NewSQL", reason: "sql-database-logic-large-scale" };
                    } else {
                        // Small/medium scale + stored procedures = perfect for RDBMS
                        return { db: "RDBMS", reason: "sql-database-logic" };
                    }
                }
                
                // If app-tier logic OR no preference, consider ACID/scale normally
                if (migration !== 'no' && acidNeeds === 'heavy' && normalization === 'rigid') {
                    // migration is now the source DB directly: 'oracle', 'sqlserver', 'postgres', 'mysql', 'db2', 'other'
                    const dbMap = { oracle: 'Oracle', sqlserver: 'SQL Server', postgres: 'PostgreSQL', mysql: 'MySQL', db2: 'IBM Db2', other: 'RDBMS' };
                    const source = dbMap[migration] || 'RDBMS';
                    return { db: "MongoDB (with migration support)", reason: "sql-modernization", source: source };
                } else if (acidNeeds === 'heavy' && normalization === 'rigid') {
                    // CRITICAL: Consider scale for RDBMS recommendation
                    // Large/Massive scale cannot survive on traditional RDBMS
                    if (isLargeScale) {
                        return { db: "MongoDB (with SQL drivers) or NewSQL", reason: "sql-heavy-acid-large-scale" };
                    } else {
                        // Very-small/Small can use traditional RDBMS
                        return { db: "RDBMS", reason: "sql-heavy-acid" };
                    }
                } else {
                    return { db: "MongoDB (with SQL drivers and Relational Migrator)", reason: "sql-moderate" };
                }
            }
            
            // Code-First team path
            if (dataStructure === 'document') {
                return { db: "MongoDB", reason: "codefirst-document" };
            } else if (dataStructure === 'rigid') {
                return { db: "MongoDB (with Schema Validation)", reason: "codefirst-rigid" };
            }
            
            // Default fallback with deployment awareness
            const isOnPrem = answers[Q.DEPLOYMENT] === 'onprem';
            return { db: isOnPrem ? "MongoDB" : "MongoDB Atlas", reason: "default" };
        }

        // Recommendation engine (CONCERN #5 & #6: Error handling + Refactored logic)
        /**
         * Generate and display the final database recommendation
         * Analyzes all answers to suggest optimal database architecture
         */
        function showRecommendation() {
            try {
                // Clear saved state since wizard is complete
                clearWizardState();
                // Force progress bar to 100% on completion
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                if (progressFill) progressFill.style.width = '100%';
                if (progressText) progressText.textContent = '100%';

                const answers = wizardData.answers;
                
                // Note: Recommendation tracking moved to end of function after all details are computed
                
                // Default recommendation structure
                let dbChoice = "MongoDB Atlas";
                let architecture = "Replica Set";
                let deployment = "Standard Cloud Cluster";
                let features = [];
                let reasoningPoints = []; // Changed: Use array for better formatting
                let useCase = answers[Q.USE_CASE];
                
                // Get primary DB choice using helper function
                const primaryDB = determinePrimaryDB(answers);
                dbChoice = primaryDB.db;
                const reason = primaryDB.reason;
                
                // Handle special reasons
                if (reason === 'log-analytics') {
                    architecture = "Search / Log Analytics Cluster";
                    reasoningPoints.push("For petabyte-scale log analytics, dedicated search engines like Elasticsearch are often preferred, though MongoDB can handle logs with Time Series collections and moderate size log loads on top of search (< 3TB size or 500GB active index size).");
                    features.push("Time Series", "Search Indexing");
                } else if (reason === 'iot-timeseries') {
                    architecture = "Time Series Optimized Cluster";
                    reasoningPoints.push("IoT workloads require high write throughput and efficient storage of time-stamped data. MongoDB Time Series Collections use an intelligent **bucket pattern** that groups measurements within time windows, enabling extremely efficient data compression (often 10x+ storage reduction). This makes MongoDB ideal for IoT sensor data, metrics, and event streams at massive scale.");
                    features.push("Time Series Collections", "Data Tiering (Hot/Cold)", "Columnar Compression");
                } else if (reason === 'iot-massive') {
                    architecture = "Hybrid: Time Series Warehouse + Operational Layer";
                    reasoningPoints.push("Petabyte-scale IoT requires specialized time-series databases (InfluxDB, TimescaleDB) or Data Warehouses optimized for time-series analytics, combined with MongoDB for operational queries, device management, and real-time processing.");
                    features.push("Time Series Warehouse", "InfluxDB / TimescaleDB", "MongoDB Operational Layer", "Data Federation");
                } else if (reason === 'iot-small-sql') {
                    architecture = "TimescaleDB (PostgreSQL Extension)";
                    reasoningPoints.push("For small-scale IoT with strong SQL/relational requirements, TimescaleDB provides time-series optimizations on top of PostgreSQL, giving you SQL familiarity with time-series performance. (Note: Extensions like TimescaleDB are not maintained by the core PostgreSQL team and may have different support lifecycles).");
                    features.push("TimescaleDB", "PostgreSQL Compatibility", "Continuous Aggregates");
                } else if (reason === 'analytical-deep-graph') {
                    architecture = "Graph Analytics Engine";
                    reasoningPoints.push("Deep graph analytics (centrality, community detection, pathfinding >5 hops) require specialized graph algorithms and engines like Neo4j GDS.");
                    features.push("Graph Algorithms", "Network Analysis");
                } else if (reason === 'analytical-shallow-graph') {
                    architecture = "Operational Analytics with $graphLookup";
                    reasoningPoints.push("For shallower graph analytics (hierarchies, simple connections), MongoDB's aggregation framework and $graphLookup provide efficient analysis without a separate graph engine.");
                    features.push("$graphLookup", "Recursive Search");
                } else if (reason === 'analytical-warehouse') {
                    architecture = "Columnar Storage MPP";
                    reasoningPoints.push("Massive joins, full table scans, >500TB working datasets, or petabyte-scale analytics require a dedicated Data Warehouse.");
                } else if (reason === 'analytical-realtime-cloud') {
                    architecture = "Operational Analytics";
                    reasoningPoints.push("For real-time analytics with moderate complexity and scale, MongoDB Atlas Analytics Nodes or purpose built datawarehouses work well as performance requirements mount.");
                } else if (reason === 'analytical-realtime-onprem') {
                    architecture = "Operational Analytics";
                    reasoningPoints.push("For real-time analytics with moderate complexity and scale, MongoDB Read-Only Nodes (self-managed) or on-premise data warehouses work well as performance requirements mount.");
                } else if (reason === 'transactional-deep-graph') {
                    architecture = "Hybrid: Document + Graph Model";
                    reasoningPoints.push("Deep relationship traversals (>5 hops) require a dedicated graph database. MongoDB handles operational data while Neo4j excels at complex graph queries.");
                } else if (reason === 'transactional-shallow-graph') {
                    reasoningPoints.push("Shallow graph relationships (‚â§3-5 hops) are efficiently handled by MongoDB's document model.");
                } else if (reason === 'sql-modernization') {
                    architecture = "Replica Set (3-Node)";
                    reasoningPoints.push(`Modernization Path: While your workload has heavy ACID requirements and rigid schemas, you've indicated a desire to modernize from ${primaryDB.source}. MongoDB with Document ACID transactions, Schema Validation, and tools like Relational Migrator can help transition away from traditional RDBMS.`);
                } else if (reason === 'sql-heavy-acid') {
                    const traffic = answers[Q.TRAFFIC_PATTERN];
                    if (traffic === 'large' || traffic === 'massive') {
                        architecture = "Sharded Relational / NewSQL";
                        reasoningPoints.push("High-volume, strictly normalized, heavy ACID workloads need scalable SQL (NewSQL) or sharded RDBMS.");
                    } else {
                        architecture = "Standard RDBMS";
                        reasoningPoints.push("Traditional RDBMS is perfect for moderate scale, structured data, and SQL-first teams.");
                    }
                } else if (reason === 'sql-heavy-acid-large-scale') {
                    architecture = "Sharded Relational / NewSQL or MongoDB (with SQL drivers)";
                    reasoningPoints.push("Large-scale, strictly normalized, heavy ACID workloads cannot survive on traditional RDBMS. Consider NewSQL (e.g., CockroachDB, TiDB) for distributed SQL, or MongoDB with SQL drivers and document design patterns for scalability.");
                } else if (reason === 'sql-database-logic') {
                    architecture = "Traditional RDBMS with Stored Procedures";
                    reasoningPoints.push("For workloads requiring business logic in the database (stored procedures, triggers, functions),RDBMS do provide mature, battle-tested procedural languages (PL/pgSQL, T-SQL) with rich ecosystems. MongoDB supports server-side JavaScript but is application-logic-first by desig which is more extensible.");
                } else if (reason === 'sql-database-logic-large-scale') {
                    architecture = "RDBMS(with scaling caveats) or NewSQL or MongoDB (with Rearchitecturing)";
                    reasoningPoints.push("‚ö†Ô∏è CHALLENGING COMBINATION: You need stored procedures at large scale. Traditional RDBMS struggle with horizontal scaling beyond sharding limits. Consider: (1) Re-architecting to move business logic to application tier with MongoDB.  (2) NewSQL databases like CockroachDB/Spanner for handling scale (limited stored procedure support), or (3) Shard traditional rdbms (ex : PostgreSQL with Citus extension for distributed queries - Note: 3rd party extensions are not maintained by core PG team)");
                } else if (reason === 'sql-moderate') {
                    reasoningPoints.push("Even with SQL skills, if the data model can be optimized or scale is high, MongoDB is a strong candidate using tools like SQL drivers and Relational Migrator.");
                } else if (reason === 'codefirst-document') {
                    reasoningPoints.push("Flexible JSON schema + Code-First team is the ideal fit for MongoDB.");
                } else if (reason === 'codefirst-rigid') {
                    reasoningPoints.push("You can enforce strict schema validation in MongoDB while enjoying the developer experience of a document model.");
                }

            // --- ARCHITECTURE REFINEMENTS ---
            
            // Determine scale and traffic characteristics from new Q11
            const trafficValue = answers[Q.TRAFFIC_PATTERN];
            const isMassive = trafficValue === 'massive';
            const isLarge = trafficValue === 'large' || isMassive;
            const isSpiky = isLarge; // User rule: Large/Massive assumes spiky
            const isVerySmall = trafficValue === 'very-small';

            // PETABYTE TRANSACTIONAL - Multi-tier Architecture
            if (dbChoice.includes("MongoDB") && answers[Q.WORKLOAD] === 'transactional' && isMassive) {
                if (answers[Q.DEPLOYMENT] !== 'onprem') {
                    dbChoice = "MongoDB (Hot Operational) + Online Archive (Cold) + Data Warehouse (Reporting)";
                    architecture = "Multi-tier: Hot Cluster + Cloud Archive + Analytics Layer";
                    reasoningPoints = ["Petabyte-scale transactional workloads require a tiered architecture. MongoDB handles hot operational data (recent transactions), Online Archive stores cold historical data cost-effectively in S3, and a Data Warehouse provides optimized reporting across the full dataset."]; // Reset reasoning
                    features.push("Online Archive", "Atlas Data Federation");
                } else {
                    dbChoice = "MongoDB (Hot Operational) + Object Storage (Cold) + Data Warehouse (Reporting)";
                    architecture = "Multi-tier: Hot Cluster + S3-Compatible Storage + Analytics Layer";
                    reasoningPoints = ["Petabyte-scale transactional workloads require a tiered architecture. MongoDB handles hot operational data, S3-compatible object storage holds cold historical data cost-effectively, and a Data Warehouse provides optimized reporting across the full dataset."]; // Reset reasoning
                }
            }
            
            // RDBMS + PETABYTE SCALE - Present Two Options
            if (dbChoice === "RDBMS" && isMassive) {
                if (answers[Q.DEPLOYMENT] !== 'onprem') {
                    dbChoice = "Option 1: RDBMS (Hot) + Data Warehouse (Cold) | Option 2: MongoDB (Hot) + Online Archive (Cold) + Warehouse (Reporting)";
                    architecture = "Multi-tier Architecture with Two Paths";
                    reasoningPoints = ["Petabyte-scale relational data requires strategic decision: **Option 1** - Stay in RDBMS ecosystem with tiering (hot operational + cold warehouse). **Option 2** - Modernize to MongoDB (cloud-based) assisted by MongoDB Modernization Programme, leveraging Online Archive for cold data and Warehouse for complex analytics. Consider migration effort, team skills, and licensing costs."]; // Reset reasoning
                    features.push("Relational Migrator (Option 2)", "App Modernization Services (Option 2)", "Online Archive (Option 2)");
                } else {
                    dbChoice = "Option 1: RDBMS (Hot) + Data Warehouse (Cold) | Option 2: MongoDB (Hot) + Object Storage (Cold) + Warehouse (Reporting)";
                    architecture = "Multi-tier Architecture with Two Paths";
                    reasoningPoints = ["Petabyte-scale relational data requires strategic decision: **Option 1** - Stay in RDBMS ecosystem with tiering (hot operational + cold warehouse). **Option 2** - Modernize to MongoDB (on-premise) assisted by MongoDB Modernization Programme, with S3-compatible storage for cold data and Warehouse for analytics. Consider migration effort, infrastructure, and team skills."]; // Reset reasoning
                    features.push("Relational Migrator (Option 2)", "App Modernization Services (Option 2)");
                }
            }
            // Regular MongoDB Architecture
            else if (dbChoice.includes("MongoDB")) {
                
                if (isMassive) {
                    architecture = "Sharded Cluster (Zone Sharding)";
                } else if (isLarge) {
                    architecture = "Sharded Cluster";
                    // Only add sharding strategy suffix if user specified it
                    if (answers[Q.DISTRIBUTION]) {
                        if (answers[Q.DISTRIBUTION] === 'distributed') architecture += " (Hashed Sharding)";
                        else if (answers[Q.DISTRIBUTION] === 'location') architecture += " (Zone Sharding)";
                        else if (answers[Q.DISTRIBUTION] === 'range') architecture += " (Ranged Sharding)";
                    }
                } else {
                    architecture = "Replica Set (3-Node)";
                }

                // Multi-Tenancy
                if (answers[Q.BUSINESS_MODEL] === 'saas') {
                    let suffix = "";
                    if (dbChoice.includes("Neo4j")) {
                         suffix = " (applied to MongoDB operational layer)";
                         reasoningPoints.push("Multi-tenancy isolation strategies (Logical/Physical) are applied to the MongoDB operational layer. Neo4j can be deployed as a shared service or per-tenant instances depending on strictness.");
                    }

                    // Default to logical if not specified (toggle off)
                    const isolation = answers[Q.MULTI_TENANCY] || 'logical';

                    // WAREHOUSE MULTI-TENANCY
                    if (dbChoice.includes("Data Warehouse")) {
                        if (isolation === 'physical') {
                            architecture += " with Dedicated Compute/Accounts (High Cost)";
                            reasoningPoints.push("Physical isolation in Data Warehouses typically requires dedicated compute clusters or separate accounts, which significantly increases cost.");
                        } else if (isolation === 'logical') {
                            architecture += " (Multi-Tenant / Logical Isolation)";
                        }
                    } 
                    // MONGODB MULTI-TENANCY
                    else {
                        if (isolation === 'logical') {
                            architecture += " (Multi-Tenant / Logical Isolation)" + suffix;
                        } else if (isolation === 'physical') {
                            architecture += " (Multi-Tenant / Dedicated Nodes)" + suffix;
                        } else if (isolation === 'silo') {
                            architecture += " with Silo Isolation" + suffix;
                        }
                    }
                }

                // Latency + Access Pattern
                const accessPattern = answers[Q.ACCESS_PATTERN];
                const latency = answers[Q.LATENCY];
                const isReadHeavy = accessPattern === 'simple'; // Simple ID lookups are typically read-heavy
                
                if (latency === 'submillisecond' && isReadHeavy) {
                    features.push("Redis / Cache Layer");
                    reasoningPoints.push("For <1ms latency with read-heavy workloads, add a caching layer like Redis for hot data.");
                } else if (isReadHeavy && dbChoice.includes("MongoDB")) {
                    features.push("Read Replicas");
                    reasoningPoints.push("For read-heavy workloads with simple lookups, use read replicas to distribute load and improve query performance.");
                }

                // Traffic Pattern (Spiky)
                if (isSpiky && dbChoice.includes("MongoDB")) {
                    const isOnPrem = answers[Q.DEPLOYMENT] === 'onprem';
                    if (isOnPrem) {
                        features.push("Automated Scaling (Ops Manager API / K8s Operator)");
                        reasoningPoints.push("For spiky traffic on-premise, use Ops Manager API or Kubernetes Operator for automated scaling, or plan capacity for peak loads.");
                    } else {
                        features.push("Cluster Auto-Scaling");
                        reasoningPoints.push("For spiky or unpredictable traffic, enable Cluster Auto-Scaling to handle bursts without over-provisioning (preferred over Serverless for production stability).");
                    }
                }
            }

            // --- APP MODERNIZATION VALUE PROPOSITION ---
            if (answers[Q.MIGRATION_STATUS] === 'yes' && answers[Q.MIGRATION_SOURCE] && dbChoice.includes("MongoDB")) {
                const dbMap = { oracle: 'Oracle', sqlserver: 'SQL Server', postgres: 'PostgreSQL', mysql: 'MySQL', db2: 'IBM Db2', other: 'RDBMS' };
                const dbName = dbMap[answers[Q.MIGRATION_SOURCE]] || 'RDBMS';
                
                reasoningPoints.push(`Migrating from ${dbName} to MongoDB (with MongoDB's App Modernization Services) eliminates ORM complexity, accelerates development with flexible schemas, and reduces licensing costs. MongoDB's Relational Migrator automates schema conversion and data migration.`);
                features.push("Relational Migrator", "App Modernization Services");
            }

            // --- DEPLOYMENT --- CRITICAL FIX: Q21 is deployment, Q22 is security!
            const securityLevel = answers[Q.SECURITY] || 'standard'; // Default to standard if toggle OFF
            if (answers[Q.DEPLOYMENT] === 'onprem') {
                deployment = securityLevel === 'strict' ? "Self-Managed / On-Premise (Strict Compliance)" : "Self-Managed / On-Premise";
            } else {
                if (dbChoice.includes("MongoDB")) {
                    deployment = securityLevel === 'strict' ? "Fully Managed Cloud (Atlas - Strict Compliance)" : "Fully Managed Cloud (Atlas)";
                } else {
                    deployment = "Fully Managed Cloud (as applicable)";
                }
            }

            // --- ADVANCED FEATURES --- CRITICAL FIX: Q18 is advanced features, not Q19!
            const advFeatures = answers[Q.ADVANCED_FEATURES] || [];
            
            // Search
            if (advFeatures.includes('search')) {
                // ANALYTICAL + SEARCH - Hybrid based on scale
                if (answers[Q.WORKLOAD] === 'analytical') {
                    if (answers[Q.TRAFFIC_PATTERN] === 'massive' || answers[Q.ANALYTICAL_NUANCE] === 'warehouse') {
                        // Large/Petabyte scale: Search Engine + Warehouse
                        if (dbChoice.includes("Data Warehouse")) {
                            dbChoice = "Elasticsearch/Solr (Search Engine) + Data Warehouse (Analytics)";
                            architecture = "Hybrid: Search-First + Columnar Analytics";
                            reasoningPoints = ["For petabyte-scale analytical search (logs, observability), Elasticsearch/Solr handles search queries while Data Warehouse provides deep analytics on the same dataset via federation or ETL."]; // Reset
                        }
                    } else {
                        // Small/Medium scale: MongoDB + Search
                        if (dbChoice.includes("MongoDB") || dbChoice.includes("Data Warehouse")) {
                            const isOnPrem = answers[Q.DEPLOYMENT] === 'onprem';
                            const searchFeature = isOnPrem ? "MongoDB Search (Lucene-based)" : "Atlas Search (Lucene-based)";
                            dbChoice = isOnPrem ? "MongoDB (Operational Analytics) + MongoDB Search" : "MongoDB (Operational Analytics) + Atlas Search";
                            architecture = "Real-Time Analytics with Search";
                            reasoningPoints = ["For moderate-scale analytical workloads with search requirements, MongoDB Analytics Nodes combined with " + (isOnPrem ? "MongoDB Search" : "Atlas Search") + " provide unified operational analytics and full-text search."]; // Reset
                            features.push(searchFeature, "Analytics Nodes");
                        }
                    }
                }
                // TRANSACTIONAL + SEARCH - CRITICAL FIX: Q19 is search scale, not Q20!
                else if (answers[Q.SEARCH_SCALE] === 'petabyte') {
                    if (dbChoice.includes("MongoDB")) {
                        dbChoice = "MongoDB (Operational) + Elasticsearch/Solr (Search Engine)";
                        reasoningPoints.push("For petabyte-scale search workloads, a dedicated search engine alongside MongoDB provides optimal performance.");
                    }
                } else if (dbChoice.includes("MongoDB")) {
                    const isOnPrem = answers[Q.DEPLOYMENT] === 'onprem';
                    features.push(isOnPrem ? "MongoDB Search (Lucene-based)" : "Atlas Search (Lucene-based)");
                }
            }

            // AI / Vector
            if (advFeatures.includes('ai')) {
                const vectorScale = answers[Q.VECTOR_SCALE]; // CRITICAL FIX: Q20 is vector scale, not Q21!
                const isOnPrem = answers[Q.DEPLOYMENT] === 'onprem';
                if (vectorScale === 'large') {
                    // >100M vectors - offer specialized solutions
                    if (dbChoice.includes("MongoDB")) {
                        dbChoice = "MongoDB + Pinecone / Weaviate (Vector DB)";
                        features.push("Pinecone / Weaviate (Primary Vector Store)", "MongoDB (Metadata & Context)");
                    } else {
                        features.push("Pinecone / Weaviate / Milvus (Vector Search)");
                    }
                } else {
                    // <100M vectors - MongoDB Vector Search is sufficient
                    if (dbChoice.includes("MongoDB")) {
                        const vectorFeature = isOnPrem ? "MongoDB Vector Search" : "Atlas Vector Search";
                        features.push(vectorFeature);
                    } else {
                        features.push("Pinecone / Weaviate");
                    }
                }
            }

            // Streams
            if (advFeatures.includes('streams')) {
                const isOnPrem = answers[Q.DEPLOYMENT] === 'onprem';
                if (dbChoice.includes("MongoDB")) {
                    if (isOnPrem) {
                        features.push("Change Streams", "Apache Flink / Kafka Streams");
                    } else {
                        features.push("Change Streams", "Atlas Stream Processing");
                    }
                } else {
                    features.push("CDC (Change Data Capture)", "Apache Kafka");
                }
            }

            // Compliance - CRITICAL FIX: Q22 is security, not Q23!
            if (securityLevel === 'strict') {
                if (dbChoice.includes("MongoDB")) {
                    features.push("Queryable Encryption", "CSFLE", "Storage/Network Encryption");
                } else if (dbChoice.includes("RDBMS") || dbChoice.includes("PostgreSQL") || dbChoice.includes("MySQL")) {
                    features.push("TDE (Transparent Data Encryption)", "Row-Level Security", "pgcrypto / Vault");
                } else if (dbChoice.includes("Neo4j")) {
                    features.push("Enterprise Security", "Role-Based Access Control", "Field-Level Security");
                } else if (dbChoice.includes("Data Warehouse")) {
                    features.push("Platform Encryption", "Dynamic Data Masking", "Governance Catalog");
                } else {
                    features.push("App-Level Field Encryption");
                }
            }

            // Mobile Offline Sync
            if (useCase === 'mobile' && answers[Q.MOBILE_OFFLINE] === 'yes') {
                const isOnPrem = answers[Q.DEPLOYMENT] === 'onprem';
                if (dbChoice.includes("MongoDB")) {
                    if (isOnPrem) {
                        features.push("Offline Sync (Ditto / PowerSync / ObjectBox)", "Self-Managed Sync Server", "Local Database");
                        reasoningPoints.push("For offline-first mobile apps with self-managed backend, leverage certified MongoDB partners (Ditto, PowerSync, ObjectBox) for seamless device-to-server sync and conflict resolution.");
                    } else {
                        features.push("Offline Sync (Ditto / PowerSync / ObjectBox)", "Atlas Device Sync", "Local Database");
                        reasoningPoints.push("For offline-first mobile apps with cloud backend, leverage certified MongoDB partners (Ditto, PowerSync, ObjectBox) or Atlas Device Sync for seamless device-to-server sync and conflict resolution.");
                    }
                }
            }

            // Join reasoning points into cohesive text
            const reasoning = reasoningPoints.join(' ');

            // PRODUCTION ENHANCEMENT: Track complete recommendation with all details
            Analytics.trackRecommendationViewed(dbChoice, architecture, deployment, features, reason, useCase);
            Logger.info('Recommendation generated', {
                db: dbChoice,
                architecture: architecture,
                deployment: deployment,
                features: features,
                reason: reason,
                useCase: useCase
            });

            // Render recommendation
            const wizardContent = document.getElementById('wizard-content');
            wizardContent.innerHTML = `
                <div class="recommendation-card">
                    <div class="rec-icon">‚ú®</div>
                    <h2 class="rec-title">Your Recommended Architecture</h2>
                    <div class="rec-subtitle">${dbChoice}</div>
                    
                    <div class="rec-details">
                        <div class="rec-section">
                            <div class="rec-section-title">Database Platform</div>
                            <div class="rec-section-value">${dbChoice}</div>
                        </div>
                        ${architecture ? `
                        <div class="rec-section">
                            <div class="rec-section-title">Architecture Pattern</div>
                            <div class="rec-section-value">${architecture}</div>
                        </div>
                        ` : ''}
                        <div class="rec-section">
                            <div class="rec-section-title">Deployment Model</div>
                            <div class="rec-section-value">${deployment}</div>
                        </div>
                        ${features.length > 0 ? `
                            <div class="rec-section">
                                <div class="rec-section-title">Recommended Features</div>
                                <div class="rec-section-value">${features.join(', ')}</div>
                            </div>
                        ` : ''}
                        ${reasoning ? `
                            <div class="rec-section">
                                <div class="rec-section-title">Why This Recommendation?</div>
                                <div class="rec-section-value" style="font-size: 1rem; font-weight: 500; line-height: 1.5;">${reasoning}</div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="rec-actions">
                        <button class="wizard-btn secondary" onclick="exportRecommendation('json')">üì• Export as JSON</button>
                        <button class="wizard-btn secondary" onclick="exportRecommendation('csv')">üìä Export as CSV</button>
                        <button class="wizard-btn secondary" onclick="restartWizard()">Start Over</button>
                        <button class="wizard-btn primary" onclick="viewExpertPath()">See Full Decision Tree ‚Üí</button>
                    </div>
                </div>
            `;
            } catch (error) {
                console.error('Error generating recommendation:', error);
                const wizardContent = document.getElementById('wizard-content');
                wizardContent.innerHTML = `
                    <div class="wizard-card">
                        <div class="wizard-icon">‚ùå</div>
                        <h2 class="wizard-title">Error Generating Recommendation</h2>
                        <div class="wizard-subtitle">Something went wrong. Please try again or refresh the page.</div>
                        <div class="wizard-nav">
                            <button class="wizard-btn secondary" onclick="restartWizard()">Start Over</button>
                        </div>
                    </div>
                `;
            }
        }

        /**
         * Restart the wizard from the beginning
         * Clears all answers and saved state
         */
        function restartWizard() {
            clearWizardState(); // Clear localStorage
            wizardData.answers = {};
            wizardData.currentStep = 0;
            renderWizardStep();
        }

        /**
         * PRODUCTION ENHANCEMENT: Export recommendation in various formats
         * @param {string} format - Export format ('json' or 'csv')
         */
        function exportRecommendation(format) {
            try {
                const answers = wizardData.answers;
                const primaryDB = determinePrimaryDB(answers);
                
                // Build recommendation object for export
                const recommendation = {
                    db: primaryDB.db,
                    architecture: 'See full recommendation on screen',
                    deployment: answers[Q.DEPLOYMENT] || 'cloud',
                    features: [],
                    reasoning: primaryDB.reason
                };
                
                if (format === 'json') {
                    // Build complete recommendation data with questions
                    const recommendationData = RecommendationExport.generateJSON(
                        recommendation.db,
                        recommendation.architecture,
                        recommendation.deployment,
                        recommendation.features,
                        recommendation.reasoning,
                        answers
                    );
                    
                    RecommendationExport.downloadJSON(
                        recommendationData,
                        `mongodb-architecture-${Date.now()}.json`
                    );
                    
                    Logger.info('Recommendation exported as JSON');
                } else if (format === 'csv') {
                    // Generate CSV with recommendation verdict at top
                    const csv = RecommendationExport.generateCSV(answers, recommendation);
                    RecommendationExport.downloadCSV(
                        csv,
                        `mongodb-questionnaire-${Date.now()}.csv`
                    );
                    
                    Logger.info('Recommendation exported as CSV');
                }
            } catch (error) {
                Logger.error('Export failed', {format, error: error.message});
                alert('Export failed. Please try again or check the console for details.');
            }
        }

        /**
         * View the expert path (flowchart diagram)
         * Switches to expert mode and sets up pan-zoom
         */
        function viewExpertPath() {
            switchMode('expert');
            document.getElementById('back-to-guided').classList.add('visible');
        }

        document.getElementById('back-to-guided').addEventListener('click', () => {
            switchMode('guided');
        });

        // Suppress harmless runtime errors from third-party libraries
        window.addEventListener('error', (event) => {
            if (event.message && event.message.includes('Could not establish connection')) {
                event.preventDefault();
                return true;
            }
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Verify GTM dataLayer is initialized
            if (window.dataLayer) {
                console.log('‚úÖ [GTM] dataLayer is initialized and ready');
                // Send initial page_view event via GTM
                window.dataLayer.push({
                    event: 'page_view',
                    page_title: 'MongoDB Architecture Decision Matrix',
                    page_path: window.location.pathname
                });
            } else {
                console.warn('‚ö†Ô∏è [GTM] dataLayer not found - GTM may not be tracking');
            }
            
            // PRODUCTION ENHANCEMENT: Track session start
            Analytics.trackSessionStart();
            
            const savedState = loadWizardState();
            
            if (savedState && Object.keys(savedState.answers).length > 0) {
                showResumePrompt(savedState);
            } else {
                renderWizardStep();
            }
        });

        // --- CONTENT DATABASE ---
        const nodeData = {
            "ObjMatch": {
                title: "Developer Experience",
                value: "Code-Native Data Access",
                detail: "Work with data as natural JSON objects. Eliminates the 'Object-Relational Impedance Mismatch' and removes the need for complex, brittle ORM layers like Hibernate or Prisma.",
                link: "https://www.mongodb.com/docs/drivers/odm/"
            },
            "AgileVal": {
                title: "Business Agility",
                value: "Faster Time-to-Market",
                detail: "Polymorphic schema allows you to launch new features without database downtime or running risky 'ALTER TABLE' migration scripts. The database adapts to your code, not vice versa.",
                link: "https://www.mongodb.com/docs/manual/data-modeling/design-patterns/data-versioning/schema-versioning/"
            },
            "Consolidation": {
                title: "Tech Stack Consolidation",
                value: "Lower TCO & Complexity",
                detail: "By combining Transactional, Search, AI, and Time Series workloads into one API, you remove the cost and maintenance burden of syncing 3-4 separate niche databases.",
                link: "https://www.mongodb.com/products/platform"
            },
            "Logical": {
                title: "Logical Sharding",
                value: "Simple Multi-Tenancy",
                detail: "Isolates tenants using a 'tenant_id' field within standard collections. Ideal for high-volume SaaS where tenants share resources but need logical separation.",
                link: "https://www.mongodb.com/docs/manual/core/moveable-collections/multi-tenant/"
            },
            "TenantShard": {
                title: "Tenant-Aware Sharding",
                value: "Physical Isolation",
                detail: "Pin specific tenants to specific hardware. Allows you to offer 'Premium Tier' performance on dedicated NVMe nodes while keeping 'Free Tier' users on shared hardware‚Äîall in one cluster.",
                link: "https://www.mongodb.com/docs/manual/sharding//"
            },
            "MongoCore": {
                title: "MongoDB Core",
                value: "The Intelligent Document Database",
                detail: "The foundation. Stores data in BSON (Binary JSON), supporting rich indexing, ACID transactions, and aggregations. It scales horizontally by default.",
                link: "https://www.mongodb.com/docs/manual/core/document/"
            },
            "Migrator": {
                title: "Relational Migrator",
                value: "Automated Modernization",
                detail: "Analyzes legacy SQL schemas and automatically generates optimized MongoDB document models and code. De-risks the migration process.",
                link: "https://www.mongodb.com/products/relational-migrator"
            },
            "AMP": {
                title: "MongoDB AMP",
                value: "Application Modernization Platform",
                detail: "An integrated platform extending Relational Migrator to help modernize legacy applications. Includes schema transformation, code migration, and testing capabilities to accelerate the journey from monolithic SQL systems to modern MongoDB architectures.",
                link: "https://www.mongodb.com/resources/basics/application-modernization"
            },
            "HashShard": {
                title: "Hashed Sharding",
                value: "Perfect Write Distribution",
                detail: "Distributes data based on a hash of the shard key. Ensures writes are spread evenly across all nodes, preventing 'hotspots' during massive ingest events.",
                link: "https://www.mongodb.com/docs/manual/core/hashed-sharding/"
            },
            "ZoneShard": {
                title: "Zone Sharding",
                value: "Data Locality / Sovereignty",
                detail: "Allows you to tag shards by geography (e.g., 'EU-West'). Data for German users stays physically on German servers to comply with GDPR, while US data stays in Virginia.",
                link: "https://www.mongodb.com/docs/manual/core/zone-sharding/"
            },
            "RangeShard": {
                title: "Ranged Sharding",
                value: "Optimized Range Queries",
                detail: "Divides data into continuous ranges (e.g., Time or Alphabetical). Ideal for efficient queries that scan a specific window of time or sequence.",
                link: "https://www.mongodb.com/docs/manual/core/ranged-sharding/"
            },
            "Replica": {
                title: "Replica Set",
                value: "High Availability (HA)",
                detail: "A group of at least 3 nodes that maintain the same data set. Provides automatic failover and data redundancy. If the primary crashes, a secondary takes over in seconds.",
                link: "https://www.mongodb.com/docs/manual/replication/"
            },
            "ASP": {
                title: "Atlas Stream Processing",
                value: "Analyze Data In-Flight",
                detail: "Process high-velocity streams (Kafka/EventHub) continuously before storing them. Use standard MongoDB aggregation syntax to build real-time alerts and views.",
                link: "https://www.mongodb.com/products/platform/atlas-stream-processing"
            },
            "AtlasSearch": {
                title: "Atlas Search",
                value: "Lucene-Powered Search",
                detail: "Full-text search integrated into the database. Features fuzzy matching, autocomplete, and highlighting without managing a separate Elasticsearch cluster.",
                link: "https://www.mongodb.com/docs/atlas/atlas-search/"
            },
            "Vector": {
                title: "Vector Search",
                value: "Unified Memory for AI",
                detail: "Store and query vector embeddings alongside operational data. Enables semantic search and RAG workflows without an external vector DB.",
                link: "https://www.mongodb.com/products/platform/atlas-vector-search"
            },
            "AgentMem": {
                title: "Agent Memory",
                value: "Long-Term Context",
                detail: "Use MongoDB to store conversation history and context for AI Agents. Vector search retrieves relevant past interactions to make the AI smarter over time.",
                link: "https://www.mongodb.com/developer/products/atlas/building-generative-ai-applications-vector-search/"
            },
            "SemCache": {
                title: "Semantic Cache",
                value: "Reduce LLM Costs",
                detail: "Cache LLM responses based on semantic similarity. If a user asks a question similar to a previous one, serve the cached answer instantly instead of paying for a new GPU call.",
                link: "https://www.mongodb.com/docs/atlas/atlas-vector-search/vector-search-overview/"
            },
            "RAG": {
                title: "RAG (Retrieval Augmented Generation)",
                value: "Ground AI in Truth",
                detail: "Retrieve accurate, private enterprise data from MongoDB and feed it to the LLM to prevent hallucinations and provide domain-specific answers.",
                link: "https://www.mongodb.com/docs/atlas/atlas-vector-search/tutorials/local-rag/"
            },
            "TimeSeries": {
                title: "Time Series Collections",
                value: "IoT Efficiency",
                detail: "Columnar storage optimized for time-series data. significantly reduces storage costs and improves query speed for sensor data and metrics.",
                link: "https://www.mongodb.com/docs/manual/core/timeseries-collections/"
            },
            "Connectors": {
                title: "Ecosystem Connectors",
                value: "Enterprise Integration",
                detail: "Official connectors for Kafka, Spark, Flink, and Databricks. Ensures reliable, high-throughput data pipelines without custom glue code.",
                link: "https://www.mongodb.com/products/integrations/connectors"
            },
            "K8s": {
                title: "Enterprise Operator",
                value: "Kubernetes Native",
                detail: "Deploy and manage MongoDB clusters inside your own Kubernetes environment (OpenShift/EKS/AKS). Automates upgrades, scaling, and backups.",
                link: "https://www.mongodb.com/docs/kubernetes/current/"
            },
            "OpsMan": {
                title: "Ops Manager",
                value: "On-Prem Automation",
                detail: "The management plane for self-managed deployments. Provides a GUI for deploying, monitoring, and backing up clusters on VMs or Bare Metal.",
                link: "https://www.mongodb.com/docs/ops-manager/current/"
            },
            "PrivLink": {
                title: "PrivateLink",
                value: "Secure Unidirectional Access",
                detail: "The gold standard for cloud security. Allows your VPC to connect to MongoDB Atlas privately without traversing the public internet or exposing ports.",
                link: "https://www.mongodb.com/docs/atlas/security-private-endpoint/"
            },
            "Peering": {
                title: "VPC Peering",
                value: "Bi-Directional Networking",
                detail: "Connects your VPC network directly to the Atlas VPC network. Useful for legacy setups, though PrivateLink is generally preferred for tighter security.",
                link: "https://www.mongodb.com/docs/atlas/security-vpc-peering/"
            },
            "IPList": {
                title: "IP Access List",
                value: "Basic Firewalling",
                detail: "Allow access only from specific IP addresses or CIDR blocks. Simple to set up for development or smaller deployments.",
                link: "https://www.mongodb.com/docs/atlas/security/ip-access-list/"
            },
            "MultiCloud": {
                title: "Multi-Cloud Cluster",
                value: "Ultimate Resilience",
                detail: "Span your cluster across AWS, Azure, and Google Cloud simultaneously. Protects against entire cloud provider outages.",
                link: "https://www.mongodb.com/docs/atlas/create-database-deployment/#global-clusters"
            },
            "Standard": {
                title: "Standard Cluster",
                value: "Reliable & Cost-Effective",
                detail: "A standard 3-node replica set deployed in a single region. Provides 99.99% uptime and automatic failover for most production workloads.",
                link: "https://www.mongodb.com/pricing"
            },
            "Archive": {
                title: "Online Archive",
                value: "Cost-Efficient History",
                detail: "Automatically moves old data to cheap S3 object storage while keeping it queryable. Reduces the cost of storing petabytes of historical logs.",
                link: "https://www.mongodb.com/docs/atlas/online-archive/overview/"
            },
            "PerfAdv": {
                title: "Performance Advisor",
                value: "24/7 Intelligent Ops",
                detail: "A built-in tool that analyzes your slow queries and automatically suggests indexes to fix them. It acts as an automated DBA.",
                link: "https://www.mongodb.com/docs/atlas/performance-advisor/"
            },
            "CSFLE": {
                title: "Security and Compliance at everylevel",
                value: "Encryption-in-Use",
                detail: "State-of-the-art security,compliance(GDPR etc), and encryption, with the ability to query encrypted data.",
                link: "https://trust.mongodb.com/"
            }
        };

        // --- INTERACTIVITY LOGIC ---
        var panZoomInstance;

        // 1. Initialize Mermaid with strict security
        mermaid.initialize({ startOnLoad: true, securityLevel: 'strict' });

        /**
         * Show information drawer for a flowchart node
         * @param {string} nodeId - ID of the node to display info for
         */
        window.showInfo = function(nodeId) {
            // Prevent event bubbling so clicking a node doesn't immediately close the drawer via body click
            event.stopPropagation();

            const data = nodeData[nodeId];
            if (data) {
                document.getElementById('drawer-title').innerText = data.title;
                document.getElementById('drawer-value').innerText = data.value;
                document.getElementById('drawer-details').innerText = data.detail;
                
                const linkBtn = document.getElementById('drawer-link');
                if (data.link) {
                    linkBtn.href = data.link;
                    linkBtn.classList.remove('no-link');
                    linkBtn.innerHTML = "<span>Read Documentation ‚Üí</span>";
                    linkBtn.style.pointerEvents = "auto";
                } else {
                    linkBtn.classList.add('no-link');
                    linkBtn.innerHTML = "<span>No Link Available</span>";
                    linkBtn.style.pointerEvents = "none";
                }
                
                // Open Drawer
                document.getElementById('side-drawer').classList.add('open');
            }
        };

        /**
         * Close the information drawer
         */
        window.closeDrawer = function() {
            document.getElementById('side-drawer').classList.remove('open');
        };



    </script>
</body>
</html>